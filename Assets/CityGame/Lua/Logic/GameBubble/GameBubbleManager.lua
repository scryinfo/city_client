---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/9/1 14:20
---
require "Logic/GameBubble/GameBubbleElm"

GameBubbleManager = {};
local this = GameBubbleManager;
local elmArray = {}

--
function GameBubbleManager.New()
    UpdateBeat:Add(this.Update, this);
end

function GameBubbleManager.Update()
    if not this.startCheck then
        return
    end

    if #elmArray <= 0 then
        return
    end

    if UnityEngine.Input.GetMouseButtonDown(0) then
        --logWarn("------- bubble mgr ---- ");

        local ray = UnityEngine.Camera.main:ScreenPointToRay(UnityEngine.Input.mousePosition)
        local flag, hit = UnityEngine.Physics.Raycast(ray, UnityEngine.RaycastHit.out, 100, LayerMask.GetMask("BubbleLayer"))

        if flag then
            for i, v in pairs(elmArray) do
                if hit.transform.gameObject:GetInstanceID() == v.data.elmObj:GetInstanceID() then
                    if v.data.func then
                        v.data.func(v.data)
                    end
                end
            end
        end
    end

end

--创建所有未结束的气泡
function GameBubbleManager.CreatBubble(bubbleData)
    this.startCheck = true

    if not this.prefab then
        this.prefab = UnityEngine.Resources.Load("Prefab/GroundAuctionObj")
    end

    local go = UnityEngine.GameObject.Instantiate(this.prefab)
    go.transform.localScale = Vector3.one;
    go.transform.position = Vector3.New(bubbleData.area.x, bubbleData.area.y, 10)

    local data = bubbleData
    data.elmObj = go  --将obj引用到lua中
    local elmLua = GameBubbleElm.New()
    elmLua:InitElm(data)

    this.index = this.index or 0
    this.index = this.index + 1
    elmArray[this.index] = elmLua
end

--刷新开始拍卖的气泡
function GameBubbleManager.StartAuc(aucDatas)
    for i, aucInfo in ipairs(aucDatas.auction) do
        for j, elmValue in ipairs(elmArray) do
            --如果开始拍卖的id == 存下来的id
            if elmValue.data.id == aucInfo.id and elmValue.data.bubbleType == BubblleType.GroundAuction then
                elmValue.data.biderId = aucInfo.biderId
                elmValue.data.price = aucInfo.price
                elmValue:StartBid()
            end

        end
    end
end

--当拍卖信息更新时，对应的elm信息也要更新
function GameBubbleManager.UpdateBidInfo(updateInfo)
    for i, elm in ipairs(elmArray) do
        if elm.data.id == updateInfo.id then
            elm.data.price = updateInfo.num
        end
    end
end

--隐藏所有气泡
function GameBubbleManager.HideAllBubble()
    for i, elm in pairs(elmArray) do
        elm.data.elmObj.transform.localScale = Vector3.zero
    end
end

--根据ID销毁对应气泡物体
function GameBubbleManager.DestoryBubbleItem(bubbleID)
    for i, v in ipairs(elmArray) do
        if v.data.id == bubbleID then
            UnityEngine.GameObject.Destroy(elmArray[i].elmObj)
            elmArray[i] = nil
        end
    end
end



