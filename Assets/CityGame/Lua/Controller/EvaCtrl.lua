---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2019/5/24 11:32
---

EvaCtrl = class("EvaCtrl", UIPanel)
UIPanel:ResgisterOpen(EvaCtrl)

EvaCtrl.static.PropertyTrueItemPath = "View/Eva/PropertyTrueItem"  -- Upgradeable attribute prefabricated path
EvaCtrl.static.PropertyFalseItemPath = "View/Eva/PropertyFalseItem"  -- Non-upgradable attribute prefabricated path
EvaCtrl.static.brandIcon = -- icon display configuration
{
    [13] = "Assets/CityGame/Resources/Atlas/Company/SuperMarket_3x3.png",
    [14] = "Assets/CityGame/Resources/Atlas/Company/HomeHouse_3X3.png",
    [1613] = "Assets/CityGame/Resources/Atlas/Company/SuperMarket_3x3.png",
    [1614] = "Assets/CityGame/Resources/Atlas/Company/HomeHouse_3X3.png",
    [1651] = "Assets/CityGame/Resources/Atlas/Eva/icon-food.png",
    [1652] = "Assets/CityGame/Resources/Atlas/Eva/icon-clothes.png",
    [155] = "Assets/CityGame/Resources/Atlas/Eva/icon-Inventingnewgoods.png",
    [156] = "Assets/CityGame/Resources/Atlas/Eva/icon-eva.png",
}

function EvaCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function EvaCtrl:bundleName()
    return "Assets/CityGame/Resources/View/EvaPanel.prefab"
end

function EvaCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function EvaCtrl:Awake()
    local luaBehaviour = self.gameObject:GetComponent("LuaBehaviour")

    luaBehaviour:AddClick(EvaPanel.backBtn, self.OnBack, self)
    luaBehaviour:AddClick(EvaPanel.addBtn, self.OnAdd, self)
    luaBehaviour:AddClick(EvaPanel.closeIntroductionBtn.gameObject, self.OnCloseTips, self)
    luaBehaviour:AddClick(EvaPanel.technologyBtn.gameObject, self.OnTechnology, self)
    luaBehaviour:AddClick(EvaPanel.marketBtn.gameObject, self.OnMarket, self)

    -- Eva node 2
    self.evaOptionTwoSource = UnityEngine.UI.LoopScrollDataSource.New()
    self.evaOptionTwoSource.mProvideData = EvaCtrl.static.evaOptionTwoData
    self.evaOptionTwoSource.mClearData = EvaCtrl.static.evaOptionTwoClearData

    -- Eva node3
    self.evaOptionThereSource = UnityEngine.UI.LoopScrollDataSource.New()
    self.evaOptionThereSource.mProvideData = EvaCtrl.static.evaOptionThereData
    self.evaOptionThereSource.mClearData = EvaCtrl.static.evaOptionThereClearData

    -- Attribute node
    self.propertySource = UnityEngine.UI.LoopScrollDataSource.New()
    self.propertySource.mProvideData = EvaCtrl.static.propertyData
    self.propertySource.mClearData = EvaCtrl.static.propertyClearData

    -- Save the instance
    EvaCtrl.static.evaCtrl = self
    self.resultTab = {EvaPanel.ResultRootO, EvaPanel.ResultRootTwo, EvaPanel.ResultRootThere}
end

function EvaCtrl:Active()
    UIPanel.Active(self)
    self:_addListener()

    -- Multilingual adaptation
    EvaPanel.titleText.text = GetLanguage(31010043)
    EvaPanel.addBtnText.text = GetLanguage(31010013)
    EvaPanel.technologyTitleText.text = GetLanguage(31010062)
    EvaPanel.marketTitleText.text = GetLanguage(31010063)
end

function EvaCtrl:Refresh()
    self:initInsData()
    self:updateData()
end

function EvaCtrl:Hide()
    self:_removeListener()
    -- Eva chooses the number of records
    self.evaRecordData = nil
    -- Total eva data on the eva interface
    self.allEvaData = nil
    -- Structural data on the eva interface
    self.allUIData = nil
    -- Current point data
    self.buildingPoint = nil
    -- Added point data for displaying on the interface
    self.addData = nil
    -- Dotted eva data, used to send dotted message structure to the server
    self.addEvaData = nil
    -- Dotted eva level and current experience data, used for display on the interface
    self.addEvaLvData = nil
    UIPanel.Hide(self)
end

function EvaCtrl:Close()
    EvaCtrl.static.evaCtrl = nil
    UIPanel.Close(self)
end

-- Initialize basic data
function EvaCtrl:updateData()
    -- Eva chooses the number of records
    self.evaRecordData = {}
    -- Total eva data on the eva interface
    self.allEvaData = {}
    --Structural data on the eva interface
    self.allUIData = {}
    -- Current point data
    self.buildingPoint = {}
    -- eva界面上总的加点的点数值
    --self.allEvaAddPoint = {}
    -- Added point data for displaying on the interface
    self.addData = {}
    -- Dotted eva data, used to send dotted message structure to the server
    self.addEvaData = {}
    -- Dotted eva level and current experience data, used for display on the interface
    self.addEvaLvData = {}
    -- Refresh the dotted button display
    self:SetAddBtnState(false)
    -- Refresh prompt small window display
    self:_showIntroduction( false )

    -- Generate title item
    if self.evaTitleItem then
        DataManager.DetailModelRpcNoRet(OpenModelInsID.EvaCtrl, 'm_QueryMyEva', 11)
    else
        -- Generate headlines
        self.evaTitleItem = {}
        for i, v in ipairs(EvaConfig) do
            local go = ct.InstantiatePrefab(EvaPanel.evaTitleItem)
            local rect = go.transform:GetComponent("RectTransform")
            go.transform:SetParent(EvaPanel.optionOneScroll)
            rect.transform.localScale = Vector3.one
            rect.transform.localPosition = Vector3.zero
            go:SetActive(true)

            self.evaTitleItem[i] = EvaTitleItemOne:new(go, 1, i)
            if i == #EvaConfig then
                DataManager.DetailModelRpcNoRet(OpenModelInsID.EvaCtrl, 'm_QueryMyEva', 11)
            end
        end
    end
end

-- Whether eva tips are displayed
function EvaCtrl:_showIntroduction(isShow)
    EvaPanel.introductionImage.localScale = isShow and Vector3.one or Vector3.zero
    EvaPanel.closeIntroductionBtn.localScale = isShow and Vector3.one or Vector3.zero
end

-- Display the technology points and market points of the building
function EvaCtrl:_showTechnologyAndMarketPoint(index)
    local point = self.buildingPoint[index]
    EvaPanel.technologyText.text = tostring(point.sciencePoint.pointNum)
    if point.promotionPoint then
        EvaPanel.lineImageTF.localScale = Vector3.one
        EvaPanel.marketTitleTextTF.localScale = Vector3.one
        EvaPanel.marketText.text = tostring(point.promotionPoint.pointNum)
    else
        EvaPanel.lineImageTF.localScale = Vector3.zero
        EvaPanel.marketTitleTextTF.localScale = Vector3.zero
    end
end

-- Clear Eva data and interface display
function EvaCtrl:_clearEvaDataAndView()
    -- data
    self.addData = {}
    self.addEvaData = {}
    self.addEvaLvData = {}
    --self.allEvaAddPoint = {}

    -- How many plus points are displayed on the interface
    for _, v in ipairs(self.evaTitleItem) do
        v:_setAddNumber()
        v:_setMarketAddNumber()
    end
    for _, k in pairs(EvaCtrl.optionTwoScript) do
        k:_setAddNumber()
        k:_setMarketAddNumber()
    end
    for _, j in pairs(EvaCtrl.optionThereScript) do
        j:_setAddNumber()
        j:_setMarketAddNumber()
    end

    -- Turn off Dotted, and clear the interface data of Dotted
    for _, i in pairs(EvaCtrl.propertyScript) do
        i:_setAddExNumInputField("0")
    end
end
-------------------------------------------------------------- Button click event --------------------------------------------------------
-- Close Eva interface
function EvaCtrl:OnBack(go)
    PlayMusEff(1002)
    -- Determine if there is any additional data, if there is, then prompt, if not, exit
    if go.addEvaData then
        local isHaveEvaAddData
        for _, v in pairs(go.addEvaData) do
            isHaveEvaAddData = true
            break
        end
        if isHaveEvaAddData then
            local data={ReminderType = ReminderType.Common,ReminderSelectType = ReminderSelectType.Select,
                        content = GetLanguage(31010023),func = function()
                    -- Clean eva data
                    go:_clearEvaDataAndView()
                    UIPanel.ClosePage()
                end  }
            ct.OpenCtrl('NewReminderCtrl',data)
        else
            UIPanel.ClosePage()
        end
    else
        UIPanel.ClosePage()
    end
end

-- Add point, initiate a point message to the server
function EvaCtrl:OnAdd(go)
    PlayMusEff(1002)
    local evas = {}
    for _, v in pairs(go.addEvaData) do
        table.insert(evas, v)
    end
    if not  next(evas) then
        Event.Brocast("SmallPop",GetLanguage(31010050),70)
        return
    end
    DataManager.DetailModelRpcNoRet(OpenModelInsID.EvaCtrl, 'm_UpdateMyEvas', {evaSummarys = evas})
    go:_clearEvaDataAndView()
end

--Show eva introduction
function EvaCtrl:OnTechnology(go)
    PlayMusEff(1002)
    go:_showIntroduction( true )
    EvaPanel.introductionImage:SetParent(EvaPanel.technologyBtn)
    EvaPanel.introductionImage.localPosition = Vector3.New(0, -20, 0)
    EvaPanel.introductionText.text = "科技点数提示！"
end

--Show eva introduction
function EvaCtrl:OnMarket(go)
    PlayMusEff(1002)
    go:_showIntroduction( true )
    EvaPanel.introductionImage:SetParent(EvaPanel.marketBtn)
    EvaPanel.introductionImage.localPosition = Vector3.New(0, -20, 0)
    EvaPanel.introductionText.text = "市场点数提示！"
end

--Turn off eva tips
function EvaCtrl:OnCloseTips(go)
    PlayMusEff(1002)
    -- Turn off eva tips
    go:_showIntroduction( false )
end
-------------------------------------------------------------- Network news --------------------------------------------------------
-- Open model
function EvaCtrl:initInsData()
    DataManager.OpenDetailModel(EvaModel, OpenModelInsID.EvaCtrl)
end

-- Listen to the model layer network callback
function EvaCtrl:_addListener()
    Event.AddListener("c_OnQueryMyEva", self.c_OnQueryMyEva, self)
    Event.AddListener("c_OnUpdateMyEvas", self.c_OnUpdateMyEvas, self)
end

-- Cancel the model layer network callback
function EvaCtrl:_removeListener()
    Event.RemoveListener("c_OnQueryMyEva", self.c_OnQueryMyEva, self)
    Event.RemoveListener("c_OnUpdateMyEvas", self.c_OnUpdateMyEvas, self)
end

-- The server queries Eva, saves the Eva information, and displays the first item by default
function EvaCtrl:c_OnQueryMyEva(buildingEva)
    -- Id of current point
    local buildingIndex = buildingEva.buildingType - 10

    -- Current points
    self.buildingPoint[buildingIndex] = buildingEva.buildingPoint

    -- eva data
    self.allEvaData[buildingIndex] = {}
    for _, v in ipairs(buildingEva.eva) do
        if self.allEvaData[buildingIndex][v.at] == nil then
            self.allEvaData[buildingIndex][v.at] = {}
        end
        self.allEvaData[buildingIndex][v.at][v.bt] = v
    end

    -- The actual data to be displayed
    self.allUIData[buildingIndex] = ct.deepCopy(EvaConfig[buildingIndex])
    if buildingIndex == 1 then
        for i = #self.allUIData[buildingIndex].option, 1, -1 do
            if self.allEvaData[buildingIndex][self.allUIData[buildingIndex].option[i].property[1].Atype] == nil then
                table.remove(self.allUIData[buildingIndex].option, i)
            end
        end
    elseif buildingIndex == 2 then
        for _, v in ipairs(self.allUIData[buildingIndex].option) do
            for i = #v.option, 1, -1 do
                if self.allEvaData[buildingIndex][v.option[i].property[1].Atype] == nil then
                    table.remove(v.option, i)
                end
            end
        end
    end

    -- The first option is opened by default
    self.evaTitleItem[buildingIndex]:_onClickBtn()
end

-- Dot the Eva returned by the server
function EvaCtrl:c_OnUpdateMyEvas(buildingEvas)
    Event.Brocast("SmallPop", GetLanguage(31010041),80)

    -- Refresh eva's data
    for i, v in ipairs(buildingEvas.buildingEvas) do
        -- Id of current point
        local buildingIndex = v.buildingType - 10

        -- Current points
        self.buildingPoint[buildingIndex] = v.buildingPoint

        for a, b in ipairs(v.eva) do
            self.allEvaData[buildingIndex][b.at][b.bt] = b
        end
    end

    -- Refresh the dotted data
    for _, n in pairs(EvaCtrl.propertyScript) do
        n.data = self.allEvaData[self.evaRecordData[1]][n.data.at][n.data.bt]
    end

    self:_showTechnologyAndMarketPoint(self.evaRecordData[1])
    self:SetAddBtnState(false)
end

-------------------------------------------------------------- Sliding multiplexing --------------------------------------------------------
-- Eva option 2 information display
EvaCtrl.static.evaOptionTwoData = function(transform, idx)
    idx = idx + 1
    EvaCtrl.optionTwoScript[idx] = EvaTitleItemTwo:new(transform, 2, idx)
end

EvaCtrl.static.evaOptionTwoClearData = function(transform)
end

-- Eva option 3 information display
EvaCtrl.static.evaOptionThereData = function(transform, idx)
    idx = idx + 1
    EvaCtrl.optionThereScript[idx] = EvaTitleItemThere:new(transform, 3, idx)
end

EvaCtrl.static.evaOptionThereClearData = function(transform)
end

-- Property information display
EvaCtrl.static.propertyData = function(transform, idx)
    idx = idx + 1
    EvaCtrl.propertyScript[idx] = PropertyTrueItem:new(transform, EvaCtrl.propertyAllData[1][idx], EvaCtrl.propertyAllData[2][idx])
end

EvaCtrl.static.propertyClearData = function(transform)
end

-- Refresh Eva sliding option 2 information
function EvaCtrl:ShowOptionTwo(itemNumber)
    EvaCtrl.optionTwoScript = {}
    EvaPanel.optionTwoScroll:ActiveLoopScroll(self.evaOptionTwoSource, itemNumber, "View/Eva/EvaBtnTwoItem")
    --EvaPanel.optionTwoScroll:RefillCells()
end

-- Refresh Eva sliding option 3 information
function EvaCtrl:ShowOptionThere(itemNumber)
    EvaCtrl.optionThereScript = {}
    EvaPanel.optionThereScroll:ActiveLoopScroll(self.evaOptionThereSource, itemNumber, "View/Eva/EvaBtnThereItem")
    --EvaPanel.optionThereScroll:RefillCells()
end

-------------------------------------------------------------- Interface display --------------------------------------------------------
-- Generate Eva attribute item
function EvaCtrl:CreatePropertyItem(propertyTab)
    if not propertyTab then
        return
    end
    EvaCtrl.propertyAllData = {{}, {}}

    -- Get display data
    for _, b in ipairs(propertyTab) do
        table.insert(EvaCtrl.propertyAllData[1], self.allEvaData[self.evaRecordData[1]][b.Atype][b.Btype]) -- Save actual data
        table.insert(EvaCtrl.propertyAllData[2], b) -- Save local configuration
    end

    -- Refresh the data display on the interface
    EvaPanel.iconImageTF.localScale = Vector3.New(0, 0, 0)
    local imgPath
    if self.evaRecordData[1] == 1 then
        imgPath = Material[propertyTab[1].Atype].img
        EvaPanel.iconTF.localScale = Vector3.New(0.5, 0.5, 1)
    elseif self.evaRecordData[1] == 2 then
        imgPath = Good[propertyTab[1].Atype].img
        EvaPanel.iconTF.localScale = Vector3.New(0.5, 0.5, 1)
    elseif self.evaRecordData[1] == 5 then
        imgPath = ResearchConfig[propertyTab[1].Atype].iconPath
        EvaPanel.iconTF.localScale = Vector3.New(0.6, 0.6, 1)
    elseif self.evaRecordData[1] == 6 then
        imgPath = ResearchConfig[propertyTab[1].Atype].buildingPath
        EvaPanel.iconTF.localScale = Vector3.New(0.6, 0.6, 1)
    else
        imgPath = EvaCtrl.static.brandIcon[propertyTab[1].Atype]
        EvaPanel.iconTF.localScale = Vector3.New(1, 1, 1)
    end
    LoadSprite(imgPath, EvaPanel.iconImage, true)

    local isShowFrist,isShowSecond = false, false
    for m, n in ipairs(EvaCtrl.propertyAllData[2]) do
        local strId = string.format("%d%s", EvaCtrl.propertyAllData[2][m].Atype, EvaCtrl.propertyAllData[2][m].Btype)
        local myLv = EvaCtrl.propertyAllData[1][m].lv
        if EvaCtrl.static.evaCtrl.addEvaLvData[strId] then
            myLv = EvaCtrl.static.evaCtrl.addEvaLvData[strId].myLv
        end
        if n.Btype == "ProduceSpeed"  or n.Btype == "PromotionAbility" or n.Btype == "InventionUpgrade" or n.Btype == "EvaUpgrade" then
            self.resultTab[1]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
            self.resultTab[1]:_showData(myLv)
            isShowFrist = true
        elseif n.Btype == "Quality" then
            self.resultTab[2]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
            self.resultTab[2]:_showData(myLv)
            isShowSecond = true
        elseif n.Btype == "Brand" then
            self.resultTab[3]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
            self.resultTab[3]:_showData(myLv)
        end
    end

    if isShowFrist then
        if isShowSecond then  -- All
            self.resultTab[1]:_isShow(true)
            self.resultTab[2]:_isShow(true)
            self.resultTab[2]:SetPosition(Vector3.New(212, 0, 0))
            self.resultTab[3]:_isShow(true)
            self.resultTab[3]:SetPosition(Vector3.New(602, 0, 0))
        else -- Only the first item
            self.resultTab[1]:_isShow(true)
            self.resultTab[2]:_isShow(false)
            self.resultTab[3]:_isShow(false)
        end
    else -- No first item
        self.resultTab[1]:_isShow(false)
        self.resultTab[2]:_isShow(true)
        self.resultTab[2]:SetPosition(Vector3.New(-402, 0, 0))
        self.resultTab[3]:_isShow(true)
        self.resultTab[3]:SetPosition(Vector3.New(-12, 0, 0))
    end

    -- Generate new attribute display
    EvaCtrl.propertyScript = {}
    EvaPanel.propertyScroll:ActiveLoopScroll(self.propertySource, #EvaCtrl.propertyAllData[2], EvaCtrl.static.PropertyTrueItemPath)
end

-- Set Eva selection record
function EvaCtrl:SetEvaRecord(index, data)
    if index == 1 then
        self.evaRecordData = {data}
    elseif index == 2 then
        self.evaRecordData[index] = data
        self.evaRecordData[3] = nil
    elseif index == 3 then
        self.evaRecordData[index] = data
    end

end

-- Get the record of Eva option item
function EvaCtrl:GetEvaRecordData()
    return self.evaRecordData
end

-- Reset button state
function EvaCtrl:SetBtnState(index)
    if index == 1 then
        for _, v in ipairs(self.evaTitleItem) do
            v:SetSelect(true)
            --v:SetNameTextColor(1)
        end
    elseif index == 2 then
        for _, v in ipairs(EvaCtrl.optionTwoScript) do
            v:SetSelect(true)
        end
    elseif index == 3 then
        for _, v in ipairs(EvaCtrl.optionThereScript) do
            v:SetSelect(true)
        end
    end
end

-- Dot button control
function EvaCtrl:SetAddBtnState(isInteractable)
    EvaPanel.addButton.interactable = isInteractable
end