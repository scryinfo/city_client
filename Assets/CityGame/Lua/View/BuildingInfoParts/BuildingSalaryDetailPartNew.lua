---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2019/2/27 18:13
---Wage adjustment on main building interface
BuildingSalaryDetailPartNew = class('BuildingSalaryDetailPartNew', BasePartDetail)
--
function BuildingSalaryDetailPartNew:PrefabName()
    return "BuildingSalaryDetailPart"
end
--
function  BuildingSalaryDetailPartNew:_InitEvent()
    DataManager.ModelRegisterNetMsg(nil, "gscode.OpCode", "queryIndustryWages", "gs.QueryIndustryWages", self._getStandardWage, self)
end

function BuildingSalaryDetailPartNew:_InitClick(mainPanelLuaBehaviour)
    mainPanelLuaBehaviour:AddClick(self.tipsBtn.gameObject, function ()
        self:_showTips(true)
    end , self)
    mainPanelLuaBehaviour:AddClick(self.closeBtn.gameObject, function ()
        self:_showTips(false)
    end , self)
end

--
function BuildingSalaryDetailPartNew:_ResetTransform()
    self.standardWageText.text = "E0.0000"
    self.staffNumText.text = "0"
    self.totalText.text = "E0.0000"
    --self.timeText.text = "00:00"
    self:_showTips(false)

    self:_language()
end
--
function BuildingSalaryDetailPartNew:_RemoveEvent()
    DataManager.ModelNoneInsIdRemoveNetMsg("gscode.OpCode", "queryIndustryWages", self)
end

function BuildingSalaryDetailPartNew:_RemoveClick()
    self.tipsBtn.onClick:RemoveAllListeners()
    self.closeBtn.onClick:RemoveAllListeners()
end

--
function BuildingSalaryDetailPartNew:_ChildHide()

end
--
function BuildingSalaryDetailPartNew:RefreshData(data)
    self:_ResetTransform()
    if data == nil then
        return
    end
    self.m_data = data
    self:_initFunc()
end
--
function BuildingSalaryDetailPartNew:_InitTransform()
    self:_getComponent(self.transform)
end
--
function BuildingSalaryDetailPartNew:_getComponent(transform)
    if transform == nil then
        return
    end
    self.standardWageText = transform:Find("root/bg03/wage/standardWageText"):GetComponent("Text")
    self.standardWageText01 = transform:Find("root/bg03/wage/Text"):GetComponent("Text")
    self.staffNumText = transform:Find("root/bg03/staffNum/staffNumText"):GetComponent("Text")
    self.staffNumText02 = transform:Find("root/bg03/staffNum/Text"):GetComponent("Text")
    self.totalText = transform:Find("root/bg03/total/totalText"):GetComponent("Text")
    self.totalText03 = transform:Find("root/bg03/total/Text"):GetComponent("Text")
    --self.timeText = transform:Find("root/bg03/time/timeText"):GetComponent("Text")
    --self.timeText04 = transform:Find("root/bg03/time/Text"):GetComponent("Text")
    self.tipsBtn = transform:Find("root/bg03/wage/TipsBtn"):GetComponent("Button")
    self.tipsImage = transform:Find("root/bg03/wage/TipsBtn/TipsImage")
    self.tipsTitleText = transform:Find("root/bg03/wage/TipsBtn/TipsImage/TitleText"):GetComponent("Text")
    self.tipsContentText = transform:Find("root/bg03/wage/TipsBtn/TipsImage/ContentText"):GetComponent("Text")
    self.closeBtn = transform:Find("CloseBtn"):GetComponent("Button")
end
--
function BuildingSalaryDetailPartNew:_language()
    self.standardWageText01.text = GetLanguage(26020001)
    self.staffNumText02.text = GetLanguage(26020003)
    self.totalText03.text = GetLanguage(26020005)
    self.tipsTitleText.text = "Salary description:"
    self.tipsContentText.text = "1.The increase of urban wages is determined by the number of EVA points consumed by the city."
    --self.timeText04.text = GetLanguage(26020006)
end

--
function BuildingSalaryDetailPartNew:_initFunc()
    if self.m_data.info.state ~= "OPERATE" then
        return
    end

    local staffNum = PlayerBuildingBaseData[self.m_data.info.mId].maxWorkerNum
    self.staffNumText.text = staffNum
    local standardWage = DataManager.GetBuildingStandardWage(self.m_data.info.mId)  --行业标准工资
    --行业标准工资暂时是放在DataManager中管理，不刷新，如果DataMgr没有则请求，然后_getStandardWage是回调
    if standardWage == nil then
        DataManager.m_ReqStandardWage(self.m_data.info.mId)
    else
        self.standardWageText.text = string.format("E%s/d", GetClientPriceString(standardWage))
        local value = self.m_data.info.salary * staffNum * standardWage / 100  --因为工资百分比是整数
        self.totalText.text = "E"..GetClientPriceString(value)
        self.standardWage = standardWage
    end

    self.effectTime = self.m_data.info.setSalaryTs / 1000
    --if self.effectTime ~= nil then
    --    self.timeText.text = os.date("%H:%M", self.effectTime)
    --end
end
--收到行业工资回调
function BuildingSalaryDetailPartNew:_getStandardWage(data)
    if data.industryWages ~= nil then
        DataManager.SetBuildingStandardWage(data.type, data.industryWages)
        self.standardWageText.text = string.format("E%s/d", GetClientPriceString(data.industryWages))
        self.standardWage = data.industryWages

        local staffNum = PlayerBuildingBaseData[self.m_data.info.mId].maxWorkerNum
        local value = self.m_data.info.salary * staffNum * self.standardWage / 100  --因为工资百分比是整数
        self.totalText.text = "E"..GetClientPriceString(value)
    end
end
--
function BuildingSalaryDetailPartNew:clickCloseBtn()
    self.groupClass.TurnOffAllOptions(self.groupClass)
end

function BuildingSalaryDetailPartNew:_showTips(isShow)
    self.tipsImage.localScale = isShow and Vector3.one or Vector3.zero
    self.closeBtn.transform.localScale = isShow and Vector3.one or Vector3.zero
end
