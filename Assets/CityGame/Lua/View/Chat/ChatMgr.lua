---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2018/12/14 11:50
---

ChatMgr = class('FriendsMgr')
ChatMgr.static.ExpressionBtnPATH = "View/Chat/ExpressionBtnItem"
ChatMgr.static.ChatRightItemPath = "View/Chat/ChatRightItem"
ChatMgr.static.ChatLeftItemPath = "View/Chat/ChatLeftItem"

function ChatMgr:initialize()
    ct.log("tina_w9_friends", "FriendsMgr:initialize")
    self:initData()
end

function ChatMgr:initData()
    self.worldItem = {}
    self.friendsItem = {}
    self.friendsId = nil
    self.friendsToggle = nil
    self.ownerId = DataManager.GetMyOwnerID()
end

function ChatMgr:SetRootScrollbar(scrollbar)
    if scrollbar == 1 then
        self.rootScrollbar = ChatPanel.worldVerticalScrollbar
    elseif scrollbar == 2 then
        self.rootScrollbar = ChatPanel.friendsVerticalScrollbar
    end
end

function ChatMgr:SetFriendsIdAndToggle(friendsId, friendsToggle)
    if self.friendsToggle then
        self.friendsToggle.isOn = false
        self.friendsToggle.interactable = true
    end
    self.friendsId = friendsId
    self.friendsToggle = friendsToggle
end

function ChatMgr:GetFriendsId()
    return self.friendsId
end

function ChatMgr:GetOwnerId()
    return self.ownerId
end

function ChatMgr:DestroyContentChildren()
    for _, v in ipairs(self.friendsItem) do
        UnityEngine.GameObject.Destroy(v.prefab)
    end
    self.friendsItem = {}
end

--创建表情
function ChatMgr:_createNotice()
    for i = 1, 80 do -- 生成80个表情
        local prefab = self:_createNoticePab(ChatMgr.static.ExpressionBtnPATH, ChatPanel.expressionContent)
        local ExpressionBtnItem = ExpressionBtnItem:new(i,prefab)
    end
end

--创建聊天Item
function ChatMgr:_createChatItem(chatData)
    if DataManager.GetMyOwnerID() == chatData.id then
        if chatData.channel == "WORLD" then -- 代表世界频道
            local prefab = self:_createNoticePab(ChatMgr.static.ChatRightItemPath, ChatPanel.worldContent)
            local chatRightItem = ChatRightItem:new(#self.worldItem + 1, prefab, chatData)
            table.insert(self.worldItem, chatRightItem)
        elseif chatData.channel == "FRIEND" and chatData.channelId == self.friendsId then -- 代表好友频道
            local prefab = self:_createNoticePab(ChatMgr.static.ChatRightItemPath, ChatPanel.friendsContent)
            local chatRightItem = ChatRightItem:new(#self.friendsItem + 1, prefab, chatData)
            table.insert(self.friendsItem, chatRightItem)
        end
    else
        if chatData.channel == "WORLD" then -- 代表世界频道
            local prefab = self:_createNoticePab(ChatMgr.static.ChatLeftItemPath, ChatPanel.worldContent)
            local chatLeftItem = ChatLeftItem:new(#self.worldItem + 1, prefab, chatData)
            table.insert(self.worldItem, chatLeftItem)
        elseif chatData.channel == "FRIEND" and chatData.channelId == self.friendsId then -- 代表好友频道
            local prefab = self:_createNoticePab(ChatMgr.static.ChatLeftItemPath, ChatPanel.friendsContent)
            local chatLeftItem = ChatLeftItem:new(#self.friendsItem + 1, prefab, chatData)
            table.insert(self.friendsItem, chatLeftItem)
        end
    end
end

-- 显示玩家的信息面板
function ChatMgr:ShowPlayerInfo(index, data)
    ChatPanel.playerInfoRoot:SetActive(true)
    ChatPanel.nameText.text = data.name
    ChatPanel.companyText.text = data.company
    if index == 1 then
        ChatPanel.shieldBtn:SetActive(false)
        ChatPanel.addFriendsBtn:SetActive(true)
        ChatPanel.chatBtn:SetActive(true)
    elseif index == 2 then
        ChatPanel.backChatBtn:SetActive(true)
        ChatPanel.shieldBtn:SetActive(true)
        ChatPanel.addFriendsBtn:SetActive(false)
        ChatPanel.chatBtn:SetActive(false)
    end
end

--生成预制
function ChatMgr:_createNoticePab(path,parent)
    local prefab = UnityEngine.Resources.Load(path)
    local go = UnityEngine.GameObject.Instantiate(prefab)
    local rect = go.transform:GetComponent("RectTransform")
    go.transform:SetParent(parent.transform)
    rect.transform.localScale = Vector3.one
    return go
end

function ChatMgr:StartScrollBottom()
    self.timeNow = UnityEngine.Time.time + 0.1
    UpdateBeat:Add(self._scrollBottom, self)
end

--滑动到底部
function ChatMgr:_scrollBottom()
    if not self.rootScrollbar then
        return
    end

    if  UnityEngine.Time.time> self.timeNow then
        self.rootScrollbar.value = 0
        UpdateBeat:Remove(self._scrollBottom, self)
    end
end