---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2018/10/26/026 11:25
---
require 'View/BuildingInfo/AdvertisementItem'

require 'View/BuildingInfo/AddItem'
require'View/BuildingInfo/GoodsItem'
require'View/BuildingInfo/BuildingItem'

require'View/BuildingInfo/outAdvertisementItem'


local class = require 'Framework/class'
ItemCreatDeleteMgr = class('ItemCreatDeleteMgr')

ItemCreatDeleteMgr.advertisementItemPreb_Path="View/GoodsItem/AdvertisementItem"

ItemCreatDeleteMgr.addItemPreb_Path="View/GoodsItem/addItem"
ItemCreatDeleteMgr.goodsPreb_Path="View/GoodsItem/goodsItem"
ItemCreatDeleteMgr.buildingPreb_Path="View/GoodsItem/buildingItem"
ItemCreatDeleteMgr.outadvertisementItemPreb_Path="View/GoodsItem/outAdvertisementItem"
ItemCreatDeleteMgr.AddedItem_Path="View/GoodsItem/MapAdvertisementItem"



function ItemCreatDeleteMgr:initialize()


end
local idList={}
local typelist={}
local metald=0
local adList={}
function ItemCreatDeleteMgr:creat(luabehaviour,creatData)
    if not  self.addedItemList then
        self.addedItemList={}
        self.selectItemList={}
        self.index=0
        self.AdvertisementDataList={}
    end
    self.transform=ManageAdvertisementPosPanel.addCon;

    self.behaviour = luabehaviour
    self.buildingData=creatData

     idList={}
  typelist={}
   metald=0
     adList={}

    if creatData.lMsg then
        if creatData.lMsg.ad.ad then
            ---对广告进行筛选
            for i, v in pairs(creatData.lMsg.ad.ad) do
                ---已有类型
                for k, va in pairs(idList) do
                    if va==v.metaId then
                        typelist[v.metaId][v.id]=v
                        break
                    end
                end
                ---类型不同
                if v.metaId~=metald then
                    idList[v.metaId]=v.metaId
                    metald=v.metaId
                    if not typelist[v.metaId]then
                        typelist[v.metaId]={}
                    end
                    typelist[v.metaId][v.id]=v
                end
            end
        end
    end


    if creatData.buildingType == BuildingType.Municipal then---创建广告
    for i, v in pairs(typelist) do
        local data=nil
        local count=0
        for j, q in pairs(v) do
            count=count+1
            data=q
        end
        data["count"]=count
        self:_creatAdvertisementItem(data)
    end
    elseif creatData.buildingType == BuildingType.MunicipalManage then
        self:_creataddItem();
        self:_creatgoodsItem();
        self:_creatgoodsItem();
        self:_creatbuildingItem();
        ---创建自已打的广告
        for i, v in pairs(typelist) do
            local data=nil
            local count=0
            local id=0
            for j, q in pairs(v) do
                count=count+1
                data=q
                if i~=id then
                    if not adList[i] then
                        adList[i]={}
                    end
                    table.insert(adList[i],q)
                    id=i
                else
                    table.insert(adList[i],q)
                    id=i
                end
            end
            data["count"]=count
            self:_creatserverMapAdvertisementItem(data)
        end

        self.adList=adList
    else---创建外部广告

        for i, v in pairs(typelist) do
            local data=nil
            for j, q in pairs(v) do
                data=q
            end
            self:_creatoutItem(data)
        end
    end



end


---创建服务器映射广告
local ServerMapAdvertisementItemID=0
function ItemCreatDeleteMgr:_creatserverMapAdvertisementItem(prefabData)
    if(not self.serverMapAdvertisementItemList ) then
        self.serverMapAdvertisementItemList={}
        self.serverMapAdvertisementINSList={}
    end

    local item=self:c_creatGoods(self.AddedItem_Path,self.transform)
    self.serverMapAdvertisementItemList[ServerMapAdvertisementItemID]=item
    ---给映射广告赋值数据
   local ins =serverMapAdvertisementItem:new(prefabData,item,self.behaviour,self,ServerMapAdvertisementItemID)
    self.serverMapAdvertisementINSList[prefabData.metaId]=ins
    ServerMapAdvertisementItemID=ServerMapAdvertisementItemID+1
end

---创建映射广告
local MapAdvertisementItemID=0
function ItemCreatDeleteMgr:_creatMapAdvertisementItem(prefabData)
    if(not self.MapAdvertisementItemList ) then
        self.MapAdvertisementItemList={}
    end

   local item=self:c_creatGoods(self.AddedItem_Path,self.transform)
    self.MapAdvertisementItemList[MapAdvertisementItemID]=item
    ---给映射广告赋值数据
   MapAdvertisementItem:new(prefabData,item,self.behaviour,self,MapAdvertisementItemID)
    MapAdvertisementItemID=MapAdvertisementItemID+1
end

---创建外部广告
local outAdvertisementItemID=0;
function ItemCreatDeleteMgr:_creatoutItem(prefabData)
    if(not self.outAdvertisementItemList ) then
        self.outAdvertisementItemList={}
        self.outAdvertisementINSList={}
    end
    ------创建预制
    local itemclone=self:c_creatGoods(self.outadvertisementItemPreb_Path,MunicipalPanel.scrollCon)

    self.outAdvertisementItemList[outAdvertisementItemID]=itemclone
    -----给预制赋值数据
   local Ins = outAdvertisementItem:new(prefabData,itemclone,self.behaviour,self,outAdvertisementItemID)
    self.outAdvertisementINSList[prefabData.metaId]=Ins
    outAdvertisementItemID=outAdvertisementItemID+1;
end

---创建广告
local AdvertisementItemID=0;
function ItemCreatDeleteMgr:_creatAdvertisementItem(prefabData)
    if(not self.AdvertisementItemList ) then
        self.AdvertisementItemList={}
        self.AdvertisementINSList={}
    end
    ---创建预制
    local itemclone=self:c_creatGoods(self.advertisementItemPreb_Path,AdvertisementPosPanel.scrollcon)

    self.AdvertisementItemList[prefabData.metaId]=itemclone
    ---给预制赋值数据
    local ins =AdvertisementItem:new(prefabData,itemclone,self.behaviour,self,AdvertisementItemID)
    if prefabData.metaId then
        self.AdvertisementINSList[prefabData.metaId]=ins
    end

    AdvertisementItemID=AdvertisementItemID+1;
end
---创建添加按钮
local AddItemID=0;
function ItemCreatDeleteMgr:_creataddItem(prefabData)
    if(not self.addItemList ) then
        self.addItemList={}
    end

    ---创建预制
    local itemclone=self:c_creatGoods(self.addItemPreb_Path,ManageAdvertisementPosPanel.addCon)
    self.addItemList[AddItemID]=itemclone
    ---给预制赋值数据
    AddItem:new(prefabData,itemclone,self.behaviour,self,AddItemID)
    AddItemID=AddItemID+1;
    ----------------------------------------------------------------------------------------------------------
end
---创建商品广告
local goodsItemID=0
function ItemCreatDeleteMgr:_creatgoodsItem(goodsPrebData)
    if(not self.goodsItemList)then
        self.goodsItemList={}
    end

    ---创建预制
    local goods=self:c_creatGoods(self.goodsPreb_Path,ManageAdvertisementPosPanel.goodsCon)
    self.goodsItemList[goodsItemID]=goods
    --- ---给预制赋值数据
    GoodsItem:new(goodsPrebData,goods,self.behaviour,self,goodsItemID)
    goodsItemID=goodsItemID+1
end
---创建建筑广告
local buildItemID=0
function ItemCreatDeleteMgr:_creatbuildingItem(buildingPrebData)
    if not self.buildItemList then
        self.buildItemList={}
    end

    ---创建预制
    local buildings=self:c_creatGoods(self.buildingPreb_Path,ManageAdvertisementPosPanel.buildingCon)
    self.buildItemList[buildItemID]=buildings
    --- ---给预制赋值数据
    BuildingItem:new(buildingPrebData,buildings,self.behaviour,self,buildItemID)
    buildItemID=buildItemID+1
end


---生成预制
function ItemCreatDeleteMgr:c_creatGoods(path,parent)
    local prefab = UnityEngine.Resources.Load(path);
    local go = UnityEngine.GameObject.Instantiate(prefab);
    local rect = go.transform:GetComponent("RectTransform");
    go.transform:SetParent(parent);--.transform
    rect.transform.localScale = Vector3.one;
    rect.transform.localPosition=Vector3.zero
    return go
end


---删除物品
function ItemCreatDeleteMgr:_deleteGoods(ins)
    destroy(ins.ItemList[ins.id])
end





