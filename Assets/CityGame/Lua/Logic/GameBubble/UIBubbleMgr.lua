---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2019/1/16 17:47
---UIBubbleMgr

UIBubbleMgr= {}
local this = UIBubbleMgr
local pbl = pbl

UIBubbleMgr.GroundAucSoonObjPath = "View/Items/BuildingBubbleItems/UIBubbleGroundAucSoonItem"  --即将拍卖
UIBubbleMgr.GroundAucNowObjPath = "View/Items/BuildingBubbleItems/UIBubbleGroundAucNowItem"  --正在拍卖
UIBubbleMgr.BubbleParentObjPath = "View/Items/BuildingBubbleItems/UIBubblePanel"  --父物体

--构建函数--
function UIBubbleMgr.New()
    return this
end

function UIBubbleMgr.Awake()
    this:OnCreate()
    this._preLoadGroundAucObj()
    this.startFlowCam = false
end

--启动事件--
function UIBubbleMgr.OnCreate()
    --网络回调注册
    Event.AddListener("c_BidEnd", this.bidEnd)
end

function UIBubbleMgr._preLoadGroundAucObj()
    local prefab = UnityEngine.Resources.Load(UIBubbleMgr.BubbleParentObjPath)
    this.BubbleParent = UnityEngine.GameObject.Instantiate(prefab)
end

--气泡类型
UIBubbleType =
{
    GroundAuc = 1,
    GroundTrans = 2,
    BuildingSelf = 3,
}

function UIBubbleMgr._cameraLateUpdate()
    if this.startFlowCam == nil or this.startFlowCam == false then
        return
    end
    Event.Brocast("c_RefreshLateUpdate")
end

--设置打开气泡模式
function UIBubbleMgr.startBubble()
    if this.startFlowCam == false then
        this.startFlowCam = true
        this.BubbleParent.transform:SetParent(UIRoot.getFixedRoot().transform)
        this.BubbleParent.transform.localScale = Vector3.one
        this.BubbleParent.transform:GetComponent("RectTransform").anchoredPosition = Vector2.zero
    end
end
--拍卖结束
function UIBubbleMgr.bidEnd(endId)
    this.nowItem:Close()
    this.nowItem = nil
end

--生成即将拍卖气泡
function UIBubbleMgr.createSoonAucBubble(aucData)
    if this.startFlowCam == false then
        ct.log("", "尚未打开气泡模式")
        return
    end

    if this.aucSoonItem ~= nil then
        this.aucSoonItem = {}
    end
    if aucData == nil then
        return
    end
    this._creatGroundAucBubbleItem(aucData, 0)
end

--生成拍卖气泡
function UIBubbleMgr.createNowAucBubble(aucData)
    if this.startFlowCam == false then
        ct.log("", "尚未打开气泡模式")
        return
    end

    if aucData == nil then
        return
    end
    if this.aucNowItem ~= nil then
        this.aucNowItem = {}
    end
    this._creatGroundAucBubbleItem(aucData, 1)
end
--拍卖刷新信息
function UIBubbleMgr.updateAucData(data)
    if this.nowItem == nil then
        return
    end
    this.nowItem:_bidInfoUpdate(data)
end

function UIBubbleMgr._creatGroundAucBubbleItem(bubbleData, index)
    if index == 1 then
        --已经开始拍卖
        if this.groundAucNowObj == nil then
            this.groundAucNowObj = UnityEngine.Resources.Load(this.GroundAucNowObjPath)
        end
        local go = UnityEngine.GameObject.Instantiate(this.groundAucNowObj)
        go.transform:SetParent(this.BubbleParent.transform)
        if this.hide then
            go.transform.localScale = Vector3.zero
        else
            go.transform.localScale = Vector3.one
        end
        --local data = ct.deepCopy(bubbleData)
        local data = bubbleData
        --data.groundObj.transform.localScale = Vector3.one
        data.bubbleObj = go  --将obj引用到lua中
        local groundAucNowItem = UIBubbleGroundAucNowItem:new(data)
        this.aucNowItem = groundAucNowItem

    elseif index == 0 then
        --即将拍卖
        if nil == this.groundAucSoonObj then
            this.groundAucSoonObj = UnityEngine.Resources.Load(this.GroundAucSoonObjPath)
        end
        local go = UnityEngine.GameObject.Instantiate(this.groundAucSoonObj)  --气泡预制
        go.transform:SetParent(this.BubbleParent.transform)
        if this.hide then
            go.transform.localScale = Vector3.zero
        else
            go.transform.localScale = Vector3.one
        end
        local data = bubbleData
        --data.groundObj.transform.localScale = Vector3.one  --地块
        data.bubbleObj = go
        local groundAucSoonItem = UIBubbleGroundAucSoonItem:new(data)
        this.aucSoonItem = groundAucSoonItem
    end
end

--更新数据
function UIBubbleMgr._refreshItems(datas)
    this.nowItem:Close()
    this.soonItem:Close()

    this.nowItem = nil
    this.soonItem = nil

    if datas.nowData ~= nil then
        this._creatGroundAucBubbleItem(datas.nowData, 1)
    end
    if datas.soonData ~= nil then
        this._creatGroundAucBubbleItem(datas.soonData, 0)
    end
end

--隐藏所有气泡
function UIBubbleMgr._hideAllItems()
    UIBubbleMgr.hide = true
    Event.Brocast("c_BubbleAllHide")

    --for key, item in pairs(UIBubbleMgr.groundAucLuaItems) do
    --    if item.data.bubbleRect then
    --        item.data.bubbleRect.transform.localScale = Vector3.zero
    --    end
    --end
end
--显示所有气泡
function UIBubbleMgr._showAllItems()
    UIBubbleMgr.hide = false
    Event.Brocast("c_BubbleAllShow")

    --for key, item in pairs(UIBubbleMgr.groundAucLuaItems) do
    --    if item.data.bubbleRect then
    --        item.data.bubbleRect.transform.localScale = Vector3.one
    --    end
    --end
end

----
--打开拍卖界面
function UIBubbleMgr._openGroundAucCtrl(index)
    if index == 1 then
        if UIBubbleMgr.nowItem ~= nil then
            UIBubbleMgr.nowItem:_openGroundAucFunc()
        end
        return
    end
    if index == 0 then
        if UIBubbleMgr.soonItem ~= nil then
            UIBubbleMgr.soonItem:_openGroundAucFunc()
        end
        return
    end
end
--通过类型获取一个气泡
function UIBubbleMgr.getBubbleByType(bubbleType, groundState, serverPos, uiCenterPos)
    if bubbleType == UIBubbleType.GroundTrans or bubbleType == UIBubbleType.BuildingSelf then
        local data = {bubbleType = bubbleType, groundState = groundState, uiCenterPos = uiCenterPos}
        local obj = UIBubbleMgr.getBubbleObj(bubbleType)
        if serverPos ~= nil then
            data.blockId = TerrainManager.GridIndexTurnBlockID(serverPos)
            obj.name = "bubble "..serverPos.x..serverPos.y
        end
        local bubbleItem = UIBubbleTransAndBuildingItem:new(data, obj)
        return bubbleItem
    end
end
function UIBubbleMgr.getBubbleObj(type)
    local go
    if type == UIBubbleType.GroundTrans or type == UIBubbleType.BuildingSelf then
        if UIBubbleMgr.sellRentPrefab == nil then
            UIBubbleMgr.sellRentPrefab = UnityEngine.Resources.Load(UIBubbleMgr.SellRentObjPath)
        end
        go = UnityEngine.GameObject.Instantiate(UIBubbleMgr.sellRentPrefab)
        go.transform:SetParent(this.BubbleParent.transform)
        go.transform.localScale = Vector3.one
        return go
    else
        --拍卖类型的预制
    end
end