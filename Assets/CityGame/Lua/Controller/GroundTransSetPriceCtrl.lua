---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/12/24 15:33
---土地交易设置租/卖金额
GroundTransSetPriceCtrl = class('GroundTransSetPriceCtrl',UIPanel)
UIPanel:ResgisterOpen(GroundTransSetPriceCtrl)

function GroundTransSetPriceCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function GroundTransSetPriceCtrl:bundleName()
    return "Assets/CityGame/Resources/View/GroundTransSetPricePanel.prefab"
end

function GroundTransSetPriceCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function GroundTransSetPriceCtrl:Awake(go)
    local groundAuctionBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.bgBtn.gameObject, self._closeBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.backBtn.gameObject, self._backBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.rentIssueBtnTran.gameObject, self._rentIssueBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.rentCancelBtnTran.gameObject, self._cancelRentBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.rentChangeBtnTran.gameObject, self._rentChangeBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.sellIssueBtnTran.gameObject, self._sellIssueBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.sellCancelBtnTran.gameObject, self._cancelSellBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.sellChangeBtnTran.gameObject, self._sellChangeBtnFunc, self)

    GroundTransSetPricePanel.maxRentDayInput.onValueChanged:AddListener(function(value)
        if value == nil or value == "" then
            return
        end
        if tonumber(value) > 999 then
            GroundTransSetPricePanel.maxRentDayInput.text = "999"
        end
    end)
end

function GroundTransSetPriceCtrl:Refresh()
    self:_initPanelData()
end

function GroundTransSetPriceCtrl:Active()
    UIPanel.Active(self)
    GroundTransSetPricePanel.sellPriceText01.text = GetLanguage(22030002)
    GroundTransSetPricePanel.minRentText02.text = GetLanguage(22020002)
    GroundTransSetPricePanel.maxRentText03.text = GetLanguage(22020003)
    GroundTransSetPricePanel.rentDayText04.text = GetLanguage(22020004)
end

function GroundTransSetPriceCtrl:Hide()
    UIPanel.Hide(self)
end

function GroundTransSetPriceCtrl:Close()
    UIPanel.Close(self)
end

---初始化
function GroundTransSetPriceCtrl:_initPanelData()
    if self.m_data and self.m_data.groundInfo then
        self:_setShowState(self.m_data.groundInfo, self.m_data.groundState, self.m_data.showPageType)
    end
end
--根据状态显示界面
function GroundTransSetPriceCtrl:_setShowState(groundInfo, groundState, showPageType)
    GroundTransSetPricePanel.cleanData()
    GroundTransSetPricePanel.sellRoot.localScale = Vector3.zero
    GroundTransSetPricePanel.rentRoot.localScale = Vector3.zero
    GroundTransSetPricePanel.sellChangeStateTran.localScale = Vector3.zero
    GroundTransSetPricePanel.sellIssueBtnTran.localScale = Vector3.zero
    GroundTransSetPricePanel.rentChangeStateTran.localScale = Vector3.zero
    GroundTransSetPricePanel.rentIssueBtnTran.localScale = Vector3.zero

    if showPageType == GroundTransState.Rent then
        GroundTransSetPricePanel.titleText.text = GetLanguage(22020001)
        GroundTransSetPricePanel.rentRoot.localScale = Vector3.one
        if groundState == GroundTransState.None then
            --显示设置租金
            GroundTransSetPricePanel.rentIssueBtnTran.localScale = Vector3.one
        elseif groundState == GroundTransState.Rent then
            --显示修改/取消状态
            GroundTransSetPricePanel.rentChangeStateTran.localScale = Vector3.one
            GroundTransSetPricePanel.minRentDayInput.text = groundInfo.rent.rentDaysMin
            GroundTransSetPricePanel.maxRentDayInput.text = groundInfo.rent.rentDaysMax
            GroundTransSetPricePanel.rentalInput.text = GetClientPriceString(groundInfo.rent.rentPreDay)
        end
    elseif showPageType == GroundTransState.Sell then
        GroundTransSetPricePanel.titleText.text = GetLanguage(22030001)
        GroundTransSetPricePanel.sellRoot.localScale = Vector3.one
        if groundState == GroundTransState.None then
            --显示设置出售金额
            GroundTransSetPricePanel.sellIssueBtnTran.localScale = Vector3.one
        elseif groundState == GroundTransState.Sell then
            --显示修改/取消状态
            GroundTransSetPricePanel.sellChangeStateTran.localScale = Vector3.one
            GroundTransSetPricePanel.sellInput.text = GetClientPriceString(groundInfo.sell.price)
        end
    end
end

---按钮方法
--点其他地方则关闭整个堆栈，打开主界面
function GroundTransSetPriceCtrl:_closeBtnFunc()
    PlayMusEff(1002)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--返回按钮
function GroundTransSetPriceCtrl:_backBtnFunc()
    PlayMusEff(1002)
    UIPanel:ClosePage()
end

--售卖发布按钮
function GroundTransSetPriceCtrl:_sellIssueBtnFunc(ins)
    PlayMusEff(1002)
    local price = GroundTransSetPricePanel.sellInput.text
    if price ~= "" and tonumber(price) > 0 then
        GroundTransModel.m_ReqSellGround(GetServerPriceNumber(price))
        Event.Brocast("SmallPop", GetLanguage(22030003), 300)

        GroundTransSetPriceCtrl._closeBackToMain()
    else
        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
    end
end
--修改出售价格按钮
function GroundTransSetPriceCtrl:_sellChangeBtnFunc(ins)
    PlayMusEff(1002)
    local price = GroundTransSetPricePanel.sellInput.text
    if price == "" or tonumber(price) <= 0 then
        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
        return
    end
    if tonumber(price) == tonumber(GetClientPriceString(ins.m_data.groundInfo.sell.price)) then
        Event.Brocast("SmallPop", GetLanguage(22070002), 300)
        return
    end
    GroundTransModel.m_ReqCancelSellGround()  --先发送取消售卖再发送售卖，则为修改
    GroundTransModel.m_ReqSellGround(GetServerPriceNumber(price))
    Event.Brocast("SmallPop", GetLanguage(22030004), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--取消出售
function GroundTransSetPriceCtrl:_cancelSellBtnFunc(ins)
    PlayMusEff(1002)
    GroundTransModel.m_ReqCancelSellGround()

    Event.Brocast("SmallPop", GetLanguage(22030005), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end

--出租发布按钮
function GroundTransSetPriceCtrl:_rentIssueBtnFunc(ins)
    PlayMusEff(1002)
    local minDay = GroundTransSetPricePanel.minRentDayInput.text
    local maxDay = GroundTransSetPricePanel.maxRentDayInput.text
    local dayRentalPrice = GroundTransSetPricePanel.rentalInput.text
    if minDay == "" or tonumber(minDay) < 1 or maxDay == "" or tonumber(maxDay) < tonumber(minDay) or dayRentalPrice == "" or tonumber(dayRentalPrice) <= 0 then
        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
        return
    end
    GroundTransModel.m_ReqRentOutGround(minDay, maxDay, GetServerPriceNumber(dayRentalPrice))

    Event.Brocast("SmallPop", GetLanguage(22020006), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--修改出租价格按钮
function GroundTransSetPriceCtrl:_rentChangeBtnFunc(ins)
    PlayMusEff(1002)
    local minDay = GroundTransSetPricePanel.minRentDayInput.text
    local maxDay = GroundTransSetPricePanel.maxRentDayInput.text
    local dayRentalPrice = GroundTransSetPricePanel.rentalInput.text
    if minDay == "" or tonumber(minDay) < 1 or maxDay == "" or tonumber(maxDay) < tonumber(minDay) or dayRentalPrice == "" or tonumber(dayRentalPrice) <= 0 then
        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
        return
    end
    if minDay == ins.m_data.groundInfo.rent.rentDaysMin or maxDay == ins.m_data.groundInfo.rent.rentDaysMax or GetServerPriceNumber(dayRentalPrice) == ins.m_data.groundInfo.rent.rentPreDay then
        Event.Brocast("SmallPop", GetLanguage(22070002), 300)
        return
    end
    GroundTransModel.m_ReqCancelRentGround()
    GroundTransModel.m_ReqRentOutGround(minDay, maxDay, GetServerPriceNumber(dayRentalPrice))
    Event.Brocast("SmallPop", GetLanguage(22020007), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--取消出租
function GroundTransSetPriceCtrl:_cancelRentBtnFunc(ins)
    PlayMusEff(1002)
    GroundTransModel.m_ReqCancelRentGround()
    Event.Brocast("SmallPop", GetLanguage(22020008), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--返回主界面
function GroundTransSetPriceCtrl._closeBackToMain()
    UIPanel.CloseAllPageExceptMain()
end