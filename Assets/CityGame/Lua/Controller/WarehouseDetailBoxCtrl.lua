---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by mengpengfei.
--- DateTime: 2019/4/18 18:11
---从货架打开仓库（另外做一个Panel）
WarehouseDetailBoxCtrl = class("WarehouseDetailBoxCtrl",UIPanel)
UIPanel:ResgisterOpen(WarehouseDetailBoxCtrl)

local ToNumber = tonumber
local StringSun = string.sub
function WarehouseDetailBoxCtrl:initialize()
    UIPanel.initialize(self,UIType.PopUp,UIMode.DoNothing,UICollider.Normal)
end

function WarehouseDetailBoxCtrl:bundleName()
    return "Assets/CityGame/Resources/View/WarehouseDetailBoxPanel.prefab"
end

function WarehouseDetailBoxCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end

function WarehouseDetailBoxCtrl:Awake(go)
    self.gameObject = go
    self:_getComponent(go)
    self:_language()
    self.luaBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    self.luaBehaviour:AddClick(self.closeBtn.gameObject,self._clickCloseBtn,self)
end

function WarehouseDetailBoxCtrl:Refresh()
    self:initializeUiInfoData()
end

function WarehouseDetailBoxCtrl:Hide()
    UIPanel.Hide(self)
    self:CloseDestroy()
end
-------------------------------------------------------------获取组件-------------------------------------------------------------------------------
function WarehouseDetailBoxCtrl:_getComponent(go)
    --topRoot
    self.closeBtn = go.transform:Find("topRoot/closeBtn")
    self.sortingBtn = go.transform:Find("topRoot/sortingBtn")
    --contentRoot
    self.noTip = go.transform:Find("contentRoot/noTip")
    self.tipText = go.transform:Find("contentRoot/noTip/tipText"):GetComponent("Text")
    self.Content = go.transform:Find("contentRoot/ScrollView/Viewport/Content")
    self.WarehouseItem = go.transform:Find("contentRoot/ScrollView/Viewport/Content/WarehouseItem").gameObject
end
-------------------------------------------------------------初始化---------------------------------------------------------------------------------
--初始化UI数据
function WarehouseDetailBoxCtrl:initializeUiInfoData()
    if next(self.m_data.info.store) == nil then
        self.noTip.transform.localScale = Vector3.one
        return
    else
        if not self.goodsItemTable then
            self.goodsItemTable = {}
        end
        self.noTip.transform.localScale = Vector3.zero
        self.addShelfBool = GoodsItemStateType.addShelf
        self:CreateGoodsItems(self.m_data.info.store,self.WarehouseItem,self.Content,WarehouseItem,self.luaBehaviour,self.m_data.info.buildingType,self.addShelfBool,self.m_data.info.info.id)
    end
end
--设置多语言
function WarehouseDetailBoxCtrl:_language()
    self.tipText.text = "There is no product yet!".."\n".."just go to produce some.good luck."
end
-------------------------------------------------------------点击函数-------------------------------------------------------------------------------
--关闭
function WarehouseDetailBoxCtrl:_clickCloseBtn()
    PlayMusEff(1002)
    UIPanel.ClosePage()
end
----------------------------------------------------------------------------------------------------------------------------------------------------
--上架
function WarehouseDetailBoxCtrl:addShelf(dataInfo)
    if self.m_data.info.buildingType == BuildingType.MaterialFactory then
        --如果是原料厂

    elseif self.m_data.info.buildingType == BuildingType.ProcessingFactory then
        --如果是加工厂

    end
end
----------------------------------------------------------------------------------------------------------------------------------------------------
--生成itemPrefab
function WarehouseDetailBoxCtrl:CreateGoodsItems(dataInfo,itemPrefab,itemRoot,className,behaviour,goodsType,...)
    if not dataInfo then
        return
    end
    local arg = {...}
    --筛选出有用的数据
    --如果是原料厂上架，筛选出原料；如果是加工厂上架，筛选出商品
    local temporaryDataInfo = {}
    local materialKey,goodsKey = 21,22
    if self.m_data.info.buildingType == BuildingType.MaterialFactory then
        for key,value in pairs(dataInfo.inHand) do
            if ToNumber(StringSun(value.key.id,1,2)) == materialKey then
                table.insert(temporaryDataInfo,value)
            end
        end
    elseif self.m_data.info.buildingType == BuildingType.ProcessingFactory then
        for key,value in pairs(dataInfo.inHand) do
            if ToNumber(StringSun(value.key.id,1,2)) == goodsKey then
                table.insert(temporaryDataInfo,value)
            end
        end
    end

    for key,value in pairs(temporaryDataInfo) do
        local obj = self:loadingItemPrefab(itemPrefab,itemRoot)
        local itemGoodsIns = className:new(value,obj,behaviour,key,goodsType,arg)
        table.insert(self.goodsItemTable,itemGoodsIns)
    end
end
--加载实例化Prefab
function WarehouseDetailBoxCtrl:loadingItemPrefab(itemPrefab,itemRoot)
    local obj = UnityEngine.GameObject.Instantiate(itemPrefab)
    local objRect = obj.transform:GetComponent("RectTransform");
    obj.transform:SetParent(itemRoot.transform)
    objRect.transform.localScale = Vector3.one;
    --obj.transform:SetSiblingIndex(1)
    obj:SetActive(true)
    return obj
end
--退出时清空Item数据
function WarehouseDetailBoxCtrl:CloseDestroy()
    if not self.goodsItemTable or next(self.goodsItemTable) == nil then
        return
    else
        for key,valueObj in pairs(self.goodsItemTable) do
            destroy(valueObj.prefab.gameObject)
            self.goodsItemTable[key] = nil
        end
    end
end