---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/11/16 15:48
---
LabScientificLineCtrl = class('LabScientificLineCtrl',UIPage)
UIPage:ResgisterOpen(LabScientificLineCtrl)

LabScientificLineCtrl.static.EmptyBtnPath = "View/Items/LaboratoryItems/EmptyBtn"  --按钮的预制
LabScientificLineCtrl.static.LabResearchItemPath = "View/Items/LaboratoryItems/LabResearchItem"  --研究
LabScientificLineCtrl.static.LabInventionItemPath = "View/Items/LaboratoryItems/LabInventionItem"  --发明

function LabScientificLineCtrl:initialize()
    UIPage.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function LabScientificLineCtrl:bundleName()
    return "LabScientificLinePanel"
end

function LabScientificLineCtrl:OnCreate(obj)
    UIPage.OnCreate(self, obj)
end

function LabScientificLineCtrl:Awake(go)
    self.gameObject = go
    self.luaBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    self.luaBehaviour:AddClick(LabScientificLinePanel.backBtn.gameObject, function()
        UIPage.ClosePage()
    end)
    self.luaBehaviour:AddClick(LabScientificLinePanel.researchBtn.gameObject, function()
        self:_researchLineOpen()
    end)
    self.luaBehaviour:AddClick(LabScientificLinePanel.inventionBtn.gameObject, function()
        self:_inventionLineOpen()
    end)

    self.luaBehaviour:AddClick(LabScientificLinePanel.changeStaffCountBtn.gameObject, function()
        self:_cancelChangeStaffCount()
    end)
    self.luaBehaviour:AddClick(LabScientificLinePanel.delBtn.gameObject, function()
        self:_cancelChangeStaffCount()
    end)
    self.luaBehaviour:AddClick(LabScientificLinePanel.okBtn.gameObject, function()
        self:_sureChangeStaffCount()
    end)
    LabScientificLinePanel.staffSlider.onValueChanged:AddListener(function(value)
        self:_onStaffSliderValueChange(value)
    end)

    --滑动复用部分
    self.researchSource = UnityEngine.UI.LoopScrollDataSource.New()  --研究
    self.researchSource.mProvideData = LabScientificLineCtrl.static.researchProvideData
    self.researchSource.mClearData = LabScientificLineCtrl.static.researchClearData
    self.inventionSource = UnityEngine.UI.LoopScrollDataSource.New()  --发明
    self.inventionSource.mProvideData = LabScientificLineCtrl.static.inventionProvideData
    self.inventionSource.mClearData = LabScientificLineCtrl.static.inventionClearData
end

function LabScientificLineCtrl:Refresh()
    self:_initPanelData()
end

function LabScientificLineCtrl:Close()
    self:_removeListener()
end

function LabScientificLineCtrl:_addListener()
    Event.AddListener("c_OnReceiveLabLineAdd", self._onReceiveLabAddLine, self)
    --Event.AddListener("c_OnReceiveLabLineAdd", self._onReceiveLabAddLine, self)

end
function LabScientificLineCtrl:_removeListener()
    --Event.RemoveListener("c_onExchangeSort", self._exchangeSortByValue, self)
end

function LabScientificLineCtrl:_initPanelData()
    self:_addListener()
    LabScientificLineCtrl.researchItems = {}
    LabScientificLineCtrl.inventionItems = {}
    self.researchDatas = {}
    self.inventionDatas = {}

    --这个界面的数据是从主界面拿到的，然后数据有变化的时候才会更新，所以不需要请求服务器数据
    --将数据分开
    local workingStaffCount = 0
    if self.m_data.line then
        for key, itemData in pairs(self.m_data.line) do
            workingStaffCount = workingStaffCount + itemData.workerNum
            if itemData.type == 0 then
                self.researchDatas[#self.researchDatas] = itemData
            elseif itemData.type == 1 then
                self.inventionDatas[#self.inventionDatas] = itemData
            end
        end
    end
    self.remainStaffCount = PlayerBuildingBaseData[self.m_data.info.mId].maxWorkerNum
    LabScientificLinePanel.staffCountText.text = string.format("", )
    self.storeItemData = {}  --获取所有的库存
    if self.m_data.store then
        if self.m_data.store.inHand then
            for i, item in pairs(self.m_data.store.inHand) do
                self.storeItemData[item.key.id] = item.n
            end
        end
    end
    self:_researchLineOpen()
end

---按钮切页
function LabScientificLineCtrl:_researchLineOpen()
    LabScientificLinePanel._researchToggleState(true)
    LabScientificLinePanel._inventionToggleState(false)

    self:_onReceiveLabResearchData(self.researchDatas)
end
function LabScientificLineCtrl:_inventionLineOpen()
    LabScientificLinePanel._researchToggleState(false)
    LabScientificLinePanel._inventionToggleState(true)

    self:c_onReceiveLabInventionData(self.inventionDatas)
end

---滑动复用
--研究
LabScientificLineCtrl.static.researchProvideData = function(transform, idx)
    if idx == 0 then
        LabScientificLineCtrl.researchEmptyBtn = LabScrollEmptyBtn:new(transform, function ()
            --打开研究选择界面
            ct.log("cycle_w15_laboratory03", "打开研究选择界面")
        end)
        return
    end

    idx = idx + 1
    local item = LabResearchLineItem:new(LabScientificLineCtrl.researchInfoData[idx], transform)
    LabScientificLineCtrl.researchItems[idx] = item
end
LabScientificLineCtrl.static.researchClearData = function(transform)
end
--发明
LabScientificLineCtrl.static.inventionProvideData = function(transform, idx)
    if idx == 0 then
        LabScientificLineCtrl.inventionEmptyBtn = LabScrollEmptyBtn:new(transform, function ()
            --打开研究选择界面
            ct.log("cycle_w13_laboratory", "打开发明选择界面")
        end)
        return
    end

    idx = idx + 1
    local item = LabInventionLineItem:new(LabScientificLineCtrl.inventionInfoData[idx], transform)
    LabScientificLineCtrl.inventionItems[idx] = item
end
LabScientificLineCtrl.static.inventionClearData = function(transform)
end

---刷新数据
--研究
function LabScientificLineCtrl:_onReceiveLabResearchData(datas)
    local researchInfoData = BaseTools.TableCopy(datas)
    local researchPrefabList = {}
    for i, item in pairs(researchInfoData) do
        researchPrefabList[i] = LabScientificLineCtrl.static.LabResearchItemPath
    end
    --预留第一个数据给按钮
    table.insert(researchInfoData, 1, {})
    table.insert(researchPrefabList, 1, LabScientificLineCtrl.static.EmptyBtnPath)

    LabScientificLineCtrl.researchInfoData = researchInfoData
    LabScientificLinePanel.researchScroll:ActiveDiffItemLoop(self.researchSource, researchPrefabList)
end
--发明
function LabScientificLineCtrl:c_onReceiveLabInventionData(datas)
    local inventionInfoData = BaseTools.TableCopy(datas)
    local inventionPrefabList = {}
    for i, item in pairs(inventionInfoData) do
        inventionPrefabList[i] = LabScientificLineCtrl.static.LabInventionItemPath
    end
    --预留第一个数据给按钮
    table.insert(inventionInfoData, 1, {})
    table.insert(inventionPrefabList, 1, LabScientificLineCtrl.static.EmptyBtnPath)

    LabScientificLineCtrl.inventionInfoData = inventionInfoData
    LabScientificLinePanel.inventionScroll:ActiveDiffItemLoop(self.inventionSource, inventionPrefabList)
end

--客户端创建一个新的line，还未开工
function LabScientificLineCtrl:_addScientificLineCilent(lineItem)
    self.tempLine = lineItem
    --记录一个当前正在处理的item，self.tempLine
    --判断，如果self。tempLine不为空，则激活小弹窗
    if lineItem.type == 0 then
        --在最前面插入一个数据，包含buildingId，itemId，以及phase
        --然后在UI上根据type选择是哪个界面，研究还是发明，然后刷新Scroll
    elseif lineItem.type == 1 then

    end
    self.isNewLine = true
    self:_startSetStaffCount(lineItem)
end
--收到LabLineAdd回调
function LabScientificLineCtrl:_onReceiveLabAddLine(lineData)
    if lineData.itemId == self.tempLine.itemId then
        Event.Brocast("m_ReqLabLaunchLine", lineData.buildingId, lineData.lineId, self.tempLine.phase)
        self.isNewLine = false
    end
end

---提示框部分
--打开弹框
function LabScientificLineCtrl:_showSetStaffTip(lineItem)
    self.tempLine = lineItem

    LabScientificLinePanel.showNewLineStaffTip(lineItem.viewRect)
end
--点击弹窗以外的地方，关闭弹窗，不改变员工数量
function LabScientificLineCtrl:_cancelChangeStaffCount()
    LabScientificLinePanel.changeStaffCountBtn.transform.localScale = Vector3.zero
end
--点击确认按钮，向服务器发送消息
function LabScientificLineCtrl:_sureChangeStaffCount()
    local staffCount = tonumber(LabScientificLinePanel.staffText.text)
    if staffCount <= 0 then
        return
    end

    if self.isNewLine then
        Event.Brocast("m_ReqAddLine", self.buildingId, self.tempLine.itemId, self.tempLine.type, staffCount)  --如果是新添加的线，则发送addLine
    else
        Event.Brocast("m_ReqSetWorkerNum", self.buildingId, self.tempLine.lineId, staffCount)  --一般的改变员工，则需要发送setWorkerNum
    end

    LabScientificLinePanel.changeStaffCountBtn.transform.localScale = Vector3.zero
end
--slider 值改变时的监听
function LabScientificLineCtrl:_onStaffSliderValueChange(value)
    LabScientificLinePanel.staffText.text = value
end