---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by password.
--- DateTime: 2019/3/29 10:28
---推广公司ctrl
DataType = {
    DataBase = 1,
    DataSurvey = 2,
    DataSale = 3,
}
Shelf = {
    AddShelf = 1,
    SetShelf = 2,
}
DataCompanyCtrl = class('DataCompanyCtrl',UIPanel)
UIPanel:ResgisterOpen(DataCompanyCtrl)

local promoteBehaviour
local myOwnerID
function DataCompanyCtrl:bundleName()
    return "Assets/CityGame/Resources/View/DataCompanyPanel.prefab"
end

function DataCompanyCtrl:initialize()
    UIPanel.initialize(self,UIType.Normal,UIMode.HideOther,UICollider.None)--可以回退，UI打开后，隐藏其它面板
    --UIPanel.initialize(self,UIType.PopUp,UIMode.NeedBack,UICollider.None)--可以回退，UI打开后，不隐藏其它的UI
end

function DataCompanyCtrl:Awake()
    promoteBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    --promoteBehaviour:AddClick(DataCompanyPanel.back,self.OnBack,self)
    --promoteBehaviour:AddClick(DataCompanyPanel.queue,self.OnQueue,self)
    promoteBehaviour:AddClick(DataCompanyPanel.open,self.OnOpen,self)
    self:initData()
    myOwnerID = DataManager.GetMyOwnerID()      --自己的唯一id
end

function DataCompanyCtrl:Active()
    UIPanel.Active(self)
    Event.AddListener("c_Revenue",self.c_Revenue,self)
end

function DataCompanyCtrl:Refresh()
    DataManager.OpenDetailModel(DataCompanyModel,self.m_data.insId)
    RevenueDetailsMsg.m_getPrivateBuildingCommonInfo(self.m_data.insId)
    DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_detailPublicFacility',self.m_data.insId)
end

function DataCompanyCtrl:Hide()
    UIPanel.Hide(self)
    Event.RemoveListener("c_Revenue",self.c_Revenue,self)
    RevenueDetailsMsg.close()
end

function DataCompanyCtrl:Close()
    UIPanel.Close(self)
    if self.groupMgr ~= nil then
        self.groupMgr:Destroy()
        self.groupMgr = nil
    end
end

function DataCompanyCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end

function DataCompanyCtrl:initData()

end

--返回
function DataCompanyCtrl:OnBack()
    UIPanel.ClosePage()
    DataManager.CloseDetailModel(self.m_data.insId)
    if self.groupMgr ~= nil then
        self.groupMgr:Destroy()
        self.groupMgr = nil
    end
end

--建筑个性签名
function DataCompanyCtrl:OnOpen(go)
    PlayMusEff(1002)
    ct.OpenCtrl("BubbleMessageCtrl",go.m_data.info)
end

--建筑详情回调
function DataCompanyCtrl:_receivePromoteCompanyDetailInfo(detailData)
    detailData.info.buildingType = BuildingType.Municipal
    if DataCompanyPanel.topItem ~= nil then
        DataCompanyPanel.topItem:refreshData(detailData.info, function ()
            self:OnBack(self)
        end)
    end
    local insId = self.m_data.insId
    self.m_data = detailData
    self.m_data.insId = insId  --temp
    if self.groupMgr == nil then
        if detailData.info.state == "OPERATE" then -- 营业中
            self.groupMgr = BuildingInfoMainGroupMgr:new(DataCompanyPanel.groupTrans, promoteBehaviour)
            if self.m_data.info.ownerId == myOwnerID then
                self.groupMgr:AddParts(DataSalePart, 0.24)
                self.groupMgr:AddParts(TurnoverPart, 0.19)
                self.groupMgr:AddParts(BuildingSalaryPart, 0.19)
                self.groupMgr:AddParts(DataSurveyPart, 0.19)
                self.groupMgr:AddParts(DataBasePart, 0.19)
                --self.groupMgr:AddParts(AdBuildingSignPart, 0.24)
                DataCompanyPanel.open.transform.localScale = Vector3.one
            else
                self.groupMgr:AddParts(DataSalePart, 1)
                self.groupMgr:AddParts(TurnoverPart, 0)
                self.groupMgr:AddParts(BuildingSalaryPart, 0)
                self.groupMgr:AddParts(DataSurveyPart, 0)
                self.groupMgr:AddParts(DataBasePart, 0)
                --self.groupMgr:AddParts(AdBuildingSignPart, 0.24)
                DataCompanyPanel.open.transform.localScale = Vector3.zero
            end
            DataCompanyPanel.groupTrans.localScale = Vector3.one
            self.groupMgr:RefreshData(self.m_data)
            self.groupMgr:TurnOffAllOptions()
        else -- 未营业
            DataCompanyPanel.groupTrans.localScale = Vector3.zero
            DataCompanyPanel.open.transform.localScale = Vector3.zero
        end
    else

        self.groupMgr:RefreshData(self.m_data)
    end
    DataCompanyPanel.openBusinessItem:initData(detailData.info,BuildingType.Municipal)      --开业
    --历史记录测试
    UnitTest.Exec_now("abel_0426_AbilityHistory", "e_AbilityHistory",self.m_data.insId)
    --人流量签约列表测试
    UnitTest.Exec_now("abel_0428_queryflowList", "e_queryflowList",self.m_data.insId)
end

--推广能力回调
function DataCompanyCtrl:_queryPromoCurAbilitys(info)
    if info.CurAbilitys == nil then
        return
    end
    for i, v in pairs(info.CurAbilitys) do
        GoodsTypeConfig[i].capacity = v
    end
    if info.typeIds[1] == 1300 or info.typeIds[1] == 1400 then
        Event.Brocast("c_PromoteBuildingCapacity",info.CurAbilitys)
        return
    else
      Event.Brocast(" ")
    end
end

--获取推广能力回调
function DataCompanyCtrl:_queryPromoCurItemInfo(info)
    if info.items == nil then
        return
    end
    GoodsTypeConfig[1].brand = {}
    GoodsTypeConfig[2].brand = {}
    for i, v in pairs(info.items) do
        if math.floor(v.itemId/1000) == 2251 then
            GoodsTypeConfig[1].brand[v.itemId] = {}
            GoodsTypeConfig[1].brand[v.itemId].brand = v.brand
            GoodsTypeConfig[1].brand[v.itemId].brandScore = v.brandScore
        elseif math.floor(v.itemId/1000) == 2252 then
            GoodsTypeConfig[2].brand[v.itemId] = {}
            GoodsTypeConfig[2].brand[v.itemId].brand = v.brand
            GoodsTypeConfig[2].brand[v.itemId].brandScore = v.brandScore
        end
    end
end

--员工工资改变
function DataCompanyCtrl:_refreshSalary(data)
    if self.m_data ~= nil then
        if self.m_data.info.state == "OPERATE" then
            Event.Brocast("SmallPop", GetLanguage(26020007), 300)
        end
        self.m_data.info.salary = data.Salary
        self.m_data.info.setSalaryTs = data.ts

        if self.groupMgr == nil then
            self.groupMgr = BuildingInfoMainGroupMgr:new(DataCompanyPanel.groupTrans, promoteBehaviour)
            self.groupMgr:AddParts(DataSalePart, 0.24)
            self.groupMgr:AddParts(TurnoverPart, 0.19)
            self.groupMgr:AddParts(BuildingSalaryPart, 0.19)
            self.groupMgr:AddParts(DataSurveyPart, 0.19)
            self.groupMgr:AddParts(DataBasePart, 0.19)
            --self.groupMgr:AddParts(AdBuildingSignPart, 0.23)
            DataCompanyPanel.groupTrans.localScale = Vector3.one
            DataCompanyPanel.open.transform.localScale = Vector3.one
            self.groupMgr:TurnOffAllOptions()
        end
        self.groupMgr:RefreshData(self.m_data)
    end
end

--今日营业额
function DataCompanyCtrl:c_Revenue(info)
    TurnoverPart:_initFunc(info)
    TurnoverDetailPart:_setValue(info)
end
