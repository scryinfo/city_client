---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2019/7/22 16:57
---

ResearchInstituteCtrl = class("ResearchInstituteCtrl", UIPanel)
ResearchInstituteCtrl:ResgisterOpen(ResearchInstituteCtrl)

function ResearchInstituteCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function ResearchInstituteCtrl:bundleName()
    return "Assets/CityGame/Resources/View/ResearchInstitutePanel.prefab"
end

function ResearchInstituteCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function ResearchInstituteCtrl:Awake(go)
    self.researchluaBehaviour = self.gameObject:GetComponent("LuaBehaviour")

    self.researchluaBehaviour:AddClick(ResearchInstitutePanel.bubbleMessageBtn.gameObject, self.OpenBubbleMessage, self)
end

function ResearchInstituteCtrl:Active()
    UIPanel.Active(self)
    Event.AddListener("c_Revenue",self.c_Revenue,self)
end

function ResearchInstituteCtrl:Refresh()
    self:initializeData()
end

function ResearchInstituteCtrl:Hide()
    UIPanel.Hide(self)
    Event.RemoveListener("c_Revenue",self.c_Revenue,self)
    RevenueDetailsMsg.close()
end

---------------------------------------Network callback---------------------------------------
--Enter to search for building information
function ResearchInstituteCtrl:initializeData()
    if self.m_data then
        --Request building details from the server
        DataManager.OpenDetailModel(ResearchInstituteModel,self.m_data.insId)
        RevenueDetailsMsg.m_getPrivateBuildingCommonInfo(self.m_data.insId)
        DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqOpenTechnology',self.m_data.insId)
    end
end

-- Receiving the callback, refreshing the research information
function ResearchInstituteCtrl:_receiveDetailTechnology(researchDataInfo)
    -- Open
    ResearchInstitutePanel.openBusinessItem:initData(researchDataInfo.info, BuildingType.Laboratory)
    researchDataInfo.insId = self.m_data.insId
    -- Building top components
    researchDataInfo.info.buildingType = BuildingType.Laboratory
    if ResearchInstitutePanel.topItem ~= nil then
        ResearchInstitutePanel.topItem:refreshData(researchDataInfo.info, function ()
            self:_clickCloseBtn(self)
        end)
    end

    -- Determine whether it is the opening state, whether you open the corresponding display different interface, and the status of the bubble button
    if researchDataInfo.info.state == "OPERATE" then
        ResearchInstitutePanel.groupTrans.localScale = Vector3.one
        if researchDataInfo.info.ownerId ~= DataManager.GetMyOwnerID() then -- others
            ResearchInstitutePanel.bubbleMessageBtn.localScale = Vector3.one
            if self.groupMgr == nil then
                self.groupMgr = BuildingInfoMainGroupMgr:new(ResearchInstitutePanel.groupTrans, self.researchluaBehaviour)
                self.groupMgr:AddParts(ResearchSalePart, 1)
                self.groupMgr:AddParts(TurnoverPart, 0)
                self.groupMgr:AddParts(BuildingSalaryPart, 0)
                self.groupMgr:AddParts(ResearchEvaPart, 0)
                self.groupMgr:AddParts(ResearchDatabasePart, 0)
                self.groupMgr:RefreshData(researchDataInfo)
                self.groupMgr:TurnOffAllOptions()
            end
        else -- self
            ResearchInstitutePanel.bubbleMessageBtn.localScale = Vector3.zero
            if self.groupMgr == nil then
                self.groupMgr = BuildingInfoMainGroupMgr:new(ResearchInstitutePanel.groupTrans, self.researchluaBehaviour)
                self.groupMgr:AddParts(ResearchSalePart, 0.2)
                self.groupMgr:AddParts(TurnoverPart, 0.2)
                self.groupMgr:AddParts(BuildingSalaryPart, 0.2)
                self.groupMgr:AddParts(ResearchEvaPart, 0.2)
                self.groupMgr:AddParts(ResearchDatabasePart, 0.2)
                self.groupMgr:RefreshData(researchDataInfo)
                self.groupMgr:TurnOffAllOptions()
            else
                self.groupMgr:RefreshData(researchDataInfo)
            end
        end
    else
        ResearchInstitutePanel.groupTrans.localScale = Vector3.zero
        ResearchInstitutePanel.bubbleMessageBtn.localScale = Vector3.zero
    end
end

-------------------------------------Button click event-------------------------------------
function ResearchInstituteCtrl:OpenBubbleMessage(go)
    PlayMusEff(1002)
    if go.m_data.info.id then
        ct.OpenCtrl("BubbleMessageCtrl", go.m_data.info)
    end
end

function ResearchInstituteCtrl:_clickCloseBtn()
    PlayMusEff(1002)
    if self.groupMgr ~= nil then
        self.groupMgr:TurnOffAllOptions()
        self.groupMgr:Destroy()
        self.groupMgr = nil
    end
    DataManager.CloseDetailModel(self.m_data.insId)
    self.m_data = nil
    UIPanel.ClosePage()
end

--Today's turnover
function ResearchInstituteCtrl:c_Revenue(info)
    TurnoverPart:_initFunc(info)
    TurnoverDetailPart:_setValue(info)
end