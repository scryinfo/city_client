---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by cyz_scry.
--- DateTime: 2018/8/21 11:05
---
package.path = package.path .. ';./Assets/CityGame/Lua/test/?.lua'
package.path = package.path .. ';./Assets/CityGame/Lua/test/pbl/?.lua'

local lu = require "Framework/pbl/luaunit"
--local eq       = lu.assertEquals
--require("protobuf.encoder")
--require("protobuf.decoder")
--require ("pb.as_pb")
--require ("pb.asCode_pb")
--require ("pb.person_pb")
--require ("test/pbl/pbl_test")
--require (".\\..\\test\\pbl\\pbl_test")
require ("pbl_test")
require ("test/test_BaseOO")
require ("test/test_Mixins")

local pb = pbl
local serpent = require("Framework/pbl/serpent")
local protoc = require "Framework/pbl/protoc"
protoc:addpath("./Assets/CityGame/Lua/pb")

function _G.test_pb()
    local msglogion = pb.as.Login()
    msglogion.account = this.username
    local pb_login = msglogion:SerializeToString()  -- Parse Example
    local pb_size = #pb_login
    print("cz login create:", msglogion.account, " size = ", tostring(#pb_login))

    local msglogion1 = pb.as.Login()
    msglogion1:ParseFromString(pb_login)
    print("cz login parser:", msglogion1.account)

    --local msg = pb.person_pb.Person();
    --msg.id = 100;
    --msg.name = "foo";
    --msg.email = "bar";
    --local pb_data = msg:SerializeToString();  -- Parse Example
    --print("cz create:", msg.id, msg.name, msg.email, pb_data);
    --local msg1 = pb.person_pb.Person();

end

function _G.test_oo()
    local p0 = Person:new('Man01', 30)
    p0:speak()
    local p1 = AgedPerson:new('Billy the Kid', 13) -- this is equivalent to AgedPerson('Billy the Kid', 13) - the :new part is implicit
    local p2 = AgedPerson:new('Luke Skywalker', 21)
    p1:speak()
    p2:speak()
end

function _G.test_OO_Mixins()
    local bee = Bee() -- or Bee:new()
    local bat = Bat() -- or Bat:new()
    bee:fly()
    bat:fly()
end

local function check_load(chunk, name)
    local pbdata = protoc.new():compile(chunk, name)
    local ret, offset = pb.load(pbdata)
    if not ret then
        error("load error at "..offset..
                "\nproto: "..chunk..
                "\ndata: "..buffer(pbdata):tohex())
    end
end

function _G.test_pbl()
    local Login = { -- 我们定义一个addressbook里的 Person 消息
        account = "Alice"
    }

    -- 序列化成二进制数据
    local data = assert(pb.encode("as.Login", Login))

    -- 从二进制数据解析出实际消息
    local msg = { -- 我们定义一个addressbook里的 Person 消息

    }
    msg = assert(pb.decode("as.Login", data))

    -- 打印消息内容（使用了serpent开源库）
    --print(serpent.block(msg))

    check_load [[
      package ascode;
      enum Color {
         Red = 0;
         Green = 1;
         Blue = 2;
      }
      message TestEnum {
         optional Color color  = 1;
      } ]]
    local test =  pb.enum("ascode.Color", "Red")

    local val = pb.enum("ascode.OpCode", "login")

    --eq(pb.enum("ascode.OpCode", 0), "login")
    --eq(pb.enum("ascode.OpCode", "choseGameServer"), 1)
    --eq(pb.enum("ascode.OpCode", "getServerList"), 2)

    --print(serpent.block(msg))
    --
end
function _G.test_pbl()
    assert(protoc:load [[
    message Phone {
      optional string name        = 1;
      optional int64  phonenumber = 2;
    }
    message Person {
      optional string name     = 1;
      optional int32  age      = 2;
      optional string address  = 3;
      repeated Phone  contacts = 4;
    } ]])

    local data = {
        name = "ilse",
        age  = 18,
        contacts = {
            { name = "alice", phonenumber = 12312341234 },
            { name = "bob",   phonenumber = 45645674567 }
        }
    }

    local bytes = assert(pb.encode("Person", data))
    print(pbl.tohex(bytes))

    local data2 = assert(pb.decode("Person", bytes))
    print(require "Framework/pbl/serpent".block(data2))
end

function _G.test_pbl()
    --pbl_protoTest()
    --test_packed()
    --test_default()
    --test_extend()
    --test_type()
    --test_enum()
    --test_load()
    --test_slice()
    --test_buffer()
    --test_conv()
    --test_oneof()
    --test_map()
end

lu.LuaUnit.run()