---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2019/3/5 15:50
---小地图气泡管理
MapBubbleManager= {}
local this = MapBubbleManager
local prefabPools = {}

local MapBuildingItemName = "MapBuildingItem"
local MapSearchResultItemName = "MapSearchResultItem"
local MapAllSearchItemName = "MapAllSearchItem"

MapBubbleManager.TempBuildingIconPath =
{
    House = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-HomeHouse.png",
    MaterialFactory = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-Material.png",
    Municipal = "",
    MunicipalManage = "",
    ProcessingFactory = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-Fatory.png",
    Laboratory = "",
    RetailShop = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-SuperMarket.png",
    TalentCenter = "",
}

function MapBubbleManager.initMapSetting(itemWidth)
    this.itemWidth = itemWidth
    this.itemDelta = Vector2.New(itemWidth, itemWidth)
    this.selfBuildings = {}

    prefabPools[MapBuildingItemName] = LuaGameObjectPool:new(MapBuildingItemName, MapPanel.mapBuildingItem, 5, Vector3.New(-999,-999,-999))
    prefabPools[MapSearchResultItemName] = LuaGameObjectPool:new(MapSearchResultItemName, MapPanel.mapSearchResultItem, 5, Vector3.New(-999,-999,-999))
    prefabPools[MapAllSearchItemName] = LuaGameObjectPool:new(MapAllSearchItemName, MapPanel.mapAllSearchItem, 5, Vector3.New(-999,-999,-999))
end

--创建系统建筑，暂时只有中心建筑
function MapBubbleManager.createSystemItem()
    local obj = UnityEngine.GameObject.Instantiate(MapPanel.mapSystemItem, MapPanel.alwaysShowRoot)
    obj.transform:SetParent(MapPanel.alwaysShowRoot.transform)
    local item = MapSystemItem:new({tempPath = ""}, obj.transform)
    local pos = Vector2.New(TerrainConfig.CentralBuilding.CenterNodePos.z ,- TerrainConfig.CentralBuilding.CenterNodePos.x ) * this.itemWidth
    local delta = this.itemDelta * PlayerBuildingBaseData[TerrainConfig.CentralBuilding.BuildingType].x
    item:setScaleAndPos(Vector3.one, pos, delta)
    this.centerItem = item

    --local objRect = obj:GetComponent("RectTransform")
    --local rectPos =
    --objRect.anchoredPosition = rectPos * this.itemWidth
    ----objRect.sizeDelta = this.itemDelta *  PlayerBuildingBaseData[TerrainConfig.CentralBuilding.BuildingType].x
    --rectPos.y = - rectPos.y
end
--
function MapBubbleManager.initItemData()
    --根据配置表生成建筑Items
    local MyBuild = DataManager.GetMyAllBuildingDetail()
    --生成住宅
    if MyBuild.apartment ~= nil then
        this._createBuildingItems(MyBuild.apartment, BuildingType.House)
    end
    --生成原料厂
    if MyBuild.materialFactory ~= nil then
        this._createBuildingItems(MyBuild.materialFactory, BuildingType.MaterialFactory)
    end
    --生成加工厂
    if MyBuild.produceDepartment ~= nil then
        this._createBuildingItems(MyBuild.produceDepartment, BuildingType.ProcessingFactory)
    end
    --生成零售店
    if MyBuild.retailShop ~= nil then
        this._createBuildingItems(MyBuild.retailShop, BuildingType.RetailShop)
    end
end
--
function MapBubbleManager._createBuildingItems(itemDatas, buildingType)
    for key, value in pairs(itemDatas) do
        if value.info ~= nil and value.info.pos ~= nil and value.info.pos.x ~= nil and value.info.pos.y ~= nil and value.info.mId ~= nil and PlayerBuildingBaseData[value.info.mId] ~= nil and PlayerBuildingBaseData[value.info.mId].x ~= nil  then
            local obj = UnityEngine.GameObject.Instantiate(MapPanel.mapBuildingItem)
            obj.transform:SetParent(MapPanel.alwaysShowRoot.transform)
            obj.transform.localPosition = Vector3.zero
            local item = MapBuildingItem:new({tempPath = this._getBuildingIconPath(buildingType), poolName = MapBuildingItemName}, obj.transform)
            this.selfBuildings[value.info.id] = item
            local pos = Vector2.New( value.info.pos.y, - value.info.pos.x) * this.itemWidth
            local delta = this.itemDelta *  PlayerBuildingBaseData[value.info.mId].x
            item:setScaleAndPos(Vector3.one, pos, delta)
        end
    end
end
--获取正确的icon路径
function MapBubbleManager._getBuildingIconPath(buildingType)
    local path
    if buildingType == BuildingType.House then
        path = this.TempBuildingIconPath.House
    elseif buildingType == BuildingType.MaterialFactory then
        path = this.TempBuildingIconPath.MaterialFactory
    elseif buildingType == BuildingType.Municipal then
        path = this.TempBuildingIconPath.Municipal
    elseif buildingType == BuildingType.MunicipalManage then
        path = this.TempBuildingIconPath.MunicipalManage
    elseif buildingType == BuildingType.TalentCenter then
        path = this.TempBuildingIconPath.TalentCenter
    elseif buildingType == BuildingType.ProcessingFactory then
        path = this.TempBuildingIconPath.ProcessingFactory
    elseif buildingType == BuildingType.RetailShop then
        path = this.TempBuildingIconPath.RetailShop
    elseif buildingType == BuildingType.Laboratory then
        path = this.TempBuildingIconPath.Laboratory
    end
    return path
end
--
function MapBubbleManager.toggleShowDetailBuilding(show)
    if show == nil then
        return
    end
    if this.centerItem ~= nil then
        this.centerItem:toggleShowDetailImg(show)
    end
    if this.selfBuildings ~= nil then
        for i, value in pairs(this.selfBuildings) do
            value:toggleShowDetailImg(show)
        end
    end
end
--回收
function MapBubbleManager.recyclingObjToPool(poolName, go)
    if prefabPools[poolName] ~= nil and go ~= nil then
        prefabPools[poolName]:RecyclingGameObjectToPool(go.gameObject)
    end
end
--清除item
function MapBubbleManager.cleanItems()
    if this.selfBuildings ~= nil then
        for i, value in pairs(this.selfBuildings) do
            value:close()
            value = nil
        end
    end
end