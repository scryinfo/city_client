---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/2/18/018 12:01
---


AvtarCtrl = class('AvtarCtrl',UIPanel)
UIPanel:ResgisterOpen(AvtarCtrl) --注册打开的方法

local panel
local LuaBehaviour;
local this
local headPrefab={}
local currHead

local fiveItemPath="View/AvtarItems/fiveItem"
local kindItemPath="View/AvtarItems/kindItem"

FiveType={
  head=1,
  body=2,
  brow=3,
  eyes=4,
  haircut=5,
  frontHat=6,
  mouth=7,
  nose=8,
  goatee=9,
  decal=10,
}

---==========================================================================================框架函数============================================================================================

function  AvtarCtrl:bundleName()
    return "Assets/CityGame/Resources/View/AvtarPanel.prefab"
end

function AvtarCtrl:initialize()
    UIPanel.initialize(self,UIType.Normal,UIMode.HideOther,UICollider.None)--可以回退，UI打开后，隐藏其它面板
end

function AvtarCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end

function AvtarCtrl:Active()

end

function AvtarCtrl:Refresh()

end

function  AvtarCtrl:Hide()
    UIPanel.Hide(self)
end

function AvtarCtrl:Close()
    UIPanel.Close(self)
end

function  AvtarCtrl:Awake(go)
    self.gameObject = go
    this=self
    panel=AvtarPanel
    LuaBehaviour = self.gameObject:GetComponent('LuaBehaviour');
    LuaBehaviour:AddClick(panel.backBtn.gameObject,self.c_OnClick_backBtn,self);
    LuaBehaviour:AddClick(panel.cofirmBtn.gameObject,self.c_OnClick_confirm,self);
    LuaBehaviour:AddClick(panel.randomBtn.gameObject,self.c_OnClick_randomChange,self);
    LuaBehaviour:AddClick(panel.maleBtn.gameObject,self.c_OnClick_male,self);
    LuaBehaviour:AddClick(panel.feMaleBtn.gameObject,self.c_OnClick_faMale,self);

    self:begin()

end

---==========================================================================================业务代码===================================================================================================
local appearance={}
local pool={}
local sex
--临时对象池是做法
local  function InsAndObjectPool(config,class,prefabPath,parent,this)
    if not pool[class] then
        pool[class]={}
    end
    --对象池创建物体
    local tempList={}
    for i, value in ipairs(config) do
        local ins =pool[class][1]
        if ins then  --有实例
            value.id=i
            ins:updateData(value)
            ins.prefab:SetActive(true)
            table.insert(tempList,ins)
            table.remove(pool[class],1)
        else--无实例
            local prefab=creatGoods(prefabPath,parent)
            value.id=i
            local ins=class:new(prefab,LuaBehaviour,value,this)
            table.insert(tempList,ins)
        end
    end
    --多余实例隐藏
    if #pool[class]>0 then
        for key, ins in ipairs(pool[class]) do
            ins.prefab:SetActive(false)
            table.insert(tempList,ins)
            pool[class][key]=nil
        end
    end
    --所有实例归还对象池
    for i, ins in ipairs(tempList) do
        table.insert(pool[class],ins)
    end
end

local function FindOrgan(transform)
    if not appearance["body"] then
        appearance["body"]={}
        appearance["backHat"]={}
        appearance["head"]={}
        appearance["haircut"]={}
        appearance["nose"]={}
        appearance["brow"]={}
        appearance["frontHat"]={}
        appearance["eyes"]={}
        appearance["mouth"]={}
        appearance["decal"]={}
        appearance["goatee"]={}
    end

    appearance["body"].ima=transform:Find("body"):GetComponent("Image")
    appearance["backHat"].ima=transform:Find("backHat"):GetComponent("Image")
    appearance["head"].ima=transform:Find("head"):GetComponent("Image")
    appearance["haircut"].ima=transform:Find("hair"):GetComponent("Image")
    appearance["nose"].ima=transform:Find("nose"):GetComponent("Image")
    appearance["brow"].ima=transform:Find("brow"):GetComponent("Image")
    appearance["frontHat"].ima=transform:Find("frontHat"):GetComponent("Image")
    appearance["eyes"].ima=transform:Find("eyes"):GetComponent("Image")
    appearance["mouth"].ima=transform:Find("mouth"):GetComponent("Image")

    appearance["decal"].ima=transform:Find("decal")
    appearance["goatee"].ima=transform:Find("goatee")

    if appearance["decal"].ima then
        appearance["decal"].ima=transform:Find("decal"):GetComponent("Image")
        appearance["goatee"].ima=transform:Find("goatee"):GetComponent("Image")
    end

end

function AvtarCtrl:begin()
    sex=1
    self:randomChange()
    self:switchKinds(AvtarConfig.man[1].kinds)
    InsAndObjectPool(AvtarConfig.man,FiveFaceItem,fiveItemPath,panel.fiveContent,self)
end

function AvtarCtrl:switchKinds(config)
    InsAndObjectPool(config,KindsItem,kindItemPath,panel.kindsContent,self)
end

local num
function AvtarCtrl:randomChange()

    for i, qiGuan in ipairs(AvtarConfig.man) do
        num =math.random(1,#qiGuan.kinds)
        self:changAparance(AvtarConfig.man[i].kinds[num])
    end

end

local pastApperanceID={}

function AvtarCtrl:changAparance(data)
    local arr,path,type,nums
    arr=split(data.path,",")
    path=arr[1]
    type=arr[2]

    nums=data.id or num
    --特殊处理头和帽子
    if type=="head" then

        --已有的隐藏
        if currHead then
            currHead:SetActive(false)
        end
        --避免重复生成
        if headPrefab[nums] then
            headPrefab[nums]:SetActive(true)
        else
            headPrefab[nums]=creatGoods(HeadConfig.man[nums].path,panel.showContent)
        end

        currHead=headPrefab[nums]
        FindOrgan(headPrefab[nums].transform)

        --加载原来服饰
        for key, value in pairs(appearance) do
            if key ~= "head" and    pastApperanceID[key] then
                LoadSprite(pastApperanceID[key].path,appearance[key].ima)
                if key=="frontHat" then
                    LoadSprite(pastApperanceID["backHat"].path,appearance["backHat"].ima)
                end
            end
        end

    elseif type=="frontHat" then
        LoadSprite(arr[3],appearance[arr[4]].ima)
        pastApperanceID["backHat"]={}
        pastApperanceID["backHat"].path=arr[3]
    end

    appearance[type].typeId=nums
    appearance[type].type=type

    if not pastApperanceID[type] then
        pastApperanceID[type]={}
    end

    pastApperanceID[type].path=path

    LoadSprite(path,appearance[type].ima)
end




---==========================================================================================点击函数===================================================================================================
--返回
function AvtarCtrl:c_OnClick_backBtn(ins)
    ins:Hide()
end

--确定
function AvtarCtrl:c_OnClick_confirm()
   local faceId,type,typeId=""
    for key, value in pairs(appearance) do
        if value.typeId then
            type=tostring(FiveType[key])
            typeId=tostring(value.typeId)
            faceId=faceId..type..","..typeId..","
        end
    end
    faceId=tostring(sex).."-"..faceId

    if sex==1 then
        ct.OpenCtrl("CreateRoleCtrl",faceId,true)
    else
        ct.OpenCtrl("CreateRoleCtrl",faceId,false)
    end
end

--随机
function AvtarCtrl:c_OnClick_randomChange(ins)
    ins:randomChange()
end

--男性
function AvtarCtrl:c_OnClick_male(ins)
    panel.feMaleSelect.localScale=Vector3.zero
    panel.maleSelect.localScale=Vector3.one
    InsAndObjectPool(AvtarConfig.man,FiveFaceItem,fiveItemPath,panel.fiveContent,self)
    sex=1
end

--女性
function AvtarCtrl:c_OnClick_faMale(ins)
    panel.feMaleSelect.localScale=Vector3.one
    panel.maleSelect.localScale=Vector3.zero
    InsAndObjectPool(AvtarConfig.woMan,FiveFaceItem,fiveItemPath,panel.fiveContent,self)
    sex=2
end







