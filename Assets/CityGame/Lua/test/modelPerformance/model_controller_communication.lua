---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by cyz_scry.
--- DateTime: 2018/12/1 10:21
---
UnitTest.TestBlockStart()---------------------------------------------------------
--定义一个model基类
local ModelBase = class('ModelBase')
local ControllerBase = class('ControllerBase')

local tempCtrlList = {}
local test_count = 10000

function ModelBase:initialize(name)
    self.name = name
end

function ControllerBase:initialize(name, newInsId)
    self.name = name
    self.insId = newInsId
end

--model类{
Model_1 = class('Model_1',ModelBase)
function Model_1:testfun(arg_int1, arg_int2)
    --ct.log("wk16_abel_controller_model", "[Model_1:testfun] invoked!")
    return #self.name+arg_int1+arg_int2
end

Model_2 = class('Model_2',ModelBase)
function Model_2:testfun(arg_str)
    --ct.log("wk16_abel_controller_model", "[Model_2:testfun] invoked!")
    return self.name..arg_str
end
--model类}

--model管理器类{
ModelManager = class('ModelManager')
local modelList = {}
local tempMd = nil
local tempArgs = {}
function ModelManager:initialize()
    modelList = {}
end
function ModelManager:addModel(model)
    modelList[#modelList+1] = model
end

function ModelManager:getModel(pos)
    return modelList[pos]
end

function ModelManager.modelRpc(insId, modelMethord, ...)
    local arg = {...}
    --优化版本
    local md = modelList[insId]
    arg[#arg](md[modelMethord](md,...))
end
--最后一个参数必须是函数或者nil
function ModelManager.modelRpc1(insId, modelMethord, ...)
    local arg = {...}
    --优化版本
    arg[#arg](modelList[insId][modelMethord](modelList[insId],...))

    --严格版本
    --local md = modelList[insId]
    --if md ~= nil then
    --    assert(md, 'model not exist which instance id = ',insId)
    --    assert(md[modelMethord], 'Methord: '..modelMethord..' not exist,model instance id = '..insId)
    --    --if not md then
    --    --    ct.log( 'system','model not exist which instance id = ',insId)
    --    --    return
    --    --end
    --    --if not md[modelMethord] then
    --    --    ct.log( 'system','Methord: '..modelMethord..' not exist,model instance id = '..insId)
    --    --    return
    --    --end
    --
    --    local ret = md[modelMethord](md,...)
    --    if arg[#arg] ~= nil then
    --        arg[#arg](ret)
    --    end
    --end
end

function ModelManager.modelRpc2(insId, modelMethord, ...)
    tempArgs = {...}
    --优化版本
    tempMd = modelList[insId]
    tempArgs[#tempArgs](tempMd[modelMethord](tempMd,...))
    tempMd = nil
    tempArgs = {}
end

--全局方法
--function ct.model_rpc(insId, modelMethord, callback, ...)
function ct.model_rpc(insId, modelMethord, ...)
    ModelManager.modelRpc(insId, modelMethord, ...)
end

function ct.model_rpc1(insId, modelMethord, ...)
    ModelManager.modelRpc1(insId, modelMethord, ...)
end

function ct.model_rpc2(insId, modelMethord, ...)
    ModelManager.modelRpc2(insId, modelMethord, ...)
end
--model管理器类}

--controller类{
Ctrl_1 = class('Crtl_1',ControllerBase)
function Ctrl_1:initialize(name, newInsId)
    ControllerBase.initialize(self, name,newInsId)
end
function Ctrl_1:reqDatafun(arg_int1, arg_int2)
    local pRetvalue = nil
    ct.model_rpc(self.insId, 'testfun', arg_int1, arg_int2,function (retvalue)
        --ct.log('wk16_abel_controller_model', '[Crtl_1:reqDatafun] return: '..retvalue)
        pRetvalue = retvalue
    end)
end

Ctrl_2 = class('Crtl_2',ControllerBase)
function Ctrl_2:initialize(name, newInsId)
    ControllerBase.initialize(self, name,newInsId)
end
function Ctrl_2:reqDatafun(arg_str)
    local pRetvalue = nil
    ct.model_rpc(self.insId, 'testfun', arg_str,function (retvalue)
        pRetvalue = retvalue
        --ct.log('wk16_abel_controller_model', '[Crtl_2:reqDatafun] return: '..retvalue)
    end)
end
--controller类}

--数据准备{
local ModelManager = ModelManager
ModelManager.initialize()

for i = 1, test_count do
    ModelManager.addModel(nil,Model_1:new('Model_1'..i))
    tempCtrlList[i] = Ctrl_1:new('Ctrl_1_ins_'..i, i)
end
for i = test_count+1, test_count *2 do
    ModelManager.addModel(nil,Model_2:new('Model_2'..i))
    tempCtrlList[i] = Ctrl_2:new('Ctrl_1_ins_'..i, i)
end
--数据准备}

UnitTest.Exec("wk16_abel_controller_model", "test_wk16_abel_controller_model",  function ()
    local pCrtl_1 = Ctrl_1:new('Crtl_1_ins', ct.getIntPart(test_count*0.5) )
    local pCrtl_2 = Ctrl_2:new('Crtl_1_ins',ct.getIntPart(test_count*1.5))
    --测试{
    pCrtl_1:reqDatafun(1,2)
    pCrtl_2:reqDatafun('hello')
    --测试}
end)



UnitTest.Exec("wk16_abel_model_rpc_errfun", "test_wk16_abel_model_rpc_errfun",  function ()
    local pCrtl_2 = Ctrl_2:new('Crtl_1_ins',ct.getIntPart(test_count*1.5))
    --测试{
    --不存在的方法,会有 Error 日志输出
    ct.model_rpc(pCrtl_2.insId, 'testfun1', 'hello',function (retvalue)
        ct.log('wk16_abel_model_rpc_errfun', '[Crtl_2:reqDatafun] return: '..retvalue)
    end)
    --测试}
end)

UnitTest.Exec("wk16_abel_model_rpc_noCb", "test_wk16_abel_model_rpc_noCb",  function ()
    local pCrtl_2 = Ctrl_2:new('Crtl_1_ins',ct.getIntPart(test_count*1.5))
    --测试{
    --不存在的方法,会有 Error 日志输出
    ct.model_rpc(pCrtl_2.insId, 'testfun1', 'hello')
    --测试}
end)

UnitTest.Exec("wk16_abel_ctrl_model", "test_wk16_abel_ctrl_model_Performance",  function ()
    collectgarbage("collect")
    ct.log('wk16_abel_ctrl_model', "model_rpc 性能测试"..test_count.."次调用,测试开始------------------------------------------")
    UnitTest.PerformanceTest("wk16_abel_ctrl_model","model_rpc 性能测试1：直接调用 model 方法", function()
        local retvalue = nil
        for i = 1, test_count do
            retvalue = ModelManager.getModel(nil,i):testfun(1,2)
        end
        for i = test_count+1, test_count*2 do
            retvalue = ModelManager.getModel(nil,i):testfun('hello_'..i)
        end
    end)
    collectgarbage("collect")
    UnitTest.PerformanceTest("wk16_abel_ctrl_model","model_rpc 性能测试2：model_rpc 调用", function()
        local pRetvalue = nil
        for i = 1, test_count do
            --tempCtrlList[i]:reqDatafun(1,2)
            ct.model_rpc(tempCtrlList[i].insId, 'testfun', 1,2,function (retvalue)
                pRetvalue = retvalue
            end)
        end
        for i = test_count+1, test_count*2 do
            --tempCtrlList[i]:reqDatafun('hello_'..i)
            ct.model_rpc(tempCtrlList[i].insId, 'testfun', 'hello',function (retvalue)
                pRetvalue = retvalue
            end)
        end
    end)
    collectgarbage("collect")
    --modelRpc1
    UnitTest.PerformanceTest("wk16_abel_ctrl_model","model_rpc 性能测试3：model_rpc1 调用", function()
        local pRetvalue = nil
        for i = 1, test_count do
            ct.model_rpc1(tempCtrlList[i].insId, 'testfun', 1,2,function (retvalue)
                pRetvalue = retvalue
            end)
        end
        for i = test_count+1, test_count*2 do
            ct.model_rpc1(tempCtrlList[i].insId, 'testfun', 'hello',function (retvalue)
                pRetvalue = retvalue
            end)
        end
    end)
    collectgarbage("collect")
    UnitTest.PerformanceTest("wk16_abel_ctrl_model","model_rpc 性能测试4：model_rpc2 调用", function()
        local pRetvalue = nil
        for i = 1, test_count do
            ct.model_rpc2(tempCtrlList[i].insId, 'testfun', 1,2,function (retvalue)
                pRetvalue = retvalue
            end)
        end
        for i = test_count+1, test_count*2 do
            ct.model_rpc2(tempCtrlList[i].insId, 'testfun', 'hello',function (retvalue)
                pRetvalue = retvalue
            end)
        end
    end)

    --[[
    100万次调用
        model_rpc 性能测试1：直接调用 model 方法    执行时间:      4.1279999999999
        model_rpc 性能测试2：model_rpc 调用    执行时间:           4.454
        model_rpc 性能测试3：model_rpc1 调用    执行时间:          4.62
        model_rpc 性能测试3：model_rpc2 调用    执行时间:          5.1899999999999
    50万次调用
        model_rpc 性能测试1：直接调用 model 方法    执行时间:      1.9750000000001
        model_rpc 性能测试2：model_rpc 调用    执行时间:           2.2450000000001
        model_rpc 性能测试3：model_rpc1 调用    执行时间:          2.2750000000001
        model_rpc 性能测试3：model_rpc2 调用    执行时间:          2.519
    10万次调用
        model_rpc 性能测试1：直接调用 model 方法    执行时间:      0.43599999999992
        model_rpc 性能测试2：model_rpc 调用    执行时间:           0.42499999999995
        model_rpc 性能测试3：model_rpc1 调用    执行时间:          0.43000000000006
        model_rpc 性能测试3：model_rpc2 调用    执行时间:          0.49099999999999
    1万次调用
        model_rpc 性能测试1：直接调用 model 方法    执行时间:      0.044000000000096
        model_rpc 性能测试2：model_rpc 调用    执行时间:           0.045999999999822
        model_rpc 性能测试3：model_rpc1 调用    执行时间:          0.048000000000002
        model_rpc 性能测试3：model_rpc2 调用    执行时间:          0.070999999999913
    性能比较接近
    --]]
end)

UnitTest.TestBlockEnd()-----------------------------------------------------------