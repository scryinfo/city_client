---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2019/2/27 15:53
--- Minimap
--- Search has several signs:
--- self.uiSelectId: The type selected on the UI is only for click display, and cannot be used to judge the currently confirmed search type
--- self.selectSearchType: the typeId of the selected direct search
--- self.selectDetailItem: the detailed Id of the selected second-level menu, and selectSearchType cannot exist at the same time, providing two interfaces: getTypeId & getItemId

MapCtrl = class('MapCtrl',UIPanel)
UIPanel:ResgisterOpen(MapCtrl)

MapCtrl.static.reqServerTime = 10  --refresh time
MapCtrl.static.DetailSize = Vector2.New(500, 876)  --The size of the detailed interface
MapCtrl.static.CloseSearchBtnSize = Vector2.New(59, 277)  --The size of the button to close the search
MapCtrl.static.TypeMovePos = Vector2.New(0, -400)  --Type X position of hidden display, x is display position, y is hidden position
MapCtrl.static.ShowTypeBtnMovePos = Vector2.New(17, -80)  --Open the interface button to hide the displayed X position, x is the display position, y is the hidden position
--Type of search on the left side of the minimap
EMapSearchType =
{
    Default = 0,
    Material = 1,
    Goods = 2,
    Builds = 3,
    Technology = 4,
    Promotion = 5,
    Deal = 6,
    Auction = 7,
    Signing = 8,
    SelfBuilding = 9,
}
--Different types of research promotion queries
EMapPromotionType =
{
    Food = 1,
    Clothes = 2,
    SuperMarket = 3,
    House = 4,
}
EMapTechnologyType =
{
    Default = 0,
    TechNewItem = 1,
    TechEva = 2,
}
EBuildingIconPath =
{
    House = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-HomeHouse.png",
    MaterialFactory = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-Material.png",
    Municipal = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-HomeHouse.png",
    ProcessingFactory = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-Fatory.png",
    Laboratory = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-HomeHouse.png",
    RetailShop = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-SuperMarket.png",
    TalentCenter = "Assets/CityGame/Resources/Atlas/Map/buildingIcons/icon-HomeHouse.png",
}
--One-to-one correspondence with the Id of the configuration table

function MapCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end
--
function MapCtrl:bundleName()
    return "Assets/CityGame/Resources/View/MapPanel.prefab"
end
--
function MapCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end
--
function MapCtrl:Awake(go)
    --UpdateBeat:Add(self._update, self)

    self.gameObject = go
    local behaviour = self.gameObject:GetComponent('LuaBehaviour')
    behaviour:AddClick(MapPanel.backBtn.gameObject, function ()
        PlayMusEff(1002)
        MapBubbleManager.setCameraToBackID()
        UIPanel.ClosePage()
    end)
    behaviour:AddClick(MapPanel.enlargeBtn.gameObject, function()
        PlayMusEff(1002)
        self:EnLargeMap()
    end)
    behaviour:AddClick(MapPanel.narrowBtn.gameObject, function()
        PlayMusEff(1002)
        self:NarrowMap()
    end)
    behaviour:AddClick(MapPanel.closeSearchBtn.gameObject, function()
        PlayMusEff(1002)
        self:closeSearch()
    end)
    behaviour:AddClick(MapPanel.openTypeBtnRect.gameObject, function()
        PlayMusEff(1002)
        self:openSearch()
    end)

    --Read configuration table
    self.ScaleMin = TerrainConfig.MiniMap.ScaleMin
    self.ScaleMax = TerrainConfig.MiniMap.ScaleMax
    self.ScaleOffset = TerrainConfig.MiniMap.ScaleOffset
    self.my_Scale = TerrainConfig.MiniMap.ScaleStart
    self.ScaleDuringTime = TerrainConfig.MiniMap.ScaleDuringTime
    self.MapLeftPageDuringTime = TerrainConfig.MiniMap.MapLeftPageDuringTime  --Time to open and close the search interface on the left

    self.criticalScaleValue = TerrainConfig.MiniMap.MapSize / 40  --AOI threshold
    self.itemWidth = MapPanel.mapRootRect.sizeDelta.x / TerrainConfig.MiniMap.MapSize   --The Rect size of one item
    MapBubbleManager.initMapSetting(self.itemWidth, self)  --Pass an example
    MapBubbleManager.createSystemItem()

    self:_initUIData()
    DataManager.ModelRegisterNetMsg(nil,"gscode.OpCode","getAllBuildingDetail","gs.BuildingSet",self.n_OnReceiveAllBuildingDetailInfo,self)
end
--
function MapCtrl:Active()
    UIPanel.Active(self)
    UpdateBeat:Add(self._update, self)

    MapBubbleManager.setBackCollectionID()
end
--
function MapCtrl:Refresh()
    Event.AddListener("c_MapSearchCancelSelect", self.nonePageCancelSelect, self)  --No type of secondary menu, uncheck yourself
    Event.AddListener("c_MapSearchSelectType", self.refreshTypeItems, self)  --Select the type on the left
    Event.AddListener("c_MapSearchSelectDetail", self.refreshDetailItem, self)  --Select specific items in the second level menu
    Event.AddListener("c_MapCloseDetailPage", self.typeToggleSelectPage, self)  --Close the detail interface on the right after selecting the secondary menu
    Event.AddListener("c_MapReqMarketDetail", self._reqMoveDetail, self)  --When dragging the minimap, determine what data needs to be requested
    Event.AddListener("c_MapOpenRightOthersPage", self._openRightOthersPage, self)  --Click the search result, the interface on the right is displayed
    Event.AddListener("c_MapOpenRightGAucPage", self._openRightGAucPage, self)
    Event.AddListener("c_MapOpenRightGTransPage", self._openRightGTransPage, self)
    Event.AddListener("c_MapSelectSelfBuildingPage", self._openRightSelfBuildingPage, self)
    Event.AddListener("c_MapSelectSystemPage", self._openRightSystemPage, self)

    Event.AddListener("c_MapAllSearchToDetail", self._mapAllResearchToDetail, self)  --Click thumbnail to enlarge to AOI range

    self:_language()
    self:_reqAllBuildings()
end
--
function MapCtrl:Hide()
    UIPanel.Hide(self)
    Event.RemoveListener("c_MapSearchCancelSelect", self.nonePageCancelSelect, self)
    Event.RemoveListener("c_MapSearchSelectType", self.refreshTypeItems, self)
    Event.RemoveListener("c_MapSearchSelectDetail", self.refreshDetailItem, self)
    Event.RemoveListener("c_MapCloseDetailPage", self.typeToggleSelectPage, self)
    Event.RemoveListener("c_MapReqMarketDetail", self._reqMoveDetail, self)
    Event.RemoveListener("c_MapOpenRightOthersPage", self._openRightOthersPage, self)
    Event.RemoveListener("c_MapOpenRightGAucPage", self._openRightGAucPage, self)
    Event.RemoveListener("c_MapOpenRightGTransPage", self._openRightGTransPage, self)
    Event.RemoveListener("c_MapSelectSelfBuildingPage", self._openRightSelfBuildingPage, self)
    Event.RemoveListener("c_MapSelectSystemPage", self._openRightSystemPage, self)

    Event.RemoveListener("c_MapAllSearchToDetail", self._mapAllResearchToDetail, self)

    UpdateBeat:Remove(self._update, self)
    self:_cleanDatas()
end
--
function MapCtrl:_cleanDatas()
    if self.m_Timer ~= nil then
        self.m_Timer:Stop()
    end

    self:_cancelDetailSelect()
    self:refreshTypeItems()
    self:closeSearch()
    self:_cleanChooseState()
    self:toggleDetailPage(false)

    --Set the map size and slider initial value
    MapPanel.scaleSlider.minValue = self.ScaleMin
    MapPanel.scaleSlider.maxValue = self.ScaleMax
    self.AOIState = 0  --Set to telephoto
    self.selectSearchType = EMapSearchType.Default  --Selected search type without secondary menu

    self.my_Scale = TerrainConfig.MiniMap.ScaleStart  --Reset the lens
    MapPanel.mapRootRect.transform.localScale = Vector3.one
    MapPanel.mapRootRect.anchoredPosition = Vector2.zero
    MapPanel.scaleSlider.value = self.my_Scale

    MapBubbleManager.closePanelFunc()

    --Panel information on the right
    MapPanel.closeAllRightPage()
    if MapCtrl.selectItem ~= nil then
        --MapCtrl.selectItem:close()
        MapCtrl.selectItem = nil
    end
    --if self.rightSearchItem ~= nil then
    --    self.rightSearchItem:close()
    --    self.rightSearchItem = nil
    --end
end
--
function MapCtrl:_update()
    if MapPanel.loadingImgTran.localScale == Vector3.one then
        MapPanel.loadingImgTran:Rotate(Vector3.back * 200 * UnityEngine.Time.deltaTime)
    end
end
--
function MapCtrl:n_OnReceiveAllBuildingDetailInfo(data)
    if data then
        DataManager.SetMyAllBuildingDetail(data)
    end
    MapBubbleManager.initItemData()
end
--
function MapCtrl:_reqAllBuildings()
    local msgId = pbl.enum("gscode.OpCode", "getAllBuildingDetail")
    CityEngineLua.Bundle:newAndSendMsg(msgId, nil)
end
--
function MapCtrl:_initUIData()
    --UI search interface
    self.typeTable = {}
    for i, value in ipairs(MapTypeConfig) do
        self:_createType(value)
    end

    self:_cleanDatas()
    self.m_Timer = Timer.New(slot(self._itemTimer, self), 1, 3, true)
    MapPanel.loadingImgTran.transform.localScale = Vector3.zero
    MapPanel.loadingImgTran.transform.localEulerAngles = Vector3.zero
end
--
function MapCtrl:_language()
    --page multi-language
    if self.detailPageItems ~= nil then
        for i, item in pairs(self.detailPageItems) do
            item:resetState()
        end
    end
    --Search on the left type multi-language
    if self.typeTable ~= nil then
        for i, item in pairs(self.typeTable) do
            item:_language()
        end
    end
    MapBubbleManager.systemInit()
end
--
function MapCtrl:_itemTimer()
    Event.Brocast("c_SearchEndLoading")
    MapPanel.loadingImgTran.transform.localScale = Vector3.zero
    MapPanel.loadingImgTran.transform.localEulerAngles = Vector3.zero  --Initialization angle
    self:toggleLoadingState(true)
    self.m_Timer:Stop()
end
--
function MapCtrl:_createType(data)
    local go = UnityEngine.GameObject.Instantiate(MapPanel.mapSearchTypeItem)
    go.transform:SetParent(MapPanel.typeItemParent.transform)
    go.transform.localScale = Vector3.one

    local typeId = data.typeId
    if typeId == EMapSearchType.Material then
        self.typeTable[typeId] = MapSearchTypePageItem:new(data, function ()
            self:matSelect()
        end , go)
    elseif typeId == EMapSearchType.Goods then
        self.typeTable[typeId] = MapSearchTypePageItem:new(data, function ()
            self:goodsSelect()
        end , go)
    elseif typeId == EMapSearchType.Builds then
        self.typeTable[typeId] = MapSearchTypePageItem:new(data, function ()
            self:buildsSelect()
        end , go)
    elseif typeId == EMapSearchType.Deal then
        self.typeTable[typeId] = MapSearchTypeNonePageItem:new(data, function ()
            self:dealSelect()
        end , go)
    elseif typeId == EMapSearchType.Auction then
        self.typeTable[typeId] = MapSearchTypeNonePageItem:new(data, function ()
            self:auctionSelect()
        end , go)
    elseif typeId == EMapSearchType.Warehouse then
        self.typeTable[typeId] = MapSearchTypeNonePageItem:new(data, function ()
            self:warehouseSelect()
        end , go)
    elseif typeId == EMapSearchType.Promotion then
        self.typeTable[typeId] = MapSearchTypePageItem:new(data, function ()
            self:promotionSelect()
        end , go)
    elseif typeId == EMapSearchType.Technology then
        self.typeTable[typeId] = MapSearchTypePageItem:new(data, function ()
            self:technologySelect()
        end , go)
    elseif typeId == EMapSearchType.Signing then
        self.typeTable[typeId] = MapSearchTypeNonePageItem:new(data, function ()
            self:signSelect()
        end , go)
    end
end
--loading
function MapCtrl:toggleLoadingState(isShow)
    if self.typeTable ~= nil then
        for i, value in pairs(self.typeTable) do
            value:toggleLoadingState(isShow)
        end
    end
end
--Open the raw material details interface
function MapCtrl:matSelect()
    self:toggleDetailPage(true)
    self:_openPageItems(EMapSearchType.Material)
end
--Open the product details interface
function MapCtrl:goodsSelect()
    self:toggleDetailPage(true)
    self:_openPageItems(EMapSearchType.Goods)
end
--Open the building search interface
function MapCtrl:buildsSelect()
    self:toggleDetailPage(true)
    self:_openPageItems(EMapSearchType.Builds)
end
--Promote the secondary menu
function MapCtrl:promotionSelect()
    self:toggleDetailPage(true)
    self:_openPageItems(EMapSearchType.Promotion)
end
--Scientific research secondary menu
function MapCtrl:technologySelect()
    self:toggleDetailPage(true)
    self:_openPageItems(EMapSearchType.Technology)
end
--Type search without secondary menu
function MapCtrl:_noPageTypeSelect()
    MapPanel.closeAllRightPage()
    self:toggleLoadingState(false)
    self.m_Timer:Reset(slot(self._itemTimer, self), 1, 3, true)
    self.m_Timer:Start()
    MapPanel.loadingImgTran.transform.localScale = Vector3.one  --Start to circle

    if self.selectDetailItem ~= nil then
        self.selectDetailItem:resetState()
        self.selectDetailItem = nil  --Another option clear
    end
end
--Selected land transaction
function MapCtrl:dealSelect()
    self:_noPageTypeSelect()
    self.selectSearchType = EMapSearchType.Deal

    MapBubbleManager.cleanAllBubbleItems()
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        MapModel.m_ReqGroundTransSummary()
    end
end
--Selected Auction
function MapCtrl:auctionSelect()
    self:_noPageTypeSelect()
    self.selectSearchType = EMapSearchType.Auction

    MapBubbleManager.cleanAllBubbleItems()
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        MapBubbleManager.createSummaryItems(nil, self.selectSearchType)
    end
end
--warehouse
function MapCtrl:warehouseSelect()
    self:_noPageTypeSelect()
    self.selectSearchType = EMapSearchType.Warehouse

    MapBubbleManager.cleanAllBubbleItems()
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        MapModel.m_ReqWarehouseSummary()
    end
end
--Sign a contract
function MapCtrl:signSelect()
    self:_noPageTypeSelect()
    self.selectSearchType = EMapSearchType.Signing

    MapBubbleManager.cleanAllBubbleItems()
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        MapModel.m_ReqSigningSummary()
    end
end

---
--nonePage type, unchecked
function MapCtrl:nonePageCancelSelect(selectId)
    if self.selectSearchType == selectId then
        self:refreshTypeItems()
        self.uiSelectId = nil
        self.selectSearchType = EMapSearchType.Default
        self.selectDetailItem = nil

        MapPanel.closeAllRightPage()
        MapBubbleManager.cleanAllBubbleItems()
    end
end
--
function MapCtrl:typeToggleSelectPage(selectId, open)
    if self.uiSelectId == selectId then
        self:toggleDetailPage(open)
    end
end
--Selected left-side UI display
function MapCtrl:refreshTypeItems(selectId)
    if selectId == nil then
        for i, value in pairs(self.typeTable) do
            value:refreshShow(false)
            value:chooseTypeDetail()  --Uncheck type without secondary menu
        end
    else
        for i, value in pairs(self.typeTable) do
            if value:getTypeId() == selectId then
                value:refreshShow(true)
                self.uiSelectId = selectId
                self:toggleDetailPage(false)
            else
                value:refreshShow(false)
            end
        end
    end
end
--Clear all selected states
function MapCtrl:_cleanChooseState()
    for i, value in pairs(self.typeTable) do
        value:resetState()
    end
end
--
function MapCtrl:refreshDetailItem(item)
    MapPanel.closeAllRightPage()

    --Click twice to cancel to check whether it is selected
    if item == self.selectDetailItem then
        self.selectDetailItem:resetState()
        self.selectDetailItem = nil
        MapBubbleManager.cleanAllBubbleItems()
        Event.Brocast("c_ChooseTypeDetail")
    else
        --If you have not searched before, record the search item
        if self.selectDetailItem ~= nil then
            self.selectDetailItem:resetState()
        end

        --self.selectSearchType = EMapSearchType.Default  --Selected search type
        --self.selectDetailItem = item
        local typeId = item:getTypeId()
        local tempItem = self.typeTable[typeId]
        if tempItem ~= nil then
            --Set the display of the first-level menu
            Event.Brocast("c_ChooseTypeDetail", typeId, item:getNameStr())
            --Determine whether it is scientific research promotion
            if typeId == EMapSearchType.Promotion or typeId == EMapSearchType.Technology then
                --Request data from the server
                self:checkPromotionTechReq(typeId, item)
            elseif typeId == EMapSearchType.Material or typeId == EMapSearchType.Goods then
                self.selectSearchType = EMapSearchType.Default  --Selected search type
                self.selectDetailItem = item
                self:matGoodsReq(item:getItemId())
            elseif typeId == EMapSearchType.Builds then
                self.selectSearchType = EMapSearchType.Default  --Selected search type
                self.selectDetailItem = item
                self:buildsReq(item:getItemId())
            end

            tempItem:_clickFunc()  --Hide the right UI
            --The following is the CD of the circle, fixed rotation for 3 seconds
            self:toggleLoadingState(false)  --cd
            self.m_Timer:Reset(slot(self._itemTimer, self), 1, 3, true)
            self.m_Timer:Start()
            MapPanel.loadingImgTran.transform.localScale = Vector3.one  --Start to circle
        end
    end
end
--
function MapCtrl:buildsReq(typeId)
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        MapModel.m_ReqBuildsSummary(typeId)
    end
end
--
function MapCtrl:matGoodsReq(typeId)
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        MapModel.m_ReqQueryMarketSummary(typeId)
    end
end
--If it is promotion and scientific research, special treatment is required
-- Not to send a message to the server after selecting the detail
--Verify whether you need to send a request to the server
function MapCtrl:checkPromotionTechReq(typeId, item)
    local typeData = self:_getSearchData()
    if typeId == typeData.typeId then
        if self.searchTime == nil then
            self.searchTime = {}
        end
        if self.searchTime[typeId] == nil then
            self:promotionTechReq(typeId, item)
            return
        end
        --You can only search the same level menu once within 10 seconds, timer
        local time = self.searchTime[typeId]
        local remainTime = TimeSynchronized.GetTheCurrentTime() - time - MapCtrl.static.reqServerTime
        if remainTime >= 0 then
            self:promotionTechReq(typeId, item)
        end
    else
        self:promotionTechReq(typeId, item)
    end
end
--Promotion research
function MapCtrl:promotionTechReq(typeId, item)
    if self.searchTime == nil then
        self.searchTime = {}
    end
    self.searchTime[typeId] = TimeSynchronized.GetTheCurrentTime()
    --First level menu type search
    self.selectSearchType = EMapSearchType.Default  --Selected search type
    --Type 2 menu search
    self.selectDetailItem = item
    if self:_getIsDetailFunc() == true then
        self:_judgeDetail()
    else
        self:switchNoDataReq(typeId)
    end
end
--
function MapCtrl:switchNoDataReq(typeId)
    if self.selectDetailItem ~= nil then
        if typeId == EMapSearchType.Technology then
            MapModel.m_ReqLabSummary(self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Promotion then
            MapModel.m_ReqPromotionSummary(self.selectDetailItem:getItemId())
        end
    end
end

--Uncheck
function MapCtrl:_cancelDetailSelect()
    if self.selectDetailItem ~= nil then
        self.selectDetailItem:resetState()
        self.selectDetailItem = nil
    end
    self.uiSelectId = nil
end

---

--Close the left type interface
function MapCtrl:closeSearch()
    if math.abs(math.abs(MapPanel.typeOpenRect.anchoredPosition.x) - math.abs(MapCtrl.static.TypeMovePos.x)) < 0.001 then  --如果为打开状态，则关闭
        MapPanel.typeOpenRect:DOAnchorPosX(MapCtrl.static.TypeMovePos.y, self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
        MapPanel.openTypeBtnRect:DOAnchorPosX(MapCtrl.static.ShowTypeBtnMovePos.x, self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
    end
end
--Open the type interface on the left
function MapCtrl:openSearch()
    if math.abs(math.abs(MapPanel.typeOpenRect.anchoredPosition.x) - math.abs(MapCtrl.static.TypeMovePos.y)) < 0.001 then  --如果为关闭状态，则打开
        MapPanel.typeOpenRect:DOAnchorPosX(MapCtrl.static.TypeMovePos.x, self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
        MapPanel.openTypeBtnRect:DOAnchorPosX(MapCtrl.static.ShowTypeBtnMovePos.y, self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
    end
end
--Close details interface
function MapCtrl:toggleDetailPage(open)
    if open == true then
        if MapPanel.detailPagesRect.sizeDelta.x == 0 then
            --MapPanel.detailPagesRect:DoSizeDelta(MapCtrl.static.DetailSize, self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
            --MapPanel.closeSearchBtn:DoSizeDelta(Vector2.New(0, MapCtrl.static.CloseSearchBtnSize.y), self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
            MapPanel.detailPagesRect.sizeDelta = MapCtrl.static.DetailSize
            MapPanel.closeSearchBtn.sizeDelta = Vector2.New(0, MapCtrl.static.CloseSearchBtnSize.y)
        end
        return
    end
    if MapPanel.detailPagesRect.sizeDelta.x ~= 0 then
        --MapPanel.detailPagesRect:DoSizeDelta(Vector2.New(0, MapCtrl.static.DetailSize.y), self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
        --MapPanel.closeSearchBtn:DoSizeDelta(MapCtrl.static.CloseSearchBtnSize, self.MapLeftPageDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
        MapPanel.detailPagesRect.sizeDelta = Vector2.New(0, MapCtrl.static.DetailSize.y)
        MapPanel.closeSearchBtn.sizeDelta = MapCtrl.static.CloseSearchBtnSize
    end
end
--Generate the detail interface on the right
function MapCtrl:_openPageItems(type)
    if self.detailPageItems == nil then
        self.detailPageItems = {}
    end
    if self.detailPageItems[type] == nil then
        local go = MapPanel.getPageByType(type)
        MapPanel.showDetailPageByType(type)

        self.detailPageItems[type] = self:getDetailPageByType(type, go)
    end
    for i, value in pairs(self.detailPageItems) do
        if value:getTypeId() == type then
            value:toggleState(true)
        else
            value:toggleState(false)
        end
    end
end
--
function MapCtrl:getDetailPageByType(typeId, go)
    local item
    if typeId == EMapSearchType.Material or typeId == EMapSearchType.Goods then
        item = MapMatDetailPageItem:new(typeId, go)
    elseif typeId == EMapSearchType.Builds then
        item = MapBuildsPageItem:new(typeId, go)
    elseif typeId == EMapSearchType.Technology then
        item = MapTechnologyPageItem:new(typeId, go)
    elseif typeId == EMapSearchType.Promotion then
        item = MapPromotionPageItem:new(typeId, go)
    end
    return item
end
--All selected items with click effect
function MapCtrl.selectCenterItem(item)
    if MapCtrl.selectItem == nil then
        MapCtrl.selectItem = item
        item:toggleShowSelect(true)
    else
        if MapCtrl.selectItem ~= item then
            MapCtrl.selectItem:toggleShowSelect(false)
            MapCtrl.selectItem = item
            item:toggleShowSelect(true)
        end
    end
end
--After the search is completed, select the specific item and open the raw material interface on the right
--item is MapSearchResultItem
function MapCtrl:_openRightOthersPage(item)
    if item ~= nil then
        --if self.rightSearchItem ~= nil then
        -- self.rightSearchItem:toggleShowDetailImg(false) -- cancel the previous selection
        --end
        --self.rightSearchItem = item
        --self.rightSearchItem:toggleShowDetailImg(true)

        -- Determine whether to search directly or expand the search on the secondary interface
        local typeData = self:_getSearchData()
        MapPanel.closeAllRightPage()

        MapCtrl._toggleShowRightRoot(true)
        MapPanel.rightOtherBuildingPageItem:refreshData(item.data, typeData)
    end
end
--Get the type of the current search
function MapCtrl:_getSearchData()
    local typeData = {}
     --selectDetailItem is a type detail item with a secondary menu
     --typeId is the first-level menu type, detailId is the second-level menu type
     --eg: Research-->eva
    if self.selectDetailItem ~= nil then
        typeData.detailId = self.selectDetailItem:getItemId()
        typeData.typeId = self.selectDetailItem:getTypeId()
    else
        if self.selectSearchType ~= nil then
            typeData.typeId = self.selectSearchType
        end
    end
    return typeData
end
--Open the auction
function MapCtrl:_openRightGAucPage(item)
    if item ~= nil then
        MapPanel.closeAllRightPage()
        MapCtrl._toggleShowRightRoot(true)
        MapPanel.rightGroundAucPageItem:refreshData(item.data)
    end
end
--Open land transaction
function MapCtrl:_openRightGTransPage(item)
    if item ~= nil then
        MapPanel.closeAllRightPage()
        MapCtrl._toggleShowRightRoot(true)
        MapPanel.rightGroundTransPageItem:refreshData(item.data)
    end
end
--Open your own building
function MapCtrl:_openRightSelfBuildingPage(item)
    if item ~= nil then
        MapPanel.closeAllRightPage()
        MapCtrl._toggleShowRightRoot(true)
        MapPanel.selfBuildingPageItem:refreshData(item.data)
    end
end
--Open system building
function MapCtrl:_openRightSystemPage(item)
    if item ~= nil then
        MapPanel.closeAllRightPage()
        MapCtrl._toggleShowRightRoot(true)
        MapPanel.systemBuildingPageItem:refreshData(item.data)
    end
end
--
function MapCtrl:getNonePageSearchType()
    return self.selectSearchType
end

---Server request
function MapCtrl:_reqMoveDetail(blockId)
    --Outside of AOI
    if self.my_Scale < self.criticalScaleValue then
        return
    end

    if self.selectDetailItem ~= nil then
        local blockCollectionId = TerrainManager.BlockIDTurnCollectionGridIndex(blockId)
        local typeId = self.selectDetailItem:getTypeId()

        if typeId == EMapSearchType.Material or typeId == EMapSearchType.Goods then
            MapModel.m_ReqMarketDetail(blockCollectionId, self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Promotion then
            MapModel.m_ReqPromotionDetail(blockCollectionId, self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Technology then
            MapModel.m_ReqTechnologyDetail(blockCollectionId, self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Builds then
            MapModel.m_ReqBuildsDetail(blockCollectionId, self.selectDetailItem:getItemId())
        end
        return
    end
    --Direct search and corresponding processing
    if self.selectSearchType ~= nil and self.selectSearchType ~= EMapSearchType.Default then
        if self.selectSearchType == EMapSearchType.Warehouse then
            MapModel.m_ReqWarehouseDetail(MapCtrl.getNowCenterCollectionId())
        elseif self.selectSearchType == EMapSearchType.Signing then
            MapModel.m_ReqSigningDetail(MapCtrl.getNowCenterCollectionId())
        end
    end
end

---Server callback
--Building type search summary
function MapCtrl:_receiveBuildsSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Builds)
end
--Raw material search summary
function MapCtrl:_receiveMarketSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Material)
end
--Land Transaction Search Summary
function MapCtrl:_receiveGroundTransSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Deal)
end
--research
function MapCtrl:_receiveLabSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Technology)
end
--Promote
function MapCtrl:_receivePromotionSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Promotion)
end
--Sign a contract
function MapCtrl:_receiveSigningSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Signing)
end
--warehouse
function MapCtrl:_receiveWarehouseSummary(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createSummaryItems(data, EMapSearchType.Warehouse)
end
--Building type details
function MapCtrl:_receiveBuildsDetail(data)
    if data ~= nil then
        MapBubbleManager.cleanAllBubbleItems()
        MapBubbleManager.createDetailItems(data, EMapSearchType.Builds,true)
    end
end
--Raw material commodity search details
function MapCtrl:_receiveMarketDetail(data)
    if data ~= nil then
        MapBubbleManager.cleanAllBubbleItems()
        MapBubbleManager.createDetailItems(data, EMapSearchType.Material,true)

        --local mapCtrlIns = MapBubbleManager.getMapCtrlIns()
        --if mapCtrlIns.selectDetailItem == nil or mapCtrlIns.selectDetailItem:getItemId() ~= data.itemId then
        --    MapBubbleManager.cleanAllBubbleItems()
        --    MapBubbleManager.createDetailItems(data, EMapSearchType.Material,true)
        --    return
        --end
        --if mapCtrlIns.selectDetailItem ~= nil and mapCtrlIns.selectDetailItem:getItemId() == data.itemId then
        --    MapBubbleManager.createDetailItems(data, EMapSearchType.Material,false)
        --end
    end
end

--Signing details
function MapCtrl:_receiveSignDetail(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createDetailItems(data, EMapSearchType.Signing, true)
end
--research
function MapCtrl:_receiveTechDetail(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createDetailItems(data, EMapSearchType.Technology, true)
end
---warehouse
function MapCtrl:_receiveWarehouseDetail(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createDetailItems(data, EMapSearchType.Warehouse, true)
end
--Promote
function MapCtrl:_receivePromotionDetail(data)
    MapBubbleManager.cleanAllBubbleItems()
    MapBubbleManager.createDetailItems(data, EMapSearchType.Promotion, true)
end

---

---Map zoom part
--Enlarge the map [over]
function MapCtrl:EnLargeMap()
    if self.my_Scale ~= nil and self.ScaleOffset ~= nil and self.ScaleMax ~= nil then
        local scale_value = self.my_Scale + self.ScaleOffset
        if scale_value >= self.ScaleMax then
            scale_value = self.ScaleMax
        end
        if self.my_Scale ~= scale_value then
            if scale_value >= self.criticalScaleValue then
                --Reached AOI range
                if self.AOIState == 0 then
                    self.AOIState = 1
                    MapBubbleManager.toggleShowDetailBuilding(true)
                    MapBubbleManager.showSummaryOrDetail(true)
                    self:_judgeDetail()
                end
            end

            self:CenterOffset(self.my_Scale,scale_value)
            self.my_Scale = scale_value
            self:RefreshMiniMapScale()
        end
    end
end

--Zoom out the map [over]
function MapCtrl:NarrowMap()
    if self.my_Scale ~= nil and self.ScaleOffset ~= nil and self.ScaleMin ~= nil then
        local scale_value = self.my_Scale - self.ScaleOffset
        if scale_value <= self.ScaleMin then
            scale_value = self.ScaleMin
        end
        if self.my_Scale ~= scale_value then
            if scale_value < self.criticalScaleValue then
                --Leave AOI
                if self.AOIState == 1 then
                    self.AOIState = 0
                    MapBubbleManager.toggleShowDetailBuilding(false)
                    MapBubbleManager.showSummaryOrDetail(false)
                    self:_judgeSummary()
                end
            end

            self:CenterOffset(self.my_Scale,scale_value)
            self.my_Scale = scale_value
            self:RefreshMiniMapScale()
        end
    end
end

--Center offset
function MapCtrl:CenterOffset(beginScale,EndScale)
    local TargetAnchoredPosition = MapPanel.mapRootRect.anchoredPosition * (EndScale/ beginScale)
    local NowRangeSize = (EndScale - 1) * MapPanel.mapRootRect.sizeDelta.x / 2
    if TargetAnchoredPosition.x > NowRangeSize then
        TargetAnchoredPosition.x = NowRangeSize
    elseif  TargetAnchoredPosition.x < -NowRangeSize then
        TargetAnchoredPosition.x = -NowRangeSize
    end
    if TargetAnchoredPosition.y > NowRangeSize then
        TargetAnchoredPosition.y = NowRangeSize
    elseif  TargetAnchoredPosition.y < -NowRangeSize then
        TargetAnchoredPosition.y = -NowRangeSize
    end
    MapPanel.mapRootRect:DOAnchorPos(TargetAnchoredPosition , self.ScaleDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
end

--Refresh the current map size
function MapCtrl:RefreshMiniMapScale()
    --Refresh Slider
    MapPanel.scaleSlider.value = self.my_Scale
    --
    Event.Brocast("c_MapBubbleScale", self.my_Scale)
    --TODO: do center offset
    MapPanel.mapRootRect:DOScale(Vector3.New(self.my_Scale,self.my_Scale,self.my_Scale),self.ScaleDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
end

--Get the world coordinates of the center of the screen based on a small map
function MapCtrl:getScreenCenterMapPos()
    local x = (MapPanel.mapRootRect.sizeDelta.x / 2 - MapPanel.mapRootRect.anchoredPosition.x / self.my_Scale) * (TerrainConfig.MiniMap.MapSize / MapPanel.mapRootRect.sizeDelta.x)
    local y = (MapPanel.mapRootRect.sizeDelta.y / 2 + MapPanel.mapRootRect.anchoredPosition.y / self.my_Scale) * (TerrainConfig.MiniMap.MapSize / MapPanel.mapRootRect.sizeDelta.y)
    return Vector3.New(y, 0, x)
end
--Get current zoom value
function MapCtrl.getCurrentScaleValue()
    return MapPanel.scaleSlider.value
end
--
function MapCtrl._toggleShowRightRoot(open)
    if open == true then
        MapPanel.rightOtherPageRoot.localScale = Vector3.one
    else
        MapPanel.rightOtherPageRoot.localScale = Vector3.zero
    end
end
--
function MapCtrl:_mapAOIMove()
    --Once moved, close the search results on the right
    MapCtrl._toggleShowRightRoot(false)
    if MapCtrl.selectItem ~= nil then
        MapCtrl.selectItem:toggleShowSelect(false)
        MapCtrl.selectItem = nil
    end

    if self.my_Scale < self.criticalScaleValue then
        return
    end
    local pos = self:getScreenCenterMapPos()
    --Event.Brocast("CameraMoveTo", pos)
    CameraMove.MoveCameraToPos(pos)
end
--Determine whether to request details during zoom-in
function MapCtrl:_judgeDetail()
    --Determine whether the selected search is direct search or secondary search
    if self.selectDetailItem ~= nil then
        local blockCollectionId = MapCtrl.getNowCenterCollectionId()
        local typeId = self.selectDetailItem:getTypeId()

        if typeId == EMapSearchType.Material or typeId == EMapSearchType.Goods then
            MapModel.m_ReqMarketDetail(blockCollectionId, self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Promotion then
            MapModel.m_ReqPromotionDetail(blockCollectionId, self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Technology then
            MapModel.m_ReqTechnologyDetail(blockCollectionId, self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Builds then
            MapModel.m_ReqBuildsDetail(blockCollectionId, self.selectDetailItem:getItemId())
        end
        return
    end

    --Direct search and corresponding processing
    if self.selectSearchType ~= nil and self.selectSearchType ~= EMapSearchType.Default then
        if self.selectSearchType == EMapSearchType.Auction then
            MapBubbleManager.createGAucDetailItems()
        elseif self.selectSearchType == EMapSearchType.Deal then
            MapBubbleManager.createGroundTransDetailItems()
        elseif self.selectSearchType == EMapSearchType.Warehouse then
            MapModel.m_ReqWarehouseDetail(MapCtrl.getNowCenterCollectionId())
        elseif self.selectSearchType == EMapSearchType.Signing then
            MapModel.m_ReqSigningDetail(MapCtrl.getNowCenterCollectionId())
        end
    end
end
--Determine whether to request thumbnails during zooming out
function MapCtrl:_judgeSummary()
    if self.selectDetailItem ~= nil then
        local typeId = self.selectDetailItem:getTypeId()

        if typeId == EMapSearchType.Material or typeId == EMapSearchType.Goods then
            MapModel.m_ReqQueryMarketSummary(self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Promotion then
            MapModel.m_ReqPromotionSummary(self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Technology then
            MapModel.m_ReqLabSummary(self.selectDetailItem:getItemId())
        elseif typeId == EMapSearchType.Builds then
            MapModel.m_ReqBuildsSummary(self.selectDetailItem:getItemId())
        end
        return
    end

    if self.selectSearchType ~= nil and self.selectSearchType ~= EMapSearchType.Default then
        if self.selectSearchType == EMapSearchType.Auction then
            MapBubbleManager.createSummaryItems(nil, self.selectSearchType)
        elseif self.selectSearchType == EMapSearchType.Deal then
            MapModel.m_ReqGroundTransSummary()
        elseif self.selectSearchType == EMapSearchType.Warehouse then
            MapModel.m_ReqWarehouseSummary()
        elseif self.selectSearchType == EMapSearchType.Signing then
            MapModel.m_ReqSigningSummary()
        end
    end
end
--Get the Id of the current location
function MapCtrl.getNowCenterCollectionId()
    local collectionId = TerrainManager.GetCameraCollectionID()
    local blockId = TerrainManager.CollectionIDTurnBlockID(collectionId)
    local blockCollectionId = TerrainManager.BlockIDTurnCollectionGridIndex(blockId)
    return blockCollectionId
end
--Determine if minimap is in detailed search status
function MapCtrl:_getIsDetailFunc()
    if self.my_Scale ~= nil and self.my_Scale > self.criticalScaleValue then
        return true
    end
    return false
end
--Click thumbnail to zoom to detail size
function MapCtrl:_mapAllResearchToDetail(summaryPos, scenePos)
    local targetScale = TerrainConfig.MiniMap.DetailScale
    if self.AOIState == 0 then
        self.AOIState = 1
        MapBubbleManager.toggleShowDetailBuilding(true)
        MapBubbleManager.showSummaryOrDetail(true)
        self:_judgeDetail()
    end

    self:_posOffset(self.my_Scale, targetScale, summaryPos)
    self.my_Scale = targetScale

    MapBubbleManager.toggleShowDetailBuilding(true)
    self:RefreshMiniMapScale()
     --Move the camera
     --local pos = scenePos + Vector3.New(10, 0, 10)
    CameraMove.MoveCameraToPos(scenePos)
end
--The offset of the item in the upper left corner
function MapCtrl:_posOffset(beginScale, EndScale, summaryPos)
    --Because the anchor point of the item is on the upper left, make an offset
    local itemPos = Vector2.New(summaryPos.x - MapPanel.mapRootRect.sizeDelta.x / 2, summaryPos.y + MapPanel.mapRootRect.sizeDelta.x / 2)
    local TargetAnchoredPosition = (MapPanel.mapRootRect.anchoredPosition - itemPos) * (EndScale/ beginScale)
    local NowRangeSize = (EndScale - 1) * MapPanel.mapRootRect.sizeDelta.x / 2
    if TargetAnchoredPosition.x > NowRangeSize then
        TargetAnchoredPosition.x = NowRangeSize
    elseif  TargetAnchoredPosition.x < -NowRangeSize then
        TargetAnchoredPosition.x = -NowRangeSize
    end
    if TargetAnchoredPosition.y > NowRangeSize then
        TargetAnchoredPosition.y = NowRangeSize
    elseif  TargetAnchoredPosition.y < -NowRangeSize then
        TargetAnchoredPosition.y = -NowRangeSize
    end
    MapPanel.mapRootRect:DOAnchorPos(TargetAnchoredPosition , self.ScaleDuringTime):SetEase(DG.Tweening.Ease.OutCubic)
end
---