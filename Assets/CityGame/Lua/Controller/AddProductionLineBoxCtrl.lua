---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Fisher.
--- DateTime: 2019/4/13 11:26
---
AddProductionLineBoxCtrl = class('AddProductionLineBoxCtrl',UIPanel)
UIPanel:ResgisterOpen(AddProductionLineBoxCtrl)

local ToNumber = tonumber
local addLineBox
--Luxury class
local oneLevel = Vector3.New(105,174,238)
local twoLevel = Vector3.New(156,136,228)
local threeLevel = Vector3.New(243,185,45)
function AddProductionLineBoxCtrl:initialize()
    UIPanel.initialize(self,UIType.PopUp,UIMode.NeedBack,UICollider.Normal)
end

function AddProductionLineBoxCtrl:bundleName()
    return "Assets/CityGame/Resources/View/AddProductionLineBoxPanel.prefab"
end
function AddProductionLineBoxCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end
function AddProductionLineBoxCtrl:Awake(go)
    self.gameObject = go
end
function AddProductionLineBoxCtrl:Active()
    UIPanel.Active(self)
    addLineBox = self.gameObject:GetComponent('LuaBehaviour')
    addLineBox:AddClick(AddProductionLineBoxPanel.bgBtn.gameObject,self.clickCloseBtn,self)
    addLineBox:AddClick(AddProductionLineBoxPanel.confirmBtn.gameObject,self.clickConfirmBtn,self)

    AddProductionLineBoxPanel.topName.text = GetLanguage(25030003)
    --AddProductionLineBoxPanel.levelText.text = GetLanguage(25020007)
    AddProductionLineBoxPanel.productionText.text = GetLanguage(25030004)
    AddProductionLineBoxPanel.eachText.text = GetLanguage(31010042)
    AddProductionLineBoxPanel.time.text = GetLanguage(25030005)
    AddProductionLineBoxPanel.numberTip.text = GetLanguage(25030006)

    AddProductionLineBoxPanel.numberSlider.onValueChanged:AddListener(function()
        self:SlidingUpdateText()
    end)
    AddProductionLineBoxPanel.numberInput.onEndEdit:AddListener(function()
        self:inputEndText()
    end)
end
function AddProductionLineBoxCtrl:Refresh()
    self:_language()
    self:InitializeData()
end
function AddProductionLineBoxCtrl:Hide()
    UIPanel.Hide(self)
    AddProductionLineBoxPanel.numberSlider.onValueChanged:RemoveAllListeners()
end
------------------------------------------------------------------------Initialization function------------------------------------------------------------------------------------------
function AddProductionLineBoxCtrl:InitializeData()
    if not self.m_data then
        return
    end
    AddProductionLineBoxPanel.tipText.transform.localScale = Vector3.zero
    AddProductionLineBoxPanel.timeText.text = "00:00:00"
    AddProductionLineBoxPanel.numberSlider.value = 1
    AddProductionLineBoxPanel.numberSlider.minValue = 1
    AddProductionLineBoxPanel.numberSlider.maxValue = PlayerBuildingBaseData[self.m_data.mId].storeCapacity
    AddProductionLineBoxPanel.numberInput.characterLimit = #tostring(PlayerBuildingBaseData[self.m_data.mId].storeCapacity) + 1
    AddProductionLineBoxPanel.nameText.text = GetLanguage(self.m_data.itemId)
    AddProductionLineBoxPanel.iconImg.sprite = SpriteManager.GetSpriteByPool(self.m_data.itemId)
    self.workerNum = PlayerBuildingBaseData[self.m_data.mId].maxWorkerNum
    if self.m_data.buildingType == BuildingType.MaterialFactory then
        --If it is raw material, close the product attribute display
        AddProductionLineBoxPanel.popularity.transform.localScale = Vector3.zero
        AddProductionLineBoxPanel.quality.transform.localScale = Vector3.zero
        AddProductionLineBoxPanel.levelBg.transform.localScale = Vector3.zero
        AddProductionLineBoxPanel.scoreBg.transform.localScale = Vector3.zero
        AddProductionLineBoxPanel.iconBg.transform.localPosition = Vector3(0,0,0)
        --local speed = 1 / (Material[self.m_data.itemId].numOneSec * self.workerNum)
        local speed = 1 / self.m_data.numOneSec
        AddProductionLineBoxPanel.speedText.text = self:GetOneSecNum(speed)
    elseif self.m_data.buildingType == BuildingType.ProcessingFactory then
        --If it is a product, open the product attribute display
        AddProductionLineBoxPanel.tipText.transform.localScale = Vector3.one
        AddProductionLineBoxPanel.popularity.transform.localScale = Vector3.one
        AddProductionLineBoxPanel.quality.transform.localScale = Vector3.one
        AddProductionLineBoxPanel.levelBg.transform.localScale = Vector3.one
        AddProductionLineBoxPanel.scoreBg.transform.localScale = Vector3.one
        AddProductionLineBoxPanel.iconBg.transform.localPosition = Vector3(-352,0,0)
        --local speed = 1 / (Good[self.m_data.itemId].numOneSec * self.workerNum)
        local speed = 1 / self.m_data.info.numOneSec
        AddProductionLineBoxPanel.speedText.text = self:GetOneSecNum(speed)
        --If it is a commodity, determine the raw material grade
        if Good[self.m_data.itemId].luxury == 1 then
            AddProductionLineBoxPanel.levelImg.color = getColorByVector3(oneLevel)
            AddProductionLineBoxPanel.levelValue.text = GetLanguage(25020028)
        elseif Good[self.m_data.itemId].luxury == 2 then
            AddProductionLineBoxPanel.levelImg.color = getColorByVector3(twoLevel)
            AddProductionLineBoxPanel.levelValue.text = GetLanguage(25020029)
        elseif Good[self.m_data.itemId].luxury == 3 then
            AddProductionLineBoxPanel.levelImg.color = getColorByVector3(threeLevel)
            AddProductionLineBoxPanel.levelValue.text = GetLanguage(25020030)
        end
        AddProductionLineBoxPanel.brandNameText.text = self.m_data.info.brandName
        AddProductionLineBoxPanel.popularityValue.text = self.m_data.info.brandScore
        AddProductionLineBoxPanel.qualityValue.text = self.m_data.info.qtyScore
    end
end
--multi-language
function AddProductionLineBoxCtrl:_language()
    AddProductionLineBoxPanel.tipText.text = GetLanguage(25030030)
    AddProductionLineBoxPanel.brandName.text = GetLanguage(25020040)
end
------------------------------------------------------------------------Click function--------------------------------------------------------------------------------------------
--Close Button
function AddProductionLineBoxCtrl:clickCloseBtn()
    PlayMusEff(1002)
    UIPanel.ClosePage()
end
--Define Button
function AddProductionLineBoxCtrl:clickConfirmBtn(go)
    PlayMusEff(1002)
    local number = AddProductionLineBoxPanel.numberSlider.value
    if go:NumberWhetherZero(number) == true then
        if go.m_data.buildingType == BuildingType.MaterialFactory then
            --Raw material factory
            Event.Brocast("m_ReqMaterialAddLine",go.m_data.insId,number,go.workerNum,go.m_data.itemId)
        elseif go.m_data.buildingType == BuildingType.ProcessingFactory then
            --Processing plant
            Event.Brocast("m_ReqprocessingAddLine",go.m_data.insId,number,go.workerNum,go.m_data.itemId)
        end
    else
        Event.Brocast("SmallPop",GetLanguage(25030025),ReminderType.Common)
    end
end
--------------------------------------------------------------------------Callback--------------------------------------------------------------------------------------------
--After successful addition
function AddProductionLineBoxCtrl:SucceedUpdatePanel(dataInfo)
    if dataInfo ~= nil then
        TimeSynchronized.SynchronizationServerTime(dataInfo.ts)
        UIPanel.ClosePage()
        ----Query current production line
        --Event.Brocast("m_GetLineData",self.m_data.insId)
        Event.Brocast("SmallPop",GetLanguage(25030010),ReminderType.Common)
        UIPanel.ClosePage()
    end
end
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--Keep two decimal places
function AddProductionLineBoxCtrl:GetOneSecNum(str)
    local index = string.find(str, '%.')
    if not index then
        return str
    end
    local secStr = string.sub(str,1,index + 2)
    return secStr
end

--Slide bar to refresh input box value
function AddProductionLineBoxCtrl:SlidingUpdateText()
    AddProductionLineBoxPanel.numberInput.text = AddProductionLineBoxPanel.numberSlider.value
    AddProductionLineBoxPanel.timeText.text = self:GetTime(AddProductionLineBoxPanel.numberSlider.value,self.workerNum)
end
--Input box end event
function AddProductionLineBoxCtrl:inputEndText()
    if AddProductionLineBoxPanel.numberInput.text == "" or ToNumber(AddProductionLineBoxPanel.numberInput.text) <= 0 then
        AddProductionLineBoxPanel.numberInput.text = 1
    end
    if ToNumber(AddProductionLineBoxPanel.numberInput.text) > PlayerBuildingBaseData[self.m_data.mId].storeCapacity then
        AddProductionLineBoxPanel.numberInput.text = PlayerBuildingBaseData[self.m_data.mId].storeCapacity
    end
    AddProductionLineBoxPanel.numberSlider.value = ToNumber(AddProductionLineBoxPanel.numberInput.text)
end
--Check if the quantity to be produced is zero
function AddProductionLineBoxCtrl:NumberWhetherZero(number)
    if number == 0 then
        return false
    end
    return true
end
--calculating time
function AddProductionLineBoxCtrl:GetTime(targetCount,workerNum)
    if targetCount == 0 or workerNum == 0 then
        return "00:00:00"
    end
    local time
    if self.m_data.buildingType == BuildingType.MaterialFactory then
        --time = targetCount / (Material[self.m_data.itemId].numOneSec * workerNum)
        time = targetCount / self.m_data.numOneSec
    elseif self.m_data.buildingType == BuildingType.ProcessingFactory then
        --time = targetCount / (Good[self.m_data.itemId].numOneSec * workerNum)
        time = targetCount / self.m_data.info.numOneSec
    end
    local timeTable = getTimeBySec(time)
    local timeStr = timeTable.hour..":"..timeTable.minute..":"..timeTable.second
    return timeStr
end