---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2019/4/16 17:05
---

BuildingRentPartDetail = class('BuildingRentPartDetail', BasePartDetail)
BuildingRentPartDetail.static.NumberColor = "#333333" -- 总容量的颜色
BuildingRentPartDetail.static.otherSeeRentPos = Vector3.New(0, -64, 0)  --别人看到的rent位置
BuildingRentPartDetail.static.otherSeeCompetitiPos = Vector3.New(-12, 188, 0)  --别人看到的提示框位置
BuildingRentPartDetail.static.selfSeeRentPos = Vector3.New(-396, -64, 0)  --自己看到的rent位置
BuildingRentPartDetail.static.selfSeeCompetitiPos = Vector3.New(-408, 188, 0)  --自己看到的提示框位置

function BuildingRentPartDetail:PrefabName()
    return "BuildingRentPartDetail"
end
--
function BuildingRentPartDetail:_InitClick(mainPanelLuaBehaviour)
    mainPanelLuaBehaviour:AddClick(self.confirmBtn.gameObject, function ()
        PlayMusEff(1002)
        local rent = self.rentInput.text
        if rent == nil or rent == ""then
            return
        end
        local price = tonumber(rent)
        if price <= 0 then
            return
        end
        self:_reqHouseChangeRent(price)
    end , self)
    --
    mainPanelLuaBehaviour:AddClick(self.competBtn.gameObject, function ()
        self.competitivenessRoot.transform.localScale = Vector3.one
        self.competitivenessText04.text = GetLanguage(43010002)
        self.competitivenessText05.text = GetLanguage(43010003)
    end , self)
    mainPanelLuaBehaviour:AddClick(self.competitivenessBtn.gameObject, function ()
        self.competitivenessText04.text = ""
        self.competitivenessText05.text = ""
        self.competitivenessRoot.transform.localScale = Vector3.zero
    end , self)
end
--
function BuildingRentPartDetail:_ResetTransform()
    self.rentInput.text = ""
    self.otherSeeRentText.text = ""
    self:_language()
end
--
function BuildingRentPartDetail:_RemoveEvent()
    Event.RemoveListener("c_getHouseGuidePrice", self._getGuidePrice, self)
end
--
function BuildingRentPartDetail:_InitEvent()
    Event.AddListener("c_getHouseGuidePrice", self._getGuidePrice, self)
end
--
function BuildingRentPartDetail:_RemoveClick()
    self.confirmBtn.onClick:RemoveAllListeners()
    self.competBtn.onClick:RemoveAllListeners()
    self.competitivenessBtn.onClick:RemoveAllListeners()
end
--
function BuildingRentPartDetail:RefreshData(data)
    self:_ResetTransform()
    if data == nil then
        return
    end
    self.m_data = data
    self:_initFunc()
end
--
function BuildingRentPartDetail:_InitTransform()
    self:_getComponent(self.transform)
end
--
function BuildingRentPartDetail:_getComponent(transform)
    if transform == nil then
        return
    end
    self.confirmBtn = transform:Find("Root/confirmBtn"):GetComponent("Button")
    self.occupancyText = transform:Find("Root/occupancy/occupancyText"):GetComponent("Text")  --入住率
    self.competitiSlider = transform:Find("Root/competitiSlider"):GetComponent("Slider")
    self.competitiHalfText = transform:Find("Root/competitiSlider/center/Image/Text/valueText"):GetComponent("Text")  --竞争力的一半
    self.rentRect = transform:Find("Root/rent"):GetComponent("RectTransform")
    self.rentInput = transform:Find("Root/rent/rentInput"):GetComponent("InputField")
    self.rentInputPlaceholder = transform:Find("Root/rent/rentInput/Placeholder"):GetComponent("Text")
    self.otherSee = transform:Find("Root/rent/otherSee")
    self.otherSeeRentText = transform:Find("Root/rent/otherSee/Text"):GetComponent("Text")
    --
    self.competValueText = transform:Find("Root/rent/priceBg/valueText"):GetComponent("Text")
    self.competBtn = transform:Find("Root/rent/priceBg/infoBtn"):GetComponent("Button")
    self.competitivenessRoot = transform:Find("competitivenessRoot"):GetComponent("RectTransform")
    self.competitivenessBtn = transform:Find("competitivenessRoot/btn"):GetComponent("Button")

    self.competitiSliderText01 = transform:Find("Root/competitiSlider/center/Image/Text"):GetComponent("Text")
    self.rentText02 = transform:Find("Root/rent/Text01"):GetComponent("Text")
    self.competValueText03 = transform:Find("Root/rent/priceBg/Text"):GetComponent("Text")
    self.competitivenessText04 = transform:Find("competitivenessRoot/tooltip/title"):GetComponent("Text")
    self.competitivenessText05 = transform:Find("competitivenessRoot/tooltip/content"):GetComponent("Text")

    self:_awakeSliderInput()
end
--
function BuildingRentPartDetail:_awakeSliderInput()
    self.rentInput.onValueChanged:AddListener(function (str)
        if str == "" or self.guideData == nil then
            return
        end
        local temp = ct.CalculationHouseCompetitivePower(self.guideData.guidePrice, tonumber(str) * 10000, self.guideData.npc)
        if temp >= functions.maxCompetitive then
            self.competValueText.text = ">"..temp
        elseif temp <= functions.minCompetitive then
            self.competValueText.text = "<"..temp
        else
            self.competValueText.text = string.format("%0.1f", temp)
        end
        BuildingRentPartDetail.sliderCanChange = false
        self.competitiSlider.value = temp
    end)
    --
    EventTriggerMgr.Get(self.competitiSlider.gameObject).onSelect = function()
        BuildingRentPartDetail.sliderCanChange = true
    end
    EventTriggerMgr.Get(self.competitiSlider.gameObject).onUpdateSelected = function()
        BuildingRentPartDetail.sliderCanChange = true
    end
    self.competitiSlider.onValueChanged:AddListener(function (value)
        if self.guideData == nil then
            return
        end
        if BuildingRentPartDetail.sliderCanChange ~= true then
            return
        end
        local price = ct.CalculationHousePrice(self.guideData.guidePrice, value)
        self.rentInput.text = GetClientPriceString(price)
    end)
end
--判断是否需要改变slider的值
--当input输入的值超出范围，slider被归置为边界值1/99，这时则不能改变input的值
function BuildingRentPartDetail:_checkSliderChange(inputValue)
    local min = ct.CalculationHousePrice(self.guideData.guidePrice, functions.maxCompetitive)
    local max = ct.CalculationHousePrice(self.guideData.guidePrice, functions.minCompetitive)
    --local current = tonumber(inputValue) * 10000
    local current = GetServerPriceNumber(inputValue)
    if current > min and current < max then
        return true
    else
        return false
    end
end
--
function BuildingRentPartDetail:clickCloseBtn()
    self.groupClass.TurnOffAllOptions(self.groupClass)
end
--改变房租
function BuildingRentPartDetail:_reqHouseChangeRent(price)
    DataManager.ModelSendNetMes("gscode.OpCode", "setRent","gs.SetRent",{ buildingId = self.m_data.info.id, rent = GetServerPriceNumber(price)})
end
-- 显示入住人数和总人数
function BuildingRentPartDetail:_initFunc()
    DataManager.m_ReqHouseGuidPrice(self.m_data.info.id)  --请求竞争力参数
    self.competitiSlider.minValue = functions.minCompetitive
    self.competitiSlider.maxValue = functions.maxCompetitive

    local str = string.format("%s<color=%s>/%s</color>",self.m_data.renter, BuildingRentPartDetail.static.NumberColor, PlayerBuildingBaseData[self.m_data.info.mId].npc)
    self.occupancyText.text = GetLanguage(12345678, str)
    self.competitivenessRoot.transform.localScale = Vector3.zero
    if self.m_data.info.ownerId ~= DataManager.GetMyOwnerID() then
        self.otherSee.localScale = Vector3.one
        self.confirmBtn.transform.localScale = Vector3.zero
        self.otherSeeRentText.text = GetClientPriceString(self.m_data.rent)

        self.rentRect.anchoredPosition = BuildingRentPartDetail.static.otherSeeRentPos
        self.competitiSlider.transform.localScale = Vector3.zero
        self.competitivenessRoot.anchoredPosition = BuildingRentPartDetail.static.otherSeeCompetitiPos
    else
        self.otherSee.localScale = Vector3.zero
        self.confirmBtn.transform.localScale = Vector3.one
        self.rentInput.text = GetClientPriceString(self.m_data.rent)

        self.rentRect.anchoredPosition = BuildingRentPartDetail.static.selfSeeRentPos
        self.competitiSlider.transform.localScale = Vector3.one
        self.competitivenessRoot.anchoredPosition = BuildingRentPartDetail.static.selfSeeCompetitiPos
    end
end
--
function BuildingRentPartDetail:_language()
    self.competitiSliderText01.text = GetLanguage(12345678)
    self.rentText02.text = GetLanguage(26040002)
    self.competValueText03.text = GetLanguage(43010001)
end
--
function BuildingRentPartDetail:_getGuidePrice(data)
    if data ~= nil then
        self.guideData = data
        local temp = ct.CalculationHouseCompetitivePower(data.guidePrice, self.m_data.rent, data.npc)
        if temp >= functions.maxCompetitive then
            self.competValueText.text = ">"..temp
        elseif temp <= functions.minCompetitive then
            self.competValueText.text = "<"..temp
        else
            self.competValueText.text = string.format("%0.1f", temp)
        end
        BuildingRentPartDetail.sliderCanChange = false
        self.competitiSlider.value = temp
    end
end
