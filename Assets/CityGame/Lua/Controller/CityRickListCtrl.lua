---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by password.
--- DateTime: 2019/8/17 14:40
---City Ranking
CityRickListCtrl = class('CityRickListCtrl',UIPanel)
UIPanel:ResgisterOpen(CityRickListCtrl)

local cityRickListBehaviour

function CityRickListCtrl:bundleName()
    return "Assets/CityGame/Resources/View/CityRickListPanel.prefab"
end

function CityRickListCtrl:initialize()
    UIPanel.initialize(self,UIType.PopUp,UIMode.NeedBack,UICollider.None)
end

function CityRickListCtrl:Awake(go)
    self:_getComponent(go)
    cityRickListBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    cityRickListBehaviour:AddClick(self.back,self.OnBack,self)

end

function CityRickListCtrl:Active()
    UIPanel.Active(self)
    self.name.text = GetLanguage(45010007)
    self.rank.text = GetLanguage(45010015)
    self.income.text = GetLanguage(45010017)
    self.staff.text = GetLanguage(45010018)
    self.technology.text = GetLanguage(45010019)
    self.market.text = GetLanguage(45010020)
end

function CityRickListCtrl:Refresh()
    self:initData()
end

function CityRickListCtrl:Hide()
    UIPanel.Hide(self)
    if self.rankItem then
        for i, v in pairs(self.rankItem) do
            destroy(v.prefab.gameObject)
        end
    end
    self.rankItem = {}
end

function CityRickListCtrl:Close()

end

function CityRickListCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end

function CityRickListCtrl:OnBack()
    UIPanel.ClosePage()
end

--Get components
function CityRickListCtrl:_getComponent(go)
    self.back = go.transform:Find("top/back").gameObject
    self.name = go.transform:Find("top/back/Text"):GetComponent("Text")
    self.rank = go.transform:Find("title/rank"):GetComponent("Text")
    self.income = go.transform:Find("title/income"):GetComponent("Text")
    self.staff = go.transform:Find("title/staff"):GetComponent("Text")
    self.technology = go.transform:Find("title/technology"):GetComponent("Text")
    self.market = go.transform:Find("title/market"):GetComponent("Text")
    self.content = go.transform:Find("Scroll View/Viewport/Content"):GetComponent("RectTransform")
    self.cityRankItem = go.transform:Find("Scroll View/Viewport/Content/RankItem").gameObject
    self.myRankItem = go.transform:Find("Scroll View/myRankItem")
    self.myRank = go.transform:Find("Scroll View/myRankItem/rank"):GetComponent("Text")
    self.myIcon = go.transform:Find("Scroll View/myRankItem/head/icon")
    self.myName = go.transform:Find("Scroll View/myRankItem/head/name"):GetComponent("Text")
    self.myIncome = go.transform:Find("Scroll View/myRankItem/income"):GetComponent("Text")
    self.myStaff = go.transform:Find("Scroll View/myRankItem/staff"):GetComponent("Text")
    self.myTechnology = go.transform:Find("Scroll View/myRankItem/technology"):GetComponent("Text")
    self.myMarket = go.transform:Find("Scroll View/myRankItem/market"):GetComponent("Text")
end

function CityRickListCtrl:initData()
    DataManager.DetailModelRpcNoRet(self.m_data.insId , 'm_queryRanking',DataManager.GetMyOwnerID())   ---Leaderboard
end

function CityRickListCtrl:OnBack()
    UIPanel.ClosePage()
end

function CityRickListCtrl:_receiveRanking(info)
    if info.info then
        local data = ct.deepCopy(info.info)
        if #info.info > 10 then
            self.myRankItem.localScale = Vector3.one
            if self.my_avatarData ~= nil then
                AvatarManger.CollectAvatar(self.my_avatarData)
                self.my_avatarData = nil
            end
            self.my_avatarData = AvatarManger.GetSmallAvatar(info.info[#info.info].faceId,self.myIcon,0.15)
            self.myRank.text = ">10"
            self.myName.text = info.info[#info.info].name
            self.myIncome.text = info.info[#info.info].income
            self.myStaff.text = info.info[#info.info].woker
            self.myTechnology.text = info.info[#info.info].science
            self.myMarket.text = info.info[#info.info].promotion
            table.remove(data)
        else
            self.myRankItem.localScale = Vector3.zero
        end
        self.rankItem = {}
        for i, v in ipairs(data) do
            local prefab = createPrefabs(self.cityRankItem,self.content)
            self.rankItem[i] = CityRankItem:new(cityRickListBehaviour,prefab,v,i)
        end
    end
end
