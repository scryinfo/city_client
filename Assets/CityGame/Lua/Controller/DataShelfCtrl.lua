---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by password.
--- DateTime: 2019/8/2 18:14
--- 数据公司上架界面
DataShelfCtrl = class('DataShelfCtrl',UIPanel)
UIPanel:ResgisterOpen(DataShelfCtrl)

local shelfBehaviour
function DataShelfCtrl:bundleName()
    return "Assets/CityGame/Resources/View/DataShelfPanel.prefab"
end

function DataShelfCtrl:initialize()
    UIPanel.initialize(self,UIType.PopUp,UIMode.NeedBack,UICollider.None)--可以回退，UI打开后，不隐藏其它的UI
end

function DataShelfCtrl:Awake(obj)
    self:_getComponent(obj)
    shelfBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    shelfBehaviour:AddClick(self.back,self.OnBack,self)
    shelfBehaviour:AddClick(self.tipBtn,self.OnTipBtn,self)    --自动补货介绍
    shelfBehaviour:AddClick(self.competitivenessBtn,self.OnCompetitivenessBtn,self)    --竞争力介绍
    shelfBehaviour:AddClick(self.downShelfBtn,self.OnDownShelfBtn,self)    --下架
    shelfBehaviour:AddClick(self.addShelfBtn,self.OnAddShelfBtn,self)    --上架
    shelfBehaviour:AddClick(self.confirmBtn,self.OnConfirmBtn,self)    --修改货架
    shelfBehaviour:AddClick(self.close,self.OnClose,self)

    Event.AddListener("c_DelShelf",self.c_DelShelf,self)

    self.automaticSwitch.onValueChanged:AddListener(function(isOn)     --自动补货
        self:OnAutomaticSwitch(isOn)
    end)
    self.inputNum.onValueChanged:AddListener(function()     --数量
        self:OnInputNum()
    end)
    self.sliderNum.onValueChanged:AddListener(function()     --数量
        self:OnSliderNum()
    end)
    self.inputPrice.onValueChanged:AddListener(function()     --价格
        self:OnInputPrice()
    end)
    self.sliderPrice.onValueChanged:AddListener(function()     --价格
        self:OnSliderPrice()
    end)
end

function DataShelfCtrl:Active()
    UIPanel.Active(self)
end

function DataShelfCtrl:Refresh()
    self:initData()
end

function DataShelfCtrl:Hide()
    UIPanel.Hide(self)
    self.inputNum.text = ""
    self.sliderNum.value = 0
    self.inputPrice.text = ""
    self.sliderPrice.value = 0
end

function DataShelfCtrl:Close()
    Event.RemoveListener("c_DelShelf",self,c_DelShelf,self)
end

function DataShelfCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end

--获取组件
function DataShelfCtrl:_getComponent(go)
    self.back = go.transform:Find("bgBtn").gameObject
    self.name = go.transform:Find("contentRoot/top/topName"):GetComponent("Text")
    self.explain = go.transform:Find("contentRoot/content/goodsInfo/bg/Text"):GetComponent("Text")
    self.base = go.transform:Find("contentRoot/content/goodsInfo/bg/base/Text"):GetComponent("Text")
    self.sale = go.transform:Find("contentRoot/content/goodsInfo/bg/sale/Text"):GetComponent("Text")
    self.iconName = go.transform:Find("contentRoot/content/goodsInfo/card/name/Text"):GetComponent("Text")
    self.icon = go.transform:Find("contentRoot/content/goodsInfo/card/cardImage/Image"):GetComponent("Image")
    self.automaticSwitch = go.transform:Find("contentRoot/content/detailsInfo/automaticSwitch"):GetComponent("Toggle") --自动补货
    self.replenishment = go.transform:Find("contentRoot/content/detailsInfo/tipText"):GetComponent("Text")
    self.numText = go.transform:Find("contentRoot/content/detailsInfo/totalNumber"):GetComponent("Text")
    self.totalNum = go.transform:Find("contentRoot/content/detailsInfo/totalNumber/bg/totalNumberText"):GetComponent("Text")
    self.totalBg = go.transform:Find("contentRoot/content/detailsInfo/totalNumber/bg")
    self.inputNum = go.transform:Find("contentRoot/content/detailsInfo/numberInput"):GetComponent("InputField")
    self.tipBtn = go.transform:Find("contentRoot/content/detailsInfo/tipBtn").gameObject
    self.tipBg = go.transform:Find("contentRoot/content/detailsInfo/tipBtn/tipBg")
    self.tipText = go.transform:Find("contentRoot/content/detailsInfo/tipBtn/tipBg/Text"):GetComponent("Text")
    self.sliderNum = go.transform:Find("contentRoot/content/detailsInfo/numberSlider"):GetComponent("Slider")
    self.competitiveness = go.transform:Find("contentRoot/content/detailsInfo/Text"):GetComponent("Text")
    self.competitivenessText = go.transform:Find("contentRoot/content/detailsInfo/tipPriceBg/priceText"):GetComponent("Text")
    self.competitivenessBtn = go.transform:Find("contentRoot/content/detailsInfo/tipPriceBg/tipBtn").gameObject
    self.competitivenessTip = go.transform:Find("contentRoot/content/detailsInfo/tipPriceBg/tipBgBtn").gameObject
    self.competitivenessTipText = go.transform:Find("contentRoot/content/detailsInfo/tipPriceBg/tipBgBtn/tipText"):GetComponent("Text")
    self.price = go.transform:Find("contentRoot/content/detailsInfo/price"):GetComponent("Text")
    self.inputPrice = go.transform:Find("contentRoot/content/detailsInfo/priceInput"):GetComponent("InputField")
    self.sliderPrice = go.transform:Find("contentRoot/content/detailsInfo/competitivenessSlider"):GetComponent("Slider")
    self.downShelfBtn = go.transform:Find("contentRoot/bottom/downShelfBtn").gameObject    --下架
    self.shelfText = go.transform:Find("contentRoot/bottom/downShelfBtn/text"):GetComponent("Text")
    self.addShelfBtn = go.transform:Find("contentRoot/bottom/addShelfBtn").gameObject    --上架
    self.addShelfText = go.transform:Find("contentRoot/bottom/addShelfBtn/text"):GetComponent("Text")
    self.confirmBtn = go.transform:Find("contentRoot/bottom/confirmBtn").gameObject     --修改货架
    self.close = go.transform:Find("close").gameObject     --修改货架

end

--初始化数据
function DataShelfCtrl:initData()
    LoadSprite(ResearchConfig[self.m_data.itemId].iconPath, self.icon, true)
    self.iconName.text = GetLanguage(ResearchConfig[self.m_data.itemId].name)
    self.base.text = self.m_data.wareHouse
    self.sale.text = self.m_data.sale
    self.sliderNum.maxValue = self.m_data.wareHouse + self.m_data.sale
    self.sliderPrice.maxValue = 100
    if self.m_data.shelf == Shelf.AddShelf then
        self.addShelfBtn.transform.localScale = Vector3.one
        self.confirmBtn.transform.localScale = Vector3.zero
        self.automaticSwitch.isOn = false
        self.isOn = false
        self.downShelfBtn.transform.localScale = Vector3.zero
    elseif self.m_data.shelf == Shelf.SetShelf then
        self.addShelfBtn.transform.localScale = Vector3.zero
        self.confirmBtn.transform.localScale = Vector3.one
        self.automaticSwitch.isOn = self.m_data.autoReplenish
        self.isOn = self.m_data.autoReplenish
        if self.isOn then
           self.totalNum.text =  self.m_data.wareHouse + self.m_data.sale
        end
        self.inputNum.text = self.m_data.sale
        self.sliderNum.value = self.m_data.sale
        self.inputPrice.text = GetClientPriceString(self.m_data.price)
        self.sliderPrice.value = tonumber(GetClientPriceString(self.m_data.price))
        self.downShelfBtn.transform.localScale = Vector3.one
    end
end

--返回
function DataShelfCtrl:OnBack()
    UIPanel.ClosePage()
end

--自动补货介绍
function DataShelfCtrl:OnTipBtn(go)
    go.tipBg.localScale = Vector3.one
    go.close.transform.localScale = Vector3.one
end

--竞争力介绍
function DataShelfCtrl:OnCompetitivenessBtn(go)
    go.competitivenessTip:SetActive(true)
    go.close.transform.localScale = Vector3.one
end

--下架
function DataShelfCtrl:OnDownShelfBtn(go)
    local data={ReminderType = ReminderType.Warning,ReminderSelectType = ReminderSelectType.Select,
                content = GetLanguage(25060017),func = function()
            DataManager.DetailModelRpcNoRet(go.m_data.building, 'm_delShelf',go.m_data.building,go.m_data.itemId,go.sliderNum.value)
        end  }
    ct.OpenCtrl('NewReminderCtrl',data)
end

--上架
function DataShelfCtrl:OnAddShelfBtn(go)
        if go.isOn then
            local num = go.m_data.wareHouse + go.m_data.sale
            if num == 0 then
                Event.Brocast("SmallPop",GetLanguage(25030025), ReminderType.Warning)
                return
            end
            DataManager.DetailModelRpcNoRet(go.m_data.building, 'm_addShelf',go.m_data.building,go.m_data.itemId,num,GetServerPriceNumber(go.inputPrice.text),go.isOn)
        else
            if go.sliderNum.value == 0 then
                Event.Brocast("SmallPop",GetLanguage(25030025), ReminderType.Warning)
                return
            end
            DataManager.DetailModelRpcNoRet(go.m_data.building, 'm_addShelf',go.m_data.building,go.m_data.itemId,go.sliderNum.value,GetServerPriceNumber(go.inputPrice.text),go.isOn)
        end
end

--修改货架
function DataShelfCtrl:OnConfirmBtn(go)
        if go.isOn then
            local num = go.m_data.wareHouse + go.m_data.sale
            if num == 0 then
                Event.Brocast("SmallPop",GetLanguage(25030025), ReminderType.Warning)
                return
            end
            DataManager.DetailModelRpcNoRet(go.m_data.building, 'm_setShelf',go.m_data.building,go.m_data.itemId,num,GetServerPriceNumber(go.inputPrice.text),go.isOn)
        else
            if go.sliderNum.value == 0 then
                Event.Brocast("SmallPop",GetLanguage(25030025), ReminderType.Warning)
                return
            end
            DataManager.DetailModelRpcNoRet(go.m_data.building, 'm_setShelf',go.m_data.building,go.m_data.itemId,go.sliderNum.value,GetServerPriceNumber(go.inputPrice.text),go.isOn)
        end
end

--自动补货
function DataShelfCtrl:OnAutomaticSwitch(isOn)
    self.isOn = isOn
    if isOn then
        self.totalBg.localScale = Vector3.one
        self.inputNum.transform.localScale = Vector3.zero
        self.sliderNum.transform.localScale = Vector3.zero
        self.totalNum.text = self.m_data.wareHouse + self.m_data.sale
    else
        self.totalBg.localScale = Vector3.zero
        self.inputNum.transform.localScale = Vector3.one
        self.sliderNum.transform.localScale = Vector3.one
    end
end

function DataShelfCtrl:OnClose(go)
    go.tipBg.localScale = Vector3.zero
    go.close.transform.localScale = Vector3.zero
    go.competitivenessTip:SetActive(false)
end

--数量
function DataShelfCtrl:OnInputNum()
    if self.inputNum.text == "" then
        self.inputNum.text = 0
    end
    self.inputNum.text = tonumber(self.inputNum.text)
    self.sliderNum.value = tonumber(self.inputNum.text)
end

--数量
function DataShelfCtrl:OnSliderNum()
    self.inputNum.text = self.sliderNum.value
end

--价格
function DataShelfCtrl:OnInputPrice()
    if self.inputPrice.text == "" then
        self.inputPrice.text = 0
    end
    self.inputPrice.text = tonumber(self.inputPrice.text)
    self.sliderPrice.value = tonumber(self.inputPrice.text)
end

--价格
function DataShelfCtrl:OnSliderPrice()
    if self.sliderPrice.value <= 100 then
        self.inputPrice.text = self.sliderPrice.value
    end
end

--下架回调
function DataShelfCtrl:c_DelShelf(info)
    Event.Brocast("SmallPop",GetLanguage(25060007), ReminderType.Succeed)
    UIPanel.ClosePage()
end
