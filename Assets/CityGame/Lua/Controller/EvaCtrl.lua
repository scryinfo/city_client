---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2019/5/24 11:32
---

EvaCtrl = class("EvaCtrl", UIPanel)
UIPanel:ResgisterOpen(EvaCtrl)

EvaCtrl.static.PropertyTrueItemPath = "View/Eva/PropertyTrueItem"  -- 可升级属性预制路径
EvaCtrl.static.PropertyFalseItemPath = "View/Eva/PropertyFalseItem"  -- 不可升级属性预制路径

function EvaCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function EvaCtrl:bundleName()
    return "Assets/CityGame/Resources/View/EvaPanel.prefab"
end

function EvaCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function EvaCtrl:Awake()
    local luaBehaviour = self.gameObject:GetComponent("LuaBehaviour")

    luaBehaviour:AddClick(EvaPanel.backBtn, self.OnBack, self)
    luaBehaviour:AddClick(EvaPanel.startAddBtn.gameObject, self.OnStartAdd, self)
    luaBehaviour:AddClick(EvaPanel.addBtn.gameObject, self.OnAdd, self)
    luaBehaviour:AddClick(EvaPanel.introductionBtn, self.OnIntroduction, self)
    --luaBehaviour:AddClick(EvaPanel.closeTipsBtn.gameObject, self.OnCloseTips, self)

    -- Eva节点2
    self.evaOptionTwoSource = UnityEngine.UI.LoopScrollDataSource.New()
    self.evaOptionTwoSource.mProvideData = EvaCtrl.static.evaOptionTwoData
    self.evaOptionTwoSource.mClearData = EvaCtrl.static.evaOptionTwoClearData

    -- Eva节点3
    self.evaOptionThereSource = UnityEngine.UI.LoopScrollDataSource.New()
    self.evaOptionThereSource.mProvideData = EvaCtrl.static.evaOptionThereData
    self.evaOptionThereSource.mClearData = EvaCtrl.static.evaOptionThereClearData

    -- 属性节点
    self.propertySource = UnityEngine.UI.LoopScrollDataSource.New()
    self.propertySource.mProvideData = EvaCtrl.static.propertyData
    self.propertySource.mClearData = EvaCtrl.static.propertyClearData

    -- 保存实例
    EvaCtrl.static.evaCtrl = self
    self.resultTab = {EvaPanel.ResultRootO, EvaPanel.ResultRootTwo, EvaPanel.ResultRootThere}
end

function EvaCtrl:Active()
    UIPanel.Active(self)
    self:_addListener()

    -- 多语言适配
    EvaPanel.titleText.text = "EVA" --GetLanguage(31010001)
    EvaPanel.desText.text = GetLanguage(28040024)
    EvaPanel.addBtnText.text = GetLanguage(31010013)
    EvaPanel.introductionTextT.text = GetLanguage(31020001)
end

function EvaCtrl:Refresh()
    self:initInsData()
    self:updateData()
end

function EvaCtrl:Hide()
    self:_removeListener()
    UIPanel.Hide(self)
end

function EvaCtrl:Close()
    EvaCtrl.static.evaCtrl = nil
    UIPanel.Close(self)
end

-- 初始化基本数据
function EvaCtrl:updateData()
    -- 显示eva点数
    EvaPanel.myEvaText.text = DataManager.GetEvaPoint()
    -- Eva选择记录的个数
    self.evaRecordData = {}
    -- 打开开始加点，关闭加点
    EvaPanel.addBtn.localScale = Vector3.one
    EvaPanel.startAddBtn.localScale = Vector3.zero
    -- 关闭eva小提示
    self:_showIntroduction( false )

    -- 生成标题item
    if self.evaTitleItem then
        DataManager.DetailModelRpcNoRet(OpenModelInsID.EvaCtrl, 'm_QueryMyEva')
    else
        -- 生成大标题
        self.evaTitleItem = {}
        for i, v in ipairs(EvaConfig) do
            local function callback(obj)
                self.evaTitleItem[i] = EvaTitleItemOne:new(obj, 1, i)
                if i == #EvaConfig then
                    DataManager.DetailModelRpcNoRet(OpenModelInsID.EvaCtrl, 'm_QueryMyEva')
                end
            end
            DynamicLoadPrefab("Assets/CityGame/Resources/View/Eva/EvaTitleItem.prefab", EvaPanel.optionOneScroll, nil, callback)
        end
    end
end

-- eva小提示是否显示
function EvaCtrl:_showIntroduction(isShow)
    self.isShowTips = isShow
    EvaPanel.introductionImage.localScale = isShow and Vector3.one or Vector3.zero
    EvaPanel.introductionText.localScale = isShow and Vector3.one or Vector3.zero
end

-- 清理Eva数据以及界面显示
function EvaCtrl:_clearEvaDataAndView()
    -- 数据
    self.addData = {}
    self.addEvaData = {}
    self.addEvaLvData = {}

    -- 界面上显示的加点多少
    for _, v in ipairs(self.evaTitleItem) do
        v:_setAddNumber()
    end
    for _, k in pairs(EvaCtrl.optionTwoScript) do
        k:_setAddNumber()
    end
    for _, j in pairs(EvaCtrl.optionThereScript) do
        j:_setAddNumber()
    end

    -- 关闭加点，并清理加点的界面数据
    for _, i in pairs(EvaCtrl.propertyScript) do
        i:_setAddExNumInputField("")
    end
end
-------------------------------------------------------------- 按钮点击事件 --------------------------------------------------------
-- 关闭Eva界面
function EvaCtrl:OnBack(go)
    PlayMusEff(1002)
    -- 判断有没有加点数据，如果有，则提示，没有则退出
    if go.addEvaData then
        local isHaveEvaAddData
        for _, v in pairs(go.addEvaData) do
            isHaveEvaAddData = true
            break
        end
        if isHaveEvaAddData then
            local data={ReminderType = ReminderType.Common,ReminderSelectType = ReminderSelectType.Select,
                        content = GetLanguage(31010023),func = function()
                    -- 清理eva数据
                    go:_clearEvaDataAndView()
                    UIPanel.ClosePage()
                end  }
            ct.OpenCtrl('NewReminderCtrl',data)
        else
            UIPanel.ClosePage()
        end
    else
        UIPanel.ClosePage()
    end
end

-- 开始加点，打开加点界面
--function EvaCtrl:OnStartAdd(go)
--    PlayMusEff(1002)
    --EvaPanel.startAddBtn.localScale = Vector3.zero
    --EvaPanel.addBtn.localScale = Vector3.one
    --go.isStartAdd = true

    -- 打开加点
    --for _, v in ipairs(EvaCtrl.propertyScript) do
    --    v:_showBtnState(false)
    --end

--end

-- 加点，向服务器发起加点消息
function EvaCtrl:OnAdd(go)
    PlayMusEff(1002)
    --EvaPanel.startAddBtn.localScale = Vector3.one
    --EvaPanel.addBtn.localScale = Vector3.zero
    --go.isStartAdd = false

    local evas = {}
    for _, v in pairs(go.addEvaData) do
        table.insert(evas, v)
    end
    if not  next(evas) then
        return
    end
    DataManager.DetailModelRpcNoRet(OpenModelInsID.EvaCtrl, 'm_UpdateMyEvas', {eva = evas})
    go:_clearEvaDataAndView()
end

--显示eva介绍
function EvaCtrl:OnIntroduction(go)
    PlayMusEff(1002)
    --ct.OpenCtrl("CompanyIntroductionCtrl")
    go:_showIntroduction( not go.isShowTips )
end

--关闭eva小提示
--function EvaCtrl:OnCloseTips(go)
--    PlayMusEff(1002)
--    EvaPanel.closeTipsBtn.localScale = Vector3.zero
--    --CompanyCtrl.static.companyMgr:ClsoeTips()
--end

-------------------------------------------------------------- 网络消息相关 --------------------------------------------------------
-- 打开model
function EvaCtrl:initInsData()
    DataManager.OpenDetailModel(EvaModel, OpenModelInsID.EvaCtrl)
end

-- 监听Model层网络回调
function EvaCtrl:_addListener()
    Event.AddListener("c_OnQueryMyEva", self.c_OnQueryMyEva, self)
    Event.AddListener("c_OnUpdateMyEvas", self.c_OnUpdateMyEvas, self)
end

-- 注销model层网络回调
function EvaCtrl:_removeListener()
    Event.RemoveListener("c_OnQueryMyEva", self.c_OnQueryMyEva, self)
    Event.RemoveListener("c_OnUpdateMyEvas", self.c_OnUpdateMyEvas, self)
end

-- 服务器查询Eva，并把Eva信息保存下來，并默认显示第一项
function EvaCtrl:c_OnQueryMyEva(evas)
    self.evasData = evas.eva
    self.addData = {}
    self.addEvaData = {}
    self.addEvaLvData = {}
    self.evaTitleItem[1]:_onClickBtn()
end

-- 服务器返回的Eva加点
function EvaCtrl:c_OnUpdateMyEvas(evas)
    ct.OpenCtrl("EvaPopCtrl", evas.resultInfo)
    local tempDecEva = 0
    for i, v in ipairs(evas.resultInfo) do
        tempDecEva = tempDecEva + v.evasInfo.old_eva.decEva
        for j, k in ipairs(self.evasData) do
            if v.evasInfo.old_eva.id == k.id then
                self.evasData[j] = v.evasInfo.old_eva
                break
            end
        end
    end
    local evaPoint = DataManager.GetEvaPoint()
    evaPoint = evaPoint - tempDecEva
    EvaPanel.myEvaText.text = tostring(evaPoint)
    DataManager.SetEvaPoint(evaPoint)
end

-------------------------------------------------------------- 滑动复用相关 --------------------------------------------------------
-- Eva选项2信息显示
EvaCtrl.static.evaOptionTwoData = function(transform, idx)
    idx = idx + 1
    EvaCtrl.optionTwoScript[idx] = EvaTitleItemTwo:new(transform, 2, idx)
end

EvaCtrl.static.evaOptionTwoClearData = function(transform)
end

-- Eva选项3信息显示
EvaCtrl.static.evaOptionThereData = function(transform, idx)
    idx = idx + 1
    EvaCtrl.optionThereScript[idx] = EvaTitleItemThere:new(transform, 3, idx)
end

EvaCtrl.static.evaOptionThereClearData = function(transform)
end

-- 属性信息显示
EvaCtrl.static.propertyData = function(transform, idx)
    idx = idx + 1
    if EvaCtrl.propertyAllData[1][idx].b == -1 then -- 可升级
        EvaCtrl.propertyScript[idx] = PropertyTrueItem:new(transform, EvaCtrl.propertyAllData[1][idx], EvaCtrl.propertyAllData[2][idx])
    else
        PropertyFalseItem:new(transform, EvaCtrl.propertyAllData[1][idx], EvaCtrl.propertyAllData[2][idx].name)
    end
end

EvaCtrl.static.propertyClearData = function(transform)
end

-- 刷新Eva滑动选项2的信息
function EvaCtrl:ShowOptionTwo(itemNumber)
    EvaCtrl.optionTwoScript = {}
    EvaPanel.optionTwoScroll:ActiveLoopScroll(self.evaOptionTwoSource, itemNumber, "View/Eva/EvaBtnTwoItem")
    --EvaPanel.optionTwoScroll:RefillCells()
end

-- 刷新Eva滑动选项3的信息
function EvaCtrl:ShowOptionThere(itemNumber)
    EvaCtrl.optionThereScript = {}
    EvaPanel.optionThereScroll:ActiveLoopScroll(self.evaOptionThereSource, itemNumber, "View/Eva/EvaBtnThereItem")
    --EvaPanel.optionThereScroll:RefillCells()
end

-------------------------------------------------------------- 界面显示 --------------------------------------------------------
-- 生成Eva属性item
function EvaCtrl:CreatePropertyItem(propertyTab)
    if not propertyTab then
        return
    end
    EvaCtrl.propertyAllData = {{}, {}}
    local propertyPrefabList = {}

    -- 获得显示数据
    for _, b in ipairs(propertyTab) do
        for _, v in ipairs(self.evasData) do
            if b.Atype == v.at and b.Btype == v.bt then
                table.insert(EvaCtrl.propertyAllData[1], v) -- 保存实际数据
                table.insert(EvaCtrl.propertyAllData[2], b) -- 保存本地配置
                if v.b == -1 then -- 可升级b
                    table.insert(propertyPrefabList, EvaCtrl.static.PropertyTrueItemPath)
                else -- 不可升级，显示知名度
                    table.insert(propertyPrefabList, EvaCtrl.static.PropertyFalseItemPath)
                end
            end
        end
    end

    -- 刷新界面上的数据显示
    EvaPanel.iconImageTF.localScale = Vector3.New(0, 0, 0)
    local imgPath
    if self.evaRecordData[1] == 1 then
        imgPath = Material[propertyTab[1].Atype].img
        EvaPanel.iconTF.localScale = Vector3.New(0.5, 0.5, 1)
    elseif self.evaRecordData[1] == 2 then
        imgPath = Good[propertyTab[1].Atype].img
        EvaPanel.iconTF.localScale = Vector3.New(0.5, 0.5, 1)
    else
        imgPath = BrandItem.static.brandIcon[propertyTab[1].Atype]
        EvaPanel.iconTF.localScale = Vector3.New(1, 1, 1)
    end
    LoadSprite(imgPath, EvaPanel.iconImage, true)

    local newTab = {}
    for i = 1, #self.resultTab do
        if i > #propertyPrefabList then
            self.resultTab[i]:_isShow(false)
        else
            self.resultTab[i]:_isShow(true)
            for m, n in ipairs(EvaCtrl.propertyAllData[2]) do
                local strId = string.format("%d%s", EvaCtrl.propertyAllData[2][m].Atype, EvaCtrl.propertyAllData[2][m].Btype)
                local myLv = EvaCtrl.propertyAllData[1][m].lv
                if EvaCtrl.static.evaCtrl.addEvaLvData[strId] then
                    myLv = EvaCtrl.static.evaCtrl.addEvaLvData[strId].myLv
                end
                if i == 1 then
                    if n.Btype == "ProduceSpeed"  or n.Btype == "PromotionAbility" or n.Btype == "InventionUpgrade" or n.Btype == "EvaUpgrade" then
                        self.resultTab[i]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
                        self.resultTab[i]:_showData(myLv)
                        table.insert(newTab, m)
                        break
                    end
                    if n.Btype == "Quality" and (self.evaRecordData[1] == 3 or self.evaRecordData[1] == 4) then
                        self.resultTab[i]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
                        self.resultTab[i]:_showData(myLv)
                        table.insert(newTab, m)
                        break
                    end
                elseif i == 2 then
                    if n.Btype == "Brand" then
                        self.resultTab[i]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
                        self.resultTab[i]:_showData(myLv)
                        table.insert(newTab, m)
                        break
                    end
                    if n.Btype == "Quality" and (self.evaRecordData[1] == 2) then
                        self.resultTab[i]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
                        self.resultTab[i]:_showData(myLv)
                        table.insert(newTab, m)
                        break
                    end
                elseif i == 3 then
                    if m ~= newTab[2] then
                        if n.Btype == "Brand" then
                            self.resultTab[i]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
                            self.resultTab[i]:_showData(myLv)
                            table.insert(newTab, m)
                            break
                        end
                        if n.Btype == "Quality" and (self.evaRecordData[1] == 2) then
                            self.resultTab[i]:_initData(EvaCtrl.propertyAllData[1][m], EvaCtrl.propertyAllData[2][m])
                            self.resultTab[i]:_showData(myLv)
                            table.insert(newTab, m)
                            break
                        end
                    end
                end
            end
        end
    end

    -- 生成新的属性显示
    EvaCtrl.propertyScript = {}
    EvaPanel.propertyScroll:ActiveDiffItemLoop(self.propertySource, propertyPrefabList)
end

-- 设置Eva选择记录
function EvaCtrl:SetEvaRecord(index, data)
    if index == 1 then
        self.evaRecordData = {data}
    elseif index == 2 then
        self.evaRecordData[index] = data
        self.evaRecordData[3] = nil
    elseif index == 3 then
        self.evaRecordData[index] = data
    end

end

-- 获取Eva选项item的记录
function EvaCtrl:GetEvaRecordData()
    return self.evaRecordData
end

-- 重置按钮的状态
function EvaCtrl:SetBtnState(index)
    if index == 1 then
        for _, v in ipairs(self.evaTitleItem) do
            v:SetSelect(true)
            --v:SetNameTextColor(1)
        end
    elseif index == 2 then
        for _, v in ipairs(EvaCtrl.optionTwoScript) do
            v:SetSelect(true)
        end
    elseif index == 3 then
        for _, v in ipairs(EvaCtrl.optionThereScript) do
            v:SetSelect(true)
        end
    end
end