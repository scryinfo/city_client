---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/9/4 17:58
---
-----

BuildingInfoModel= {};
local this = BuildingInfoModel;

--Constructor--
function BuildingInfoModel.New()
    return this;
end

function BuildingInfoModel.Awake()
    this:OnCreate();
end

---test
function BuildingInfoModel.Update()
    if UnityEngine.Input.GetKeyDown(UnityEngine.KeyCode.Q) then
        this.rightFinish = false
        this.bottomFinish = false

        local msgBuildTransfer = {}
        local msgBuildTransferRightInfo = {}  --Information to be displayed on the right
        setmetatable(msgBuildTransfer, msgBuildTransferRightInfo)

        msgBuildTransferRightInfo.width = 2
        msgBuildTransferRightInfo.height = 3
        msgBuildTransferRightInfo.buildTime = 2018/09/05
        msgBuildTransferRightInfo.usedTime = 36
        msgBuildTransferRightInfo.oldPercent = 50

        --setmetatable(msgBuildTransfer, msgBuildTransferRightInfo)
        msgBuildTransfer.playerProtaitPath = ""
        msgBuildTransfer.playerID = 1001
        msgBuildTransfer.groundPrice = 1234
        msgBuildTransfer.buildPrice = 9876

        this.CreatBuildingInfoPanel(msgBuildTransfer)
    end

    --The right side is loaded
    if this.rightFinish and this.bottomFinish then

        BuildingInfoPanel.InitDate(this.buildingInfo)
        this.rightFinish = false
        this.bottomFinish = false
    end

    --Successful transfer message
    if UnityEngine.Input.GetKeyDown(UnityEngine.KeyCode.W) then
        BuildingInfoPanel.TransferSuccess(256984)
        BuildingTransferPanel.Close()
    end
end

--Start event--
function BuildingInfoModel.OnCreate()
    --UpdateBeat:Add(this.Update, this);
    --Network callback registration
    --CityEngineLua.Message:registerNetMsg(pb.gsCode.login,BuildingInfoModel.TransferSuccess);
end

--Create message UI
function BuildingInfoModel.CreatBuildingInfoPanel(panelInfo)
    this.buildingInfo = panelInfo
    this.rightFinish = false
    this.bottomFinish = false

    panelMgr:LoadPrefab_A('BuildingInfo', nil, this.OnPanelCreated);
    --Add the interface on the right
    panelMgr:LoadPrefab_A('BuildingInfoRight', nil, this, this.OnRightPanelCreated);
end

--When the interface is generated, add monitoring
function BuildingInfoModel.OnPanelCreated(obj)
    local panelObj = ct.InstantiatePrefab(obj);
    local groundAuctionBehaviour = panelObj:GetComponent('LuaBehaviour');
    groundAuctionBehaviour:AddClick(BuildingInfoPanel.transferBtn.gameObject, this.OpenTransferPage);
    groundAuctionBehaviour:AddClick(BuildingInfoPanel.buyBtn.gameObject, this.SendBuyInfoToServer);
    groundAuctionBehaviour:AddClick(BuildingInfoPanel.cancelTransferBtn.gameObject, this.SendCancelTransferToServer);
    groundAuctionBehaviour:AddClick(BuildingInfoPanel.dismantleBtn.gameObject, this.SendDismantleToServer);

    this.bottomFinish = true
end

--The right panel is loaded
function BuildingInfoModel.OnRightPanelCreated(rightPanelObj)
    logDebug("转让界面，右侧加载完毕")
    BuildingInfoPanel.OnCreatRightInfo()
    this.rightFinish = true
end

--Open the transfer interface
function BuildingInfoModel.OpenTransferPage()
    --panelMgr:LoadPrefab_A('BuildingTransfer', this.OnPanelCreated, this);
end

--- Client request ---
--Send a message to the server
function BuildingInfoModel.SendTransferInfoToServer(transferPrice)
    --Tentatively, the server needs the building ID and transfer fee
    --Wait until the server's protocol is set before adding

    logDebug("确认转让："..transferPrice)
    local transferBubbleInfo = this.buildingInfo
    transferBubbleInfo.area = {}
    transferBubbleInfo.area.x = 0
    transferBubbleInfo.area.y = 0

    transferBubbleInfo.bubbleType = BubblleType.BuildingTransfer
    transferBubbleInfo.func = function(info)
        if info.bubbleType ~= BubblleType.BuildingTransfer then
            return
        end
        info.isTransfering = true
        this.CreatBuildingInfoPanel(info)  --Open the transfer interface
    end

    GameBubbleManager.CreatBubble(transferBubbleInfo)
end

--Buy land
function BuildingInfoModel.SendBuyInfoToServer()
    logDebug("---- lalala 买别人转让的地了！！！")
    --It is still necessary to determine whether the owner is himself-it is not known whether it is directly taken in the building information
end

--Cancel transfer
function BuildingInfoModel.SendCancelTransferToServer()
    logDebug("---- aaaaa 取消转让 ！！！")

end

--tear down
function BuildingInfoModel.SendDismantleToServer()
    logDebug("---- bbbbb 拆除 ！！！")

end

--- Server callback ---
--Successful transfer
function BuildingInfoModel.TransferSuccess(stream)
    --Deserialization---

    BuildingInfoPanel.TransferSuccess(stream)
end

--When clicking into another person's transfer building, the transfer amount has changed
function BuildingInfoModel.TransferInfoChange(stream)
    --temp--
    
    BuildingInfoPanel.TransferInfoChange(stream)
end

--Building information changes
function BuildingInfoModel.BuildingInfoUpdate(stream)
    BuildingInfoRightPanel.UpdateInfo(stream)
end

--Close event--
function BuildingInfoModel.Close()
    --Event.RemoveListener("OnLogin", this.OnLogin);
end
