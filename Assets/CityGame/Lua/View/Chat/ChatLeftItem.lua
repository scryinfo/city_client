---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2018/12/18 9:44
---

ChatLeftItem = class('ChatLeftItem')

-- 初始化
function ChatLeftItem:initialize(itemId, prefab, data)
    self.prefab = prefab
    self.data = data
    self.data.itemId = itemId
    --self.data.company = "Scry"

    local transform = prefab.transform
    -- 头像
    self.headBtn = transform:Find("HeadBg").gameObject
    -- 头像图片
    self.headImage = transform:Find("HeadBg/HeadImage")
    -- 说话人的背景
    self.playerNameImage = transform:Find("PlayerNameImage"):GetComponent("RectTransform")
    -- 说话人的名字
    self.playerNameText = transform:Find("PlayerNameImage/PlayerNameText"):GetComponent("Text")
    -- 聊天的背景
    self.chatBg = transform:Find("ChatBg")
    -- 聊天的内容
    self.chatText = transform:Find("ChatBg/ChatText"):GetComponent("Text")

    self.playerNameText.text = self.data.name
    self.chatText.text = self.data.msg

    local chatTextPreferredWidth = self.chatText.preferredWidth
    local transformSizeDelta = transform.sizeDelta
    if chatTextPreferredWidth > 580 then
        self.chatText.transform.sizeDelta = Vector2.New(580, 60)
        self.chatText.verticalOverflow = UnityEngine.VerticalWrapMode.Overflow
        local chatTextPreferredHeight = self.chatText.preferredHeight
        self.chatText.transform.sizeDelta = Vector2.New(580, chatTextPreferredHeight)
        self.playerNameImage.anchoredPosition = Vector2.New(190, chatTextPreferredHeight + 66)
        transformSizeDelta.y = chatTextPreferredHeight + 130
        transform.sizeDelta = Vector2.New(transformSizeDelta.x, chatTextPreferredHeight + 130)
    else
        self.chatText.transform.sizeDelta = Vector2.New(chatTextPreferredWidth, 30)
        self.playerNameImage.anchoredPosition = Vector2.New(190, 97)
    end

    if self.data.channel == "WORLD" then
        transform.sizeDelta = Vector2.New(1380, transformSizeDelta.y)
        ChatCtrl.static.luaBehaviour:AddClick(self.headBtn, self.OnHeadClick, self)
        --LoadSprite(PlayerHead[self.data.image].ChatPath, self.headImage, true)
        AvatarManger.GetSmallAvatar(self.data.image, self.headImage,0.2)
    else
        if self.data.id == DataManager.GetMyOwnerID() then
            --LoadSprite(PlayerHead[DataManager.GetFaceId()].ChatPath, self.headImage, true)
            AvatarManger.GetSmallAvatar(DataManager.GetFaceId(), self.headImage,0.2)
        else
            --LoadSprite(PlayerHead[ChatCtrl.static.chatMgr:GetPlayerFaceId(self.data.id)].ChatPath, self.headImage, true)
            AvatarManger.GetSmallAvatar(ChatCtrl.static.chatMgr:GetPlayerFaceId(self.data.id), self.headImage,0.2)
        end
    end
end

function ChatLeftItem:OnHeadClick(go)
    PlayMusEff(1002)
    local friends = DataManager.GetMyFriends()
    if friends[go.data.id] ~= nil then -- 是好友，跳转好友界面
        --ChatCtrl.static.chatMgr:ShowPlayerInfo(1, go.data)
        ChatCtrl.static.isShowClickFriends = true
        ChatPanel.friendsToggle.isOn = true
        ChatCtrl.static.chatMgr:SetActivePlayerId(go.data.id)
    else -- 查询陌生人信息
        --ChatCtrl.static.chatMgr:ShowPlayerInfo(1, go.data)
        Event.Brocast("m_QueryPlayerInfoChat", {go.data.id})
    end
end