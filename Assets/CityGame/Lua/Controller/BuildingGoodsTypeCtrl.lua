---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Fisher.
--- DateTime: 2019/5/21 10:34
---Building Information Commodity Classification
BuildingGoodsTypeCtrl = class('BuildingGoodsTypeCtrl',UIPanel)
UIPanel:ResgisterOpen(BuildingGoodsTypeCtrl)

local ToNumber = tonumber
local StringSun = string.sub
function BuildingGoodsTypeCtrl:initialize()
    UIPanel.initialize(self,UIType.Normal,UIMode.HideOther,UICollider.None);
end

function BuildingGoodsTypeCtrl:bundleName()
    return "Assets/CityGame/Resources/View/BuildingGoodsTypePanel.prefab"
end

function BuildingGoodsTypeCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end
function BuildingGoodsTypeCtrl:Active()
    UIPanel.Active(self)
    --Store examples of categorized goods
    self.GoodsTypeDatas = {}
    --Store examples of classified buttons
    self.ButtonTypeData = {}
    Event.AddListener("goodsType",self.goodsType,self)
end
function BuildingGoodsTypeCtrl:Awake(go)
    self.gameObject = go
    self:_getComponent(go)
    self.luaBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    self.luaBehaviour:AddClick(self.closeBtn.gameObject,self._clickCloseBtn,self)
end

function BuildingGoodsTypeCtrl:Refresh()
    self:initializeUiInfoData()
end

function BuildingGoodsTypeCtrl:Hide()
    UIPanel.Hide(self)
    self:closeDestroy()
    if next(self.ButtonTypeData) ~= nil then
        for key,value in pairs(self.ButtonTypeData) do
            destroy(value.prefab.gameObject)
            self.ButtonTypeData[key] = nil
        end
    end
    Event.RemoveListener("goodsType",self.goodsType,self)
end
-------------------------------------------------------------Get components-------------------------------------------------------------------------------
function BuildingGoodsTypeCtrl:_getComponent(go)
    --topRoot
    self.closeBtn = go.transform:Find("topRoot/top/closeBtn")
    self.topName = go.transform:Find("topRoot/top/topName"):GetComponent("Text")
    self.buttonScrollView = go.transform:Find("topRoot/button/ScrollView")
    self.buttonContent = go.transform:Find("topRoot/button/ScrollView/Viewport/Content")
    --content
    self.contentContent = go.transform:Find("content/ScrollView/Viewport/Content")

    --Prefab
    self.ButtonTypeItem = go.transform:Find("topRoot/button/ScrollView/Viewport/Content/ButtonType").gameObject
    self.GoodsTypeItem = go.transform:Find("content/ScrollView/Viewport/Content/GoodsTypeItem").gameObject
end
------------------------------------------------------------Initialization function--------------------------------------------------------------------------------
--Initialize UI data
function BuildingGoodsTypeCtrl:initializeUiInfoData()
    if self.m_data.buildingType == BuildingType.MaterialFactory then
        self.buttonScrollView.transform.localScale = Vector3.zero
        self.topName.text = GetLanguage(30020001)
        self:createMaterialInstance()
    elseif self.m_data.buildingType == BuildingType.ProcessingFactory then
        self.buttonScrollView.transform.localScale = Vector3.one
        self.topName.text = GetLanguage(30030001)
        self:createButtonInstance()
    end
end
--Generate category button
function BuildingGoodsTypeCtrl:createButtonInstance()
    for key,value in pairs(GoodsTypeConfig) do
        local obj = self:loadingItemPrefab(self.ButtonTypeItem,self.buttonContent)
        local ButtonTypeItems = ButtonTypeItem:new(value,obj,self.luaBehaviour)
        if not self.ButtonTypeData then
            self.ButtonTypeData = {}
        end
        table.insert(self.ButtonTypeData,ButtonTypeItems)
    end
    self.ButtonTypeData[1].nomal.isOn = true
end
----Set up multiple languages Initialize UI data
--function BuildingGoodsTypeCtrl:_language()
--    self.topName.text = GetLanguage(30020001)
--end
------------------------------------------------------------Click function--------------------------------------------------------------------------------
--close
function BuildingGoodsTypeCtrl:_clickCloseBtn()
    UIPanel.ClosePage()
end
------------------------------------------------------------Event function--------------------------------------------------------------------------------
--Categories
function BuildingGoodsTypeCtrl:goodsType(typeId)
    self:closeDestroy()
    for key,value in pairs(self.m_data.dataInfo) do
        if ToNumber(StringSun(value.itemId,1,4)) == typeId then
            table.insert(self.GoodsTypeInfoData,value)
        end
    end
    self:createGoodsInstance()
end
----------------------------------------------------------------------------------------------------------------------------------------------------
--Generate raw materials (raw materials do not need to be classified)
function BuildingGoodsTypeCtrl:createMaterialInstance()
    for key,value in pairs(self.m_data.dataInfo) do
        local obj = self:loadingItemPrefab(self.GoodsTypeItem,self.contentContent)
        local GoodsTypeItems = GoodsTypeItem:new(value,obj,self.luaBehaviour)
        table.insert(self.GoodsTypeDatas,GoodsTypeItems)
    end
end
--Generate classified products
function BuildingGoodsTypeCtrl:createGoodsInstance()
    for key,value in pairs(self.GoodsTypeInfoData) do
        local obj = self:loadingItemPrefab(self.GoodsTypeItem,self.contentContent)
        local GoodsTypeItems = GoodsTypeItem:new(value,obj,self.luaBehaviour)
        table.insert(self.GoodsTypeDatas,GoodsTypeItems)
    end
end
--Load instantiated Prefab
function BuildingGoodsTypeCtrl:loadingItemPrefab(itemPrefab,itemRoot)
    local obj = UnityEngine.GameObject.Instantiate(itemPrefab)
    local objRect = obj.transform:GetComponent("RectTransform");
    obj.transform:SetParent(itemRoot.transform)
    objRect.transform.localScale = Vector3.one;
    obj:SetActive(true)
    return obj
end
--Clear product classification data and product examples
function BuildingGoodsTypeCtrl:closeDestroy()
    self.GoodsTypeInfoData = {}
    if next(self.GoodsTypeDatas) ~= nil then
        for key,value in pairs(self.GoodsTypeDatas) do
            destroy(value.prefab.gameObject)
            self.GoodsTypeDatas[key] = nil
        end
    end
end