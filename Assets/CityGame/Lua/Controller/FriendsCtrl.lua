---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2018/11/28 11:52
---

FriendsCtrl = class('FriendsCtrl', UIPanel)
UIPanel:ResgisterOpen(FriendsCtrl)

function FriendsCtrl:initialize()
    ct.log("tina_w7_friends", "FriendsCtrl:initialize")
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function FriendsCtrl:bundleName()
    ct.log("tina_w7_friends", "FriendsCtrl:bundleName")
    return "Assets/CityGame/Resources/View/FriendsPanel.prefab"
end

function FriendsCtrl:Awake(go)
    ct.log("tina_w7_friends", "FriendsCtrl:Awake")
    self.friendsSource = UnityEngine.UI.LoopScrollDataSource.New()  --好友
    self.friendsSource.mProvideData = FriendsCtrl.static.FriendsProvideData
    self.friendsSource.mClearData = FriendsCtrl.static.FriendsClearData
end

function FriendsCtrl:OnCreate(go)
    ct.log("tina_w7_friends", "FriendsCtrl:OnCreate")
    --调用基类方法处理实例的数据
    UIPanel.OnCreate(self, go)

    --添加UI事件点击监听
    FriendsCtrl.luaBehaviour = self.gameObject:GetComponent("LuaBehaviour")
    FriendsCtrl.luaBehaviour:AddClick(FriendsPanel.backBtn, function ()
        UIPanel.ClosePage()
    end)

    FriendsCtrl.luaBehaviour:AddClick(FriendsPanel.friendsManageBtn, self.OnFriendsManage, self)
    FriendsCtrl.luaBehaviour:AddClick(FriendsPanel.blacklistBtn, self.OnBlacklist, self)
    FriendsCtrl.luaBehaviour:AddClick(FriendsPanel.addFriendsBtn, self.OnAddFriends, self)
    FriendsCtrl.luaBehaviour:AddClick(FriendsPanel.applicationlistBtn, self.OnApplicationlist, self)

    -- Lua代码挂载C#滑动服用组件LoopVerticalScrollRect、ActiveLoopScrollRect，现在是在预制上，以后可修改为代码添加
    --UnityEngine.GameObject.AddComponent(FriendsPanel.friendsView, LuaHelper.GetType("UnityEngine.UI.LoopVerticalScrollRect"))
    --UnityEngine.GameObject.AddComponent(FriendsPanel.friendsView, LuaHelper.GetType("ActiveLoopScrollRect"))
    --UnityEngine.GameObject.AddComponent(FriendsPanel.groupView, LuaHelper.GetType("UnityEngine.UI.LoopVerticalScrollRect"))
    --UnityEngine.GameObject.AddComponent(FriendsPanel.groupView, LuaHelper.GetType("ActiveLoopScrollRect"))
end

FriendsCtrl.static.FriendsProvideData = function(transform, idx)
    idx = idx + 1
    local item = FriendsItem:new(idx, 1, FriendsCtrl.luaBehaviour, transform, FriendsCtrl.friendInfo[idx])
end

FriendsCtrl.static.FriendsClearData = function(transform)
end

-- 注册监听事件
function FriendsCtrl:Active()
    UIPanel.Active(self)
    self:_addListener()
    FriendsPanel.titleText.text = GetLanguage(12010001)
    FriendsPanel.NoContentText.text = GetLanguage(12010002)
end

-- 刷新
function FriendsCtrl:Refresh()
    self:initInsData()
    --self:_addListener()
    self:_refreshData()
end

function FriendsCtrl:initInsData()
    DataManager.OpenDetailModel(FriendsModel, OpenModelInsID.FriendsCtrl)
end

function FriendsCtrl:_addListener()
    -- 监听Model层网络回调
    Event.AddListener("c_OnReceivePlayerInfo", self.c_OnReceivePlayerInfo, self)
    Event.AddListener("c_OnReceiveAddFriendSucess", self.c_OnReceiveAddFriendSucess, self)
    Event.AddListener("c_OnReceiveAddFriendReq", self.c_OnReceiveAddFriendReq, self)
    Event.AddListener("c_OnReceiveDeleteFriend", self.c_OnReceiveDeleteFriend, self)

    --self:_refreshData()
end

function FriendsCtrl:Hide()
    self:_removeListener()
    UIPanel.Hide(self)
end

function FriendsCtrl:_removeListener()
    -- 监听Model层网络回调
    Event.RemoveListener("c_OnReceivePlayerInfo", self.c_OnReceivePlayerInfo, self)
    Event.RemoveListener("c_OnReceiveAddFriendSucess", self.c_OnReceiveAddFriendSucess, self)
    Event.RemoveListener("c_OnReceiveAddFriendReq", self.c_OnReceiveAddFriendReq, self)
    Event.RemoveListener("c_OnReceiveDeleteFriend", self.c_OnReceiveDeleteFriend, self)
end

-- 获取界面数据
function FriendsCtrl:_refreshData()
    FriendsCtrl.friendInfo = {}
    local friendsBasicData = DataManager.GetMyFriends()
    local friendsId = {}
    for id, v in pairs(friendsBasicData) do
        if v ~= nil then
            table.insert(friendsId, id)
        end
    end
    if friendsId[1] then
        Event.Brocast("m_QueryPlayerInfo", friendsId)
        FriendsPanel.friendsNumberText.text = #friendsId
        FriendsPanel.friendsNoContentRoot:SetActive(false)
        --FriendsPanel.groupNumberText.text = "5"
    else
        FriendsPanel.friendsNumberText.text = "0"
        FriendsPanel.friendsNoContentRoot:SetActive(true)
        --FriendsPanel.groupNumberText.text = "0"
        self:_showFriends()
    end

    self:_refreshState()
end

--显示好友信息
function FriendsCtrl:_showFriends()
    FriendsPanel.friendsView:ActiveLoopScroll(self.friendsSource, #FriendsCtrl.friendInfo)
end

-- 刷新界面的状态
function FriendsCtrl:_refreshState()
    self:_showFriendsApplyNotice()
    --if not FriendsCtrl.type or FriendsCtrl.type == 1 then
    --    FriendsCtrl.type = 1
    --    FriendsPanel.friendsToggle.isOn = true
    --    self:_friendsToggleValueChange(true)
    --elseif FriendsCtrl.type == 2 then
    --    FriendsPanel.groupToggle.isOn = true
    --    self:_groupToggleValueChange(true)
    --end
    --
    --FriendsPanel.groupView:ActiveLoopScroll(self.groupSource, #FriendsCtrl.data[2])
end

-- 收到好友申请
function FriendsCtrl:c_OnReceiveAddFriendReq()
    self:_showFriendsApplyNotice()
end

function FriendsCtrl:c_OnReceiveDeleteFriend(friendsId)
    for i, v in ipairs(FriendsCtrl.friendInfo) do
        if v.id == friendsId.id then
            table.remove(FriendsCtrl.friendInfo, i)
            break
        end
    end
    if #FriendsCtrl.friendInfo <= 0 then
        FriendsPanel.friendsNoContentRoot:SetActive(true)
    end
    FriendsPanel.friendsNumberText.text = tostring(tonumber(#FriendsCtrl.friendInfo))
    self:_showFriends()
end

-- 申请列表红点控制
function FriendsCtrl:_showFriendsApplyNotice()
    local friendsApply = DataManager.GetMyFriendsApply()
    FriendsPanel.applicationlistNotice:SetActive(#friendsApply > 0)
    FriendsPanel.applicationlistNoticeText.text = #friendsApply > 0 and tostring(#friendsApply) or "0"
end

-- 控制好友分页
--function FriendsCtrl:_friendsToggleValueChange(isOn)
--    --FriendsCtrl.type = 1
--    FriendsPanel.friendsRoot:SetActive(isOn)
--    FriendsPanel.groupRoot:SetActive(not isOn)
--    FriendsPanel.friendsOpen:SetActive(isOn)
--    FriendsPanel.friendsClose:SetActive(not isOn)
--    FriendsPanel.groupOpen:SetActive(not isOn)
--    FriendsPanel.groupClose:SetActive(isOn)
--end

-- 控制群组分页
--function FriendsCtrl:_groupToggleValueChange(isOn)
--    --FriendsCtrl.type = 2
--    FriendsPanel.friendsRoot:SetActive(not isOn)
--    FriendsPanel.groupRoot:SetActive(isOn)
--    FriendsPanel.friendsOpen:SetActive(not isOn)
--    FriendsPanel.friendsClose:SetActive(isOn)
--    FriendsPanel.groupOpen:SetActive(isOn)
--    FriendsPanel.groupClose:SetActive(not isOn)
--end

-- 管理好友
function FriendsCtrl:OnFriendsManage(go)
    go:_removeListener()
    local data =
    {
        type = 2,
        --friendsMgr = go.friendsMgr
    }
    ct.OpenCtrl("FriendslistCtrl", data)
end

--打开黑名单
function FriendsCtrl:OnBlacklist(go)
    go:_removeListener()
    local data =
    {
        type = 3,
        --friendsMgr = go.friendsMgr
    }
    ct.OpenCtrl("FriendslistCtrl", data)
end

--添加好友
function FriendsCtrl:OnAddFriends(go)
    go:_removeListener()
    local data =
    {
        type = 4,
        --friendsMgr = go.friendsMgr
    }
    ct.OpenCtrl("FriendslistCtrl", data)
end

--打开申请列表
function FriendsCtrl:OnApplicationlist(go)
    go:_removeListener()
    local data =
    {
        type = 5,
        --friendsMgr = go.friendsMgr
    }
    ct.OpenCtrl("FriendslistCtrl", data)
end

--管理群组
function FriendsCtrl:OnGroupManage(go)
    go:_removeListener()
    FriendsCtrl.type = 2
    local data =
    {
        type = 2,
        --friendsMgr = go.friendsMgr
    }
    ct.OpenCtrl("FriendsGrouplistCtrl", data)
end

--发起群聊
function FriendsCtrl:OnStartGaroup(go)
    go:_removeListener()
    ct.log("tina_w8_friends", "发起群聊")
end

-- 网络回调
function FriendsCtrl:c_OnReceivePlayerInfo(friendsData)
    for _, v in ipairs(friendsData.info) do
        table.insert(FriendsCtrl.friendInfo, v)
    end
    self:_showFriends()
end

function FriendsCtrl:c_OnReceiveAddFriendSucess(friend)
    if FriendsPanel.friendsNoContentRoot.activeSelf then
        FriendsPanel.friendsNoContentRoot:SetActive(false)
    end
    table.insert(FriendsCtrl.friendInfo, friend)
    FriendsPanel.friendsNumberText.text = tostring(tonumber(#FriendsCtrl.friendInfo))
    self:_showFriends()
end