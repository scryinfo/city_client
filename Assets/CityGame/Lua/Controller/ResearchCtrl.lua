---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2019/7/24 15:33
---

ResearchCtrl = class("ResearchCtrl", UIPanel)
ResearchCtrl:ResgisterOpen(ResearchCtrl)

function ResearchCtrl:initialize()
    UIPanel.initialize(self, UIType.PopUp, UIMode.DoNothing, UICollider.None)
end

function ResearchCtrl:bundleName()
    return "Assets/CityGame/Resources/View/ResearchPanel.prefab"
end

function ResearchCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function ResearchCtrl:Awake(go)
    local luaBehaviour = self.gameObject:GetComponent("LuaBehaviour")

    luaBehaviour:AddClick(ResearchPanel.backBtn, self.OnBack, self)
    luaBehaviour:AddClick(ResearchPanel.sureBtn, self.OnSure, self)

    ResearchPanel.inputField.onEndEdit:AddListener(function (inputValue)
        if inputValue == nil or inputValue == "" then
            ResearchPanel.timeText.text = "00:00:00"
            return
        end
        local num = tonumber(inputValue)
        if num <= 0 then
            ResearchPanel.timeText.text = "00:00:00"
            return
        end
        local timeTable = getTimeBySec((1 / self.m_data.speed) * num)
        ResearchPanel.timeText.text = string.format("%s:%s:%s", timeTable.hour, timeTable.minute, timeTable.second)
    end)
end

function ResearchCtrl:Active()
    UIPanel.Active(self)
end

function ResearchCtrl:Refresh()
    self:_updateData()
end

function ResearchCtrl:Hide()
    UIPanel.Hide(self)
end

-- 根据策划的配置表显示要研究的数据
function ResearchCtrl:_updateData()
    LoadSprite(self.m_data.config.iconPath, ResearchPanel.iconImage, false)
    ResearchPanel.nameText.text = self.m_data.config.name
    ResearchPanel.contentText.text = self.m_data.config.content
    ResearchPanel.speedTitleText.text = "Speed:"
    ResearchPanel.speedText.text = 1/self.m_data.speed .. "s/per"
    ResearchPanel.timeText.text = ""
    ResearchPanel.timeTitleText.text = "Estimated time:"
end

-------------------------------------按钮点击事件-------------------------------------
function ResearchCtrl:OnBack(go)
    PlayMusEff(1002)
    UIPanel.ClosePage()
end

function ResearchCtrl:OnSure(go)
    PlayMusEff(1002)
    --输入验证
    local inputValue = ResearchPanel.inputField.text
    if inputValue == nil or inputValue == "" then
        return
    end
    local num = tonumber(inputValue)
    if num <= 0 then
        return
    end

    -- 调用ResearchInstituteModel，向服务器发送研究消息
    DataManager.DetailModelRpcNoRet(go.m_data.buildingId, 'm_ReqAddScienceLine', {id = go.m_data.buildingId, itemId = go.m_data.type, targetNum = num})
    UIPanel.ClosePage()
end