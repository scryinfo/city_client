---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2019/2/27 18:13
---土地交易
MapRightGroundTransPage = class('MapRightGroundTransPage', MapRightPageBase)
MapRightGroundTransPage.moneyColor = "#F4AD07FF"

--初始化方法
function MapRightGroundTransPage:initialize(viewRect)
    self.viewRect = viewRect:GetComponent("RectTransform")

    local trans = viewRect.transform
    self.closeBtn = trans:Find("topRoot/closeBtn"):GetComponent("Button")
    self.goHereBtn = trans:Find("bottomRoot/goHereBtn"):GetComponent("Button")
    self.portraitImg = trans:Find("topRoot/protaitRoot/bg")
    self.nameText = trans:Find("topRoot/nameText"):GetComponent("Text")
    self.companyText = trans:Find("topRoot/companyText"):GetComponent("Text")
    self.typeText = trans:Find("topRoot/bg/Text"):GetComponent("Text")  --显示是出租还是出售

    self.rentRoot = trans:Find("bottomRoot/rent")
    self.rentTime = trans:Find("bottomRoot/rent/showInfoRoot/time")
    self.rental = trans:Find("bottomRoot/rent/showInfoRoot/rental")
    self.sellRoot = trans:Find("bottomRoot/sell")
    self.sellPrice = trans:Find("bottomRoot/sell/showInfoRoot/price")

    self.goHereText01 = trans:Find("bottomRoot/goHereBtn/Text"):GetComponent("Text")

    self.closeBtn.onClick:AddListener(function ()
        self:close()
    end)
    self.goHereBtn.onClick:AddListener(function ()
        self:_goHereBtn()
    end)
end
--
function MapRightGroundTransPage:refreshData(data)
    self.viewRect.anchoredPosition = Vector2.zero
    self.data = data

    local groundInfo = DataManager.GetGroundDataByID(self.data.detailData.blockId).Data
    PlayerInfoManger.GetInfos({[1] = groundInfo.ownerId}, self._initPersonalInfo, self)

    if data.detailData.groundState == GroundTransState.Sell then
        self.sellRoot.localScale = Vector3.one
        self.rentRoot.localScale = Vector3.zero
        self.typeText.text = GetLanguage(22010004)

        if self.sellPriceItem == nil then
            self.sellPriceItem = MapRightShowInfoItem:new(self.sellPrice)
        end
        local str = string.format("<color=%s>E%s</color>", MapRightGroundTransPage.moneyColor, GetClientPriceString(groundInfo.sell.price))
        local data1 = {infoTypeStr = "Price", value = str}  --出售价格
        self.sellPriceItem:initData(data1)
    elseif data.detailData.groundState == GroundTransState.Rent then
        self.rentRoot.localScale = Vector3.one
        self.sellRoot.localScale = Vector3.zero
        self.typeText.text = GetLanguage(22010003)

        if self.rentTimeItem == nil then
            self.rentTimeItem = MapRightShowInfoItem:new(self.rentTime)
        end
        if self.rentalItem == nil then
            self.rentalItem = MapRightShowInfoItem:new(self.rental)
        end
        local str1 = string.format("%d-%d(%s)", groundInfo.rent.rentDaysMin, groundInfo.rent.rentDaysMax, GetLanguage(20150004))
        local data1 = {infoTypeStr = "GroundRentTime", value = str1}  --出租时间
        local str2 = string.format("<color=%s>E%s</color>/%s", MapRightGroundTransPage.moneyColor, GetClientPriceString(groundInfo.rent.rentPreDay), GetLanguage(20150004))
        local data2 = {infoTypeStr = "GroundRental", value = str2}  --租金
        self.rentTimeItem:initData(data1)
        self.rentalItem:initData(data2)
    end
    self:openShow()
end
--重置状态
function MapRightGroundTransPage:openShow()
    self:_language()
    self.viewRect.anchoredPosition = Vector2.zero
end
--多语言
function MapRightGroundTransPage:_language()
    self.goHereText01.text = GetLanguage(20010008)
end
--关闭
function MapRightGroundTransPage:close()
    self.viewRect.anchoredPosition = Vector2.New(506, 0)
    if self.avatar ~= nil then
        AvatarManger.CollectAvatar(self.avatar)
    end
end
--去地图上的一个建筑
function MapRightGroundTransPage:_goHereBtn()
    local blockId = self.data.detailData.blockId
    local tempServerPos = TerrainManager.BlockIDTurnPosition(blockId)
    local temp = {x = tempServerPos.x, y = tempServerPos.z}
    MapBubbleManager.GoHereFunc(temp)

    ct.OpenCtrl("GroundTransDetailCtrl", {blockId = blockId})
end
--
function MapRightGroundTransPage:_initPersonalInfo(info)
    local data = info[1]
    if data ~= nil then
        self.nameText.text = data.name
        self.companyText.text = data.companyName
        self.avatar = AvatarManger.GetSmallAvatar(data.faceId, self.portraitImg.transform,0.2)
        self.data.playerInfo = data
    end
end
--
function MapRightGroundTransPage:_clickPlayerInfoBtn()
    if self.data.playerInfo == nil then
        return
    end
    ct.OpenCtrl("PersonalHomeDialogPageCtrl", self.data.playerInfo)
end