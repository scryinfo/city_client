---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/9/1 14:21
---

GameBubbleElm = {}

function GameBubbleElm.New()
    local elm = {}

    elm.startTimeDown = false  --开始拍卖倒计时
    elm.data = nil  --信息
    elm.infoText = nil  --拍卖状态
    elm.timeText = nil  --倒计时显示

    elm.InitElm = GameBubbleElm.InitElm
    elm.StartBid = GameBubbleElm.StartBid
    elm.Update = GameBubbleElm.Update
    setmetatable(elm, elm)
    return elm
end

--初始化方法
function GameBubbleElm:InitElm(data)
    self.data = data;

    self.infoText = self.data.elmObj.transform:Find("New Text"):GetComponent("TextMesh")
    self.timeText = self.data.elmObj.transform:Find("New Text (1)"):GetComponent("TextMesh")

    if data.bubbleType == BubblleType.GroundAuction then
        --拍卖的气泡
        if data.beginTime > os.time() then
            self.infoText.text = "即将拍卖"
            self.timeText.transform.localScale = Vector3.zero
        else
            self:StartBid()
        end
        UpdateBeat:Add(self.Update, self);

    elseif data.bubbleType == BubblleType.BuildingTransfer then
        --转让的气泡
        self.timeText.transform.localScale = Vector3.zero
        self.infoText.text = "转让中..."
    end
end

--开始拍卖
function GameBubbleElm:StartBid()
    --
    self.infoText.text = "开始拍卖"

    --开始倒计时
    self.startTimeDown = true
    self.data.isStartBid = true
end

--Update
function GameBubbleElm:Update()
    if self.startTimeDown then
        --倒计时
        local finishTime = self.data.beginTime + self.data.durationSec
        self.currentTime = self.currentTime or os.time()
        self.currentTime = self.currentTime + UnityEngine.Time.unscaledDeltaTime

        local remainTime = finishTime - self.currentTime
        if remainTime < 0 then
            self.startTimeDown = false
            self.data.elmObj.transform.localScale = Vector3.zero
            return
        end

        local timeTable = GameBubbleElm.FormatUnixTime(remainTime)
        local timeStr = timeTable.minute..":"..timeTable.second
        self.timeText.text = "拍卖结束倒计时："..timeStr

        if self.currentTime >= finishTime then
            self.startTimeDown = false
            self.data.elmObj.transform.localScale = Vector3.zero
            return
        end
    end

end

--把时间 秒转换成xx时xx分xx秒格式
function GameBubbleElm.FormatUnixTime(time)
    local tb = {}
    tb.year = tonumber(os.date("%Y", time)) or 0;
    tb.month = tonumber(os.date("%m", time)) or 0;
    tb.day = tonumber(os.date("%d", time)) or 0;
    tb.hour = tonumber(os.date("%H", time)) or 0;
    tb.minute = tonumber(os.date("%M", time)) or 0;
    tb.second = tonumber(os.date("%S", time)) or 0;

    return tb
end