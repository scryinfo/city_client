---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/12/24 10:37
---Land details interface
GroundTransState =
{
    None = 0,
    Sell = 1,
    Rent = 2,
    Renting = 3,
}
GroundTransDetailCtrl = class('GroundTransDetailCtrl',UIPanel)
UIPanel:ResgisterOpen(GroundTransDetailCtrl)

function GroundTransDetailCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function GroundTransDetailCtrl:bundleName()
    return "Assets/CityGame/Resources/View/GroundTransDetailPanel.prefab"
end

function GroundTransDetailCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function GroundTransDetailCtrl:Awake(go)
    local groundAuctionBehaviour =  self.gameObject:GetComponent('LuaBehaviour')
    groundAuctionBehaviour:AddClick(GroundTransDetailPanel.bgBtn.gameObject, self._closeBtnFunc, self)
    --groundAuctionBehaviour:AddClick(GroundTransDetailPanel.rentBtnTran.gameObject, self._rentFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransDetailPanel.sellBtnTran.gameObject, self._sellFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransDetailPanel.sellingBtnTran.gameObject, self._sellingFunc, self)
    --groundAuctionBehaviour:AddClick(GroundTransDetailPanel.rentingBtnTran.gameObject, self._rentingFunc, self)
    --groundAuctionBehaviour:AddClick(GroundTransDetailPanel.selfCheckBtnTran.gameObject, self._selfCheckFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransDetailPanel.otherCheckBtnTran.gameObject, self._otherCheckFunc, self)
end

function GroundTransDetailCtrl:Refresh()
    self:_initPanelData()
end

function GroundTransDetailCtrl:Active()
    UIPanel.Active(self)
    GroundTransDetailPanel.titleText01.text = GetLanguage(22010001)
    --GroundTransDetailPanel.averageText02.text = GetLanguage(24010002)
    --GroundTransDetailPanel.buildingText03.text = GetLanguage(24010003)
    --GroundTransDetailPanel.areaText04.text = GetLanguage(22010002)
    GroundTransDetailPanel.rentText05.text = GetLanguage(22010003)
    GroundTransDetailPanel.sellText06.text = GetLanguage(22010004)
    GroundTransDetailPanel.sellingText07.text = GetLanguage(22010006)
    GroundTransDetailPanel.rentingText08.text = GetLanguage(22010005)
    GroundTransDetailPanel.ownerText.text = GetLanguage(18020009)..":"
    GroundTransDetailPanel.prosperityText.text = GetLanguage(20170003)
    Event.AddListener("_saveGroundProsperity",self._saveGroundProsperity,self)
    self.blockData = {}
    self:getBlockData()
end

function GroundTransDetailCtrl:Hide()
    UIPanel.Hide(self)
    self.blockData = {}
    Event.RemoveListener("_saveGroundProsperity",self._saveGroundProsperity,self)
    if self.avatarData then
        AvatarManger.CollectAvatar(self.avatarData)
    end
end

function GroundTransDetailCtrl:Close()
    UIPanel.Close(self)
end
--Get the owner information of the current 1*1 plot
function GroundTransDetailCtrl:getBlockData()
    self.groundInfo = DataManager.GetGroundDataByID(self.m_data.blockId).Data
    local ownerId = {}
    table.insert(ownerId,self.groundInfo.ownerId)
    PlayerInfoManger.GetInfos(ownerId,self._saveData,self)
end
---initialization
function GroundTransDetailCtrl:_initPanelData()
    if self.m_data then
        --local groundInfo = DataManager.GetGroundDataByID(self.m_data.blockId).Data
        if self.groundInfo then
            GroundTransModel.SetGroundBlockId(self.m_data.blockId)  --Set Lot Id
            self.m_data.groundInfo = self.groundInfo
            self:_setShowState(self.m_data.groundInfo)
        end
    end
end
--Display interface according to status
--rent and sell will not appear at the same time
--If there is a sell, it proves that the land is for sale. At this time, the ownerId needs to be judged
--1. If you are yourself, open the GroundTransSetPriceCtrl interface to adjust the price
--2. If you are not yourself, turn on the display of the sellingBtnTran button. After clicking, you can jump to the purchase contract interface
--If there is no ownerId, this land is systematic, showing that it has not been auctioned
--The other states are all rental states without explanation
function GroundTransDetailCtrl:_setShowState(groundInfo)
    GroundTransDetailPanel._closeAllBtnTran()
    if not groundInfo.ownerId then  --Determine if there is an owner
        --Display the label icon, open the attribute interface, showing that it has not been auctioned
        GroundTransDetailPanel.otherCheckBtnTran.localScale = Vector3.one
        return
    end

    --groundState needs to be passed to the next interface to determine whether to open the rental or sale part
    self.groundState = GroundTransState.None
    if groundInfo.rent then
        self.groundState = GroundTransState.Rent
    end
    if groundInfo.sell then
        self.groundState = GroundTransState.Sell
    end

    if groundInfo.ownerId == DataManager.GetMyOwnerID() then  --If you open it yourself
        --Judging status
        local tempPageType
        if self.groundState == GroundTransState.None then
            GroundTransDetailPanel.noneStateTran.localScale = Vector3.one
            return

        elseif self.groundState == GroundTransState.Sell then
            tempPageType = GroundTransState.Sell
            GroundTransDetailPanel.sellingBtnTran.localScale = Vector3.one

        elseif self.groundState == GroundTransState.Rent then
            if groundInfo.rent.renterId then  --Has it been rented out
                GroundTransDetailPanel.selfCheckBtnTran.localScale = Vector3.one
                return
            end

            tempPageType = GroundTransState.Rent
            GroundTransDetailPanel.rentingBtnTran.localScale = Vector3.one
        end
        if self.hasOpened == nil or self.hasOpened == false then
            if tempPageType == nil then
                return
            end
            local info = {groundInfo = groundInfo, groundState = self.groundState, showPageType = tempPageType}
            --Open the interface for setting rent/sale amount, the parameter is info
            ct.OpenCtrl("GroundTransSetPriceCtrl", info)
            self.hasOpened = true
            ct.log("cycle_w19_groundTrans", "打开调整价格界面")
        end

    else
        --Judging status
        if self.groundState == GroundTransState.None then
            --显Display the label icon, open the attribute interface, and display the owner
            GroundTransDetailPanel.otherCheckBtnTran.localScale = Vector3.one

        elseif self.groundState == GroundTransState.Sell then
            --Show selling button
            GroundTransDetailPanel.sellingBtnTran.localScale = Vector3.one

        elseif self.groundState == GroundTransState.Rent then
            if groundInfo.rent.renterId then
                if groundInfo.rent.renterId == DataManager.GetMyOwnerID() then  --If you are the renter
                    --Show viewing status
                    GroundTransDetailPanel.selfCheckBtnTran.localScale = Vector3.one
                else
                    --Display the label icon, open the attribute interface, display renter and owner
                    GroundTransDetailPanel.otherCheckBtnTran.localScale = Vector3.one
                end
            else
                --Show renting button
                 --If you have not rented out, you can click the button to jump to the rental interface
                GroundTransDetailPanel.rentingBtnTran.localScale = Vector3.one
            end
        end
    end
end

---Button method
function GroundTransDetailCtrl:_closeBtnFunc(ins)
    PlayMusEff(1002)
    ins.hasOpened = false
    UIPanel.ClosePage()
end
--owner Rent button
--function GroundTransDetailCtrl:_rentFunc(ins)
--    PlayMusEff(1002)
--    local info = {groundInfo = ins.m_data.groundInfo, groundState = ins.groundState, showPageType = GroundTransState.Rent}
--    --Open the interface for setting rent/sale amount, the parameter is info
--    ct.OpenCtrl("GroundTransSetPriceCtrl", info)
--end
--owner Sale button
function GroundTransDetailCtrl:_sellFunc(ins)
    PlayMusEff(1002)
    --groundState和showPageType值都为GroundTransState Enumeration value, used for the status display of the next interface, no need to re-judge the status
    local info = {groundInfo = ins.m_data.groundInfo, groundState = ins.groundState, showPageType = GroundTransState.Sell,prosperity = ins.blockData[1].prosperity}

    --Open the interface for setting rent/sale amount, the parameter is info
    ct.OpenCtrl("GroundTransSetPriceCtrl", info)
end
--Selling button
function GroundTransDetailCtrl:_sellingFunc(ins)
    PlayMusEff(1002)
    if ins.m_data.groundInfo.ownerId == DataManager.GetMyOwnerID() then
        --Open the interface for adjusting rental and sale prices
        local info = {groundInfo = ins.m_data.groundInfo, groundState = ins.groundState, showPageType = GroundTransState.Sell}
        --Open the interface for setting rent/sale amount, the parameter is info
        ct.OpenCtrl("GroundTransSetPriceCtrl", info)
    else
        --Open the lease purchase interface
        local info = {groundInfo = ins.m_data.groundInfo, groundState = GroundTransState.Sell,prosperity = ins.blockData[1].prosperity}
        ct.OpenCtrl("GroundTransRentAndBuyCtrl", info)
    end
end
--Cache 1*1 land information
function GroundTransDetailCtrl:_saveData(ownerData)
    if self.blockData then
        table.insert(self.blockData,ownerData[1])
    end
    GAucModel.m_ReqQueryOneGoundInfo(self.groundInfo.x,self.groundInfo.y)
end
--Cache 1*1 land prosperity
function GroundTransDetailCtrl:_saveGroundProsperity(data)
    if data then
        self.blockData[1].prosperity = data.num
    end
    --After receiving the data, update the UI owner information plus prosperity
    GroundTransDetailPanel.nameText.text = self.blockData[1].name
    GroundTransDetailPanel.companyText.text = self.blockData[1].companyName
    GroundTransDetailPanel.prosperityValue.text = self.blockData[1].prosperity
    self.avatarData = AvatarManger.GetSmallAvatar(self.blockData[1].faceId,GroundTransDetailPanel.headImg.transform,0.14)
end
--Renting button
--function GroundTransDetailCtrl:_rentingFunc(ins)
--    PlayMusEff(1002)
--    if ins.m_data.groundInfo.ownerId == DataManager.GetMyOwnerID() then
--        --Open the interface for adjusting rental and sale prices
--        local info = {groundInfo = ins.m_data.groundInfo, groundState = ins.groundState, showPageType = GroundTransState.Rent}
--        --Open the interface for setting rent/sale amount, the parameter is info
--        ct.OpenCtrl("GroundTransSetPriceCtrl", info)
--    else
--        --Open the lease purchase interface
--        local info = {groundInfo = ins.m_data.groundInfo, groundState = GroundTransState.Rent}
--        ct.OpenCtrl("GroundTransRentAndBuyCtrl", info)
--    end
--end
--Renter/land owner viewing land
--function GroundTransDetailCtrl:_selfCheckFunc(ins)
--    PlayMusEff(1002)
--    --Open the rental details interface
--    ct.OpenCtrl("GroundTransSelfCheckInfoCtrl", {groundInfo = ins.m_data.groundInfo})
--end
--Others view the land
function GroundTransDetailCtrl:_otherCheckFunc(ins)
    PlayMusEff(1002)
    --Open the attribute interface
    ct.OpenCtrl("GroundTransOthersCheckInfoCtrl", {groundInfo = ins.m_data.groundInfo})
end
