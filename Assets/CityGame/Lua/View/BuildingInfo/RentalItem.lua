---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/9/20 11:00
---
local class = require 'Framework/class'

RentalItem = class('RentalItem')
RentalItem.static.TOTAL_H = 90  --整个Item的高度
RentalItem.static.CONTENT_H = 47  --显示内容的高度
RentalItem.static.TOP_H = 43  --top条的高度

--初始化方法 --数据需要当前租金 & 生效日期（当前天 + 配置表读出来的时间：08:00:00）
function RentalItem:initialize(rentalData, clickOpenFunc, viewRect, mainPanelLuaBehaviour, toggleData, mgrTable)
    self.viewRect = viewRect
    self.rentalData = rentalData
    self.toggleData = toggleData  --位于toggle的第几个，左边还是右边

    self.contentRoot = self.viewRect.transform:Find("contentRoot"):GetComponent("RectTransform");  --内容Rect
    self.openStateTran = self.viewRect.transform:Find("topRoot/open");  --打开状态
    self.closeStateTran = self.viewRect.transform:Find("topRoot/close");  --关闭状态
    self.openBtn = self.viewRect.transform:Find("topRoot/close/openBtn");  --打开按钮
    self.toDoBtn = self.viewRect.transform:Find("topRoot/open/doSthBtn");  --打开之后的执行按钮
    self.rentalValueText = self.viewRect.transform:Find("contentRoot/rentalValueText"):GetComponent("Text");  -- 租金显示的值

    --具体字体大小是否从数据库读取？
    self.rentalValueText.text = self:_getPriceString(rentalData.rent, 14, 10)

    log("cycle_w5","-------- Rental实例化"..self.openBtn.gameObject:GetInstanceID())

    mainPanelLuaBehaviour:AddClick(self.openBtn.gameObject, function()
        clickOpenFunc(mgrTable, self.toggleData)
    end);

    mainPanelLuaBehaviour:AddClick(self.toDoBtn.gameObject, function()
        if not self.viewRect.gameObject.activeSelf then
            return
        end
        --打开更改租金界面

    end);
end

--获取是第几个点击了
function RentalItem:getToggleIndex()
    return self.toggleData.index
end

--打开
function RentalItem:openToggleItem(targetMovePos)
    self.buildingInfoToggleState = BuildingInfoToggleState.Open

    self.rentalValueText = self:_getPriceString(self.rentalData.rent, 14, 10)
    self.openStateTran.localScale = Vector3.one
    self.closeStateTran.localScale = Vector3.zero

    self.contentRoot.sizeDelta = Vector2.New(self.contentRoot.sizeDelta.x, RentalItem.static.CONTENT_H) --打开显示内容
    self.viewRect.anchoredPosition = targetMovePos  --移动到目标位置

    return Vector2.New(targetMovePos.x, targetMovePos.y - RentalItem.static.TOTAL_H)
end

--关闭
function RentalItem:closeToggleItem(targetMovePos)
    self.buildingInfoToggleState = BuildingInfoToggleState.Close

    self.openStateTran.localScale = Vector3.zero
    self.closeStateTran.localScale = Vector3.one

    self.contentRoot.sizeDelta = Vector2.New(self.contentRoot.sizeDelta.x, 0) --关闭显示内容
    self.viewRect.anchoredPosition = targetMovePos  --移动到目标位置

    return Vector2.New(targetMovePos.x, targetMovePos.y - RentalItem.static.TOP_H)
end

--刷新数据
function RentalItem:updateInfo(rent)
    self.rentalData.rent = rent

    if not self.viewRect.gameObject.activeSelf then
        return
    end

    self.rentalValueText = self:_getPriceString(self.rentalData.rent, 14, 10)
end

--获取价格显示文本 --整数和小数部分大小不同
function RentalItem:_getPriceString(str, intSize, floatSize)
    local index = string.find(str, '%.')
    local intString = string.sub(str, 1, index)
    local floatString = string.sub(str, index + 1)
    local finalStr = string.format("<size=%d>%s</size><size=%d>%s</size>", intSize, intString, floatSize, floatString)

    return finalStr
end

