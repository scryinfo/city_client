---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/12/24 15:33
---Land transaction amount
GroundTransSetPriceCtrl = class('GroundTransSetPriceCtrl',UIPanel)
UIPanel:ResgisterOpen(GroundTransSetPriceCtrl)

function GroundTransSetPriceCtrl:initialize()
    UIPanel.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end

function GroundTransSetPriceCtrl:bundleName()
    return "Assets/CityGame/Resources/View/GroundTransSetPricePanel.prefab"
end

function GroundTransSetPriceCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function GroundTransSetPriceCtrl:Awake(go)
    local groundAuctionBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.bgBtn.gameObject, self._closeBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.backBtn.gameObject, self._backBtnFunc, self)
    --groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.rentIssueBtnTran.gameObject, self._rentIssueBtnFunc, self)
    --groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.rentCancelBtnTran.gameObject, self._cancelRentBtnFunc, self)
    --groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.rentChangeBtnTran.gameObject, self._rentChangeBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.sellIssueBtnTran.gameObject, self._sellIssueBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.sellCancelBtnTran.gameObject, self._cancelSellBtnFunc, self)
    groundAuctionBehaviour:AddClick(GroundTransSetPricePanel.sellChangeBtnTran.gameObject, self._sellChangeBtnFunc, self)

    --GroundTransSetPricePanel.minRentDayInput.onValueChanged:AddListener(function(value)
    --    if value == "" then return end
    --    if tonumber(value) < 1 then
    --        GroundTransSetPricePanel.maxRentDayInput.text = "1"
    --    end
    --    --local maxDay = tonumber(GroundTransSetPricePanel.maxRentDayInput.text)
    --    --if tonumber(value) > maxDay then
    --    --    GroundTransSetPricePanel.maxRentDayInput.text = "1"
    --    --end
    --end)
    --GroundTransSetPricePanel.maxRentDayInput.onValueChanged:AddListener(function(value)
    --    if  value == "" then return end
    --    if tonumber(value) > 999 then
    --        GroundTransSetPricePanel.maxRentDayInput.text = "999"
    --    end
    --end)
    GroundTransSetPricePanel.sellInput.onValueChanged:AddListener(function(value)
        local temp = ct.getCorrectPrice(value)
        GroundTransSetPricePanel.sellInput.text = temp
    end)
    --GroundTransSetPricePanel.rentalInput.onValueChanged:AddListener(function(value)
    --    local temp = ct.getCorrectPrice(value)
    --    GroundTransSetPricePanel.rentalInput.text = temp
    --end)
end

function GroundTransSetPriceCtrl:Refresh()
    --Open the set amount interface to get the land transaction pricing first
    GAucModel.m_ReqQueryRecommendPricing()
end

function GroundTransSetPriceCtrl:Active()
    UIPanel.Active(self)
    GroundTransSetPricePanel.sellPriceText01.text = GetLanguage(22030002)
    GroundTransSetPricePanel.priceText.text = GetLanguage(30080004).."(E):"
    GroundTransSetPricePanel.prosperityText.text = GetLanguage(20170003)
    GroundTransSetPricePanel.competitiveness.text = GetLanguage(27060015)
    GroundTransSetPricePanel.adviceTipText.text = "Recommend:<color=#f4ad07>"..50 .."</color>"
    GroundTransSetPricePanel.tipText.text = "Earnings deducted <color=#1E41C3FF>"..0.04 .." %</color> miner`s fee"
    GroundTransSetPricePanel.issueBtnText.text = "发布"
    GroundTransSetPricePanel.cancelText.text = "撤销"
    GroundTransSetPricePanel.changeText.text = "修改"

    Event.AddListener("_saveGroundRecommendPricing",self._saveGroundRecommendPricing,self)
    --GroundTransSetPricePanel.minRentText02.text = GetLanguage(22020002)
    --GroundTransSetPricePanel.maxRentText03.text = GetLanguage(22020003)
    --GroundTransSetPricePanel.rentDayText04.text = GetLanguage(22020004)
end

function GroundTransSetPriceCtrl:Hide()
    UIPanel.Hide(self)
    Event.RemoveListener("_saveGroundRecommendPricing",self._saveGroundRecommendPricing,self)
end

function GroundTransSetPriceCtrl:Close()
    UIPanel.Close(self)
end

---initialization
function GroundTransSetPriceCtrl:_initPanelData()
    GroundTransSetPricePanel.peiceValue.text = GetClientPriceString(self.m_data.groundInfo.auctionPrice / self.m_data.groundInfo.groundNum)
    GroundTransSetPricePanel.prosperityValue.text = self.m_data.prosperity
    if self.m_data and self.m_data.groundInfo then
        self:_setShowState(self.m_data.groundInfo, self.m_data.groundState, self.m_data.showPageType)
    end
end
--Display interface according to status
function GroundTransSetPriceCtrl:_setShowState(groundInfo, groundState, showPageType)
    GroundTransSetPricePanel.cleanData()
    GroundTransSetPricePanel.sellRoot.localScale = Vector3.zero
    --GroundTransSetPricePanel.rentRoot.localScale = Vector3.zero
    GroundTransSetPricePanel.sellChangeStateTran.localScale = Vector3.zero
    GroundTransSetPricePanel.sellIssueBtnTran.localScale = Vector3.zero
    --GroundTransSetPricePanel.rentChangeStateTran.localScale = Vector3.zero
    --GroundTransSetPricePanel.rentIssueBtnTran.localScale = Vector3.zero

    if showPageType == GroundTransState.Rent then
        --GroundTransSetPricePanel.titleText.text = GetLanguage(22020001)
        --GroundTransSetPricePanel.rentRoot.localScale = Vector3.one
        --if groundDisplay set rentState == GroundTransState.None then
        --    --Display set rent
        --    GroundTransSetPricePanel.rentIssueBtnTran.localScale = Vector3.one
        --elseif groundState == GroundTransState.Rent then
        --    --Show modification/cancel status
        --    GroundTransSetPricePanel.rentChangeStateTran.localScale = Vector3.one
        --    GroundTransSetPricePanel.minRentDayInput.text = groundInfo.rent.rentDaysMin
        --    GroundTransSetPricePanel.maxRentDayInput.text = groundInfo.rent.rentDaysMax
        --    GroundTransSetPricePanel.rentalInput.text = GetClientPriceString(groundInfo.rent.rentPreDay)
        --end
    elseif showPageType == GroundTransState.Sell then
        --showPageType is the parameter from the previous interface, used to show whether it is rented or sold, only these two cases
         --groundState is the state judged according to the server value, there are None, Sell and Rent state
         --Below, if the sell field already exists, modify the price or cancel the sale when it is opened again
        GroundTransSetPricePanel.titleText.text = GetLanguage(22030001)
        GroundTransSetPricePanel.sellRoot.localScale = Vector3.one

        if groundState == GroundTransState.None then
            --Display set sale amount
            GroundTransSetPricePanel.sellIssueBtnTran.localScale = Vector3.one
            GroundTransSetPricePanel.sellInput.text = GetClientPriceString(self.guidePrice)
            local temp = ct.CalculationGroundCompetitivePower(self.guidePrice, tonumber(GroundTransSetPricePanel.sellInput.text) * 10000)
            if temp >= functions.maxCompetitive then
                GroundTransSetPricePanel.competitionValue.text = ">"..temp
            elseif temp <= functions.minCompetitive then
                GroundTransSetPricePanel.competitionValue.text = "<"..temp
            else
                GroundTransSetPricePanel.competitionValue.text = string.format("%0.1f", temp)
            end
        elseif groundState == GroundTransState.Sell then
            --Show modification/cancel status
            GroundTransSetPricePanel.sellChangeStateTran.localScale = Vector3.one
            GroundTransSetPricePanel.sellInput.text = GetClientPriceString(groundInfo.sell.price)
        end
    end
end
--Get recommended pricing for land transactions
function GroundTransSetPriceCtrl:_saveGroundRecommendPricing(data)
    if data then
        self.guidePrice = data.num
        --Recommended land pricing
        local tempPrice = self.guidePrice
        GroundTransSetPricePanel.sellInput.text = GetClientPriceString(tempPrice)
        local temp = ct.CalculationGroundCompetitivePower(self.guidePrice, tonumber(GroundTransSetPricePanel.sellInput.text))
        if temp >= functions.maxCompetitive then
            GroundTransSetPricePanel.competitionValue.text = ">"..temp
        elseif temp <= functions.minCompetitive then
            GroundTransSetPricePanel.competitionValue.text = "<"..temp
        else
            GroundTransSetPricePanel.competitionValue.text = string.format("%0.1f", temp)
        end
        self:_awakeSliderInput()
        self:_initPanelData()
    end
end
function GroundTransSetPriceCtrl:_awakeSliderInput()
    GroundTransSetPricePanel.sellInput.onValueChanged:AddListener(function (str)
        if str == "" or str == "." or self.guidePrice == nil then
            return
        end
        local finalStr = ct.getCorrectPrice(str)
        if finalStr ~= str then
            GroundTransSetPricePanel.sellInput.text = finalStr  --Limit user decimal input
            return
        end
        local temp
        temp = ct.CalculationGroundCompetitivePower(self.guidePrice, tonumber(str) * 10000)
        if temp >= functions.maxCompetitive then
            GroundTransSetPricePanel.competitionValue.text = ">"..temp
        elseif temp <= functions.minCompetitive then
            GroundTransSetPricePanel.competitionValue.text = "<"..temp
        else
            GroundTransSetPricePanel.competitionValue.text = string.format("%0.1f", temp)
        end
        GroundTransSetPriceCtrl.sliderCanChange = false
        GroundTransSetPricePanel.competitivenessSlider.value = temp
    end)
    --
    EventTriggerMgr.Get(GroundTransSetPricePanel.competitivenessSlider.gameObject).onSelect = function()
        GroundTransSetPriceCtrl.sliderCanChange = true
    end
    EventTriggerMgr.Get(GroundTransSetPricePanel.competitivenessSlider.gameObject).onUpdateSelected = function()
        GroundTransSetPriceCtrl.sliderCanChange = true
    end
    GroundTransSetPricePanel.competitivenessSlider.onValueChanged:AddListener(function (value)
        if self.guidePrice == nil or GroundTransSetPriceCtrl.sliderCanChange ~= true then
            return
        end
        local price
        price = ct.CalculationGroundPrice(self.guidePrice, value)
        GroundTransSetPricePanel.sellInput.text = GetClientPriceString(price)
    end)
end
---Button method
--Click elsewhere to close the entire stack and open the main interface
function GroundTransSetPriceCtrl:_closeBtnFunc()
    PlayMusEff(1002)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--Back button
function GroundTransSetPriceCtrl:_backBtnFunc()
    PlayMusEff(1002)
    UIPanel:ClosePage()
end

--Sale release button
function GroundTransSetPriceCtrl:_sellIssueBtnFunc(ins)
    PlayMusEff(1002)
    local price = GroundTransSetPricePanel.sellInput.text
    if price ~= "" and tonumber(price) > 0 then
        GroundTransModel.m_ReqSellGround(GetServerPriceNumber(price))
        Event.Brocast("SmallPop", GetLanguage(22030003), 300)

        GroundTransSetPriceCtrl._closeBackToMain()  --Send sellGround agreement to the server and return to the homepage
    else
        Event.Brocast("SmallPop", GetLanguage(22070001), 300)  --Format error message
    end
end
--Edit sale price button
function GroundTransSetPriceCtrl:_sellChangeBtnFunc(ins)
    PlayMusEff(1002)
    local price = GroundTransSetPricePanel.sellInput.text
    if price == "" or tonumber(price) <= 0 then
        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
        return
    end
    if tonumber(price) == tonumber(GetClientPriceString(ins.m_data.groundInfo.sell.price)) then
        Event.Brocast("SmallPop", GetLanguage(22070002), 300)
        return
    end
    GroundTransModel.m_ReqCancelSellGround()  --Edit sale price button
    GroundTransModel.m_ReqSellGround(GetServerPriceNumber(price))
    Event.Brocast("SmallPop", GetLanguage(22030004), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--Cancel sale
function GroundTransSetPriceCtrl:_cancelSellBtnFunc(ins)
    PlayMusEff(1002)
    GroundTransModel.m_ReqCancelSellGround()

    Event.Brocast("SmallPop", GetLanguage(22030005), 300)
    GroundTransSetPriceCtrl._closeBackToMain()
end
--back to main interface
function GroundTransSetPriceCtrl._closeBackToMain()
    UIPanel.CloseAllPageExceptMain()
end

----Rental release button
--function GroundTransSetPriceCtrl:_rentIssueBtnFunc(ins)
--    PlayMusEff(1002)
--    local minDay = GroundTransSetPricePanel.minRentDayInput.text
--    local maxDay = GroundTransSetPricePanel.maxRentDayInput.text
--    local dayRentalPrice = GroundTransSetPricePanel.rentalInput.text
--    if minDay == "" or tonumber(minDay) < 1 or maxDay == "" or tonumber(maxDay) < tonumber(minDay) or dayRentalPrice == "" or tonumber(dayRentalPrice) <= 0 then
--        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
--        return
--    end
--    GroundTransModel.m_ReqRentOutGround(minDay, maxDay, GetServerPriceNumber(dayRentalPrice))
--
--    Event.Brocast("SmallPop", GetLanguage(22020006), 300)
--    GroundTransSetPriceCtrl._closeBackToMain()
--end
----Modify rental price button
--function GroundTransSetPriceCtrl:_rentChangeBtnFunc(ins)
--    PlayMusEff(1002)
--    local minDay = GroundTransSetPricePanel.minRentDayInput.text
--    local maxDay = GroundTransSetPricePanel.maxRentDayInput.text
--    local dayRentalPrice = GroundTransSetPricePanel.rentalInput.text
--    if minDay == "" or tonumber(minDay) < 1 or maxDay == "" or tonumber(maxDay) < tonumber(minDay) or dayRentalPrice == "" or tonumber(dayRentalPrice) <= 0 then
--        Event.Brocast("SmallPop", GetLanguage(22070001), 300)
--        return
--    end
--    if minDay == ins.m_data.groundInfo.rent.rentDaysMin and maxDay == ins.m_data.groundInfo.rent.rentDaysMax and GetServerPriceNumber(dayRentalPrice) == ins.m_data.groundInfo.rent.rentPreDay then
--        Event.Brocast("SmallPop", GetLanguage(22070002), 300)
--        return
--    end
--    GroundTransModel.m_ReqCancelRentGround()
--    GroundTransModel.m_ReqRentOutGround(minDay, maxDay, GetServerPriceNumber(dayRentalPrice))
--    Event.Brocast("SmallPop", GetLanguage(22020007), 300)
--    GroundTransSetPriceCtrl._closeBackToMain()
--end
----Cancel rental
--function GroundTransSetPriceCtrl:_cancelRentBtnFunc(ins)
--    PlayMusEff(1002)
--    GroundTransModel.m_ReqCancelRentGround()
--    Event.Brocast("SmallPop", GetLanguage(22020008), 300)
--    GroundTransSetPriceCtrl._closeBackToMain()
--end
