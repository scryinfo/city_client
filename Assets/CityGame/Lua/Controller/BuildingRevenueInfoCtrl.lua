---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Fisher.
--- DateTime: 2019/7/24 14:39
---Construction operation details

BuildingRevenueInfoCtrl = class('BuildingRevenueInfoCtrl',UIPanel)
UIPanel:ResgisterOpen(BuildingRevenueInfoCtrl)

local typeId  --Used to distinguish the current building type
local index   --Used to record the current line chart index of the management interface
local incomeData    --Used to cache the income of the current open history details
local numberData    --Used to cache the number of currently open history details
local indexs  --Used to record whether the current click on the operation interface is open
local isbool  --Used to record whether a line chart is currently open in the management interface
function BuildingRevenueInfoCtrl:initialize()
    UIPanel.initialize(self,UIType.Normal,UIMode.HideOther,UICollider.None);
end

function BuildingRevenueInfoCtrl:bundleName()
    return "Assets/CityGame/Resources/View/BuildingRevenueInfoPanel.prefab"
end

function BuildingRevenueInfoCtrl:OnCreate(obj)
    UIPanel.OnCreate(self,obj)
end

function BuildingRevenueInfoCtrl:Awake(go)
    self.gameObject = go
    self:_getComponent(go)
    self.luaBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    self.luaBehaviour:AddClick(self.closeBtn.gameObject,self._clickCloseBtn,self)
    self.luaBehaviour:AddClick(self.salesBtn.gameObject,self._clickSalesBtn,self)
    self.luaBehaviour:AddClick(self.salesVolumeBtn.gameObject,self._clickSalesVolumeBtn,self)
end

function BuildingRevenueInfoCtrl:Active()
    UIPanel.Active(self)
    index = nil
    indexs = nil
    isbool = false
    incomeData = {}
    numberData = {}
    self.time = 0.1
    self.timer = Timer.New(slot(self.UpData, self), 0.1, -1, true)
    --Instance table
    self.itemPrefabTab = {}
    self:language()
    Event.AddListener("calculateLinePanel",self.calculateLinePanel,self)
end

function BuildingRevenueInfoCtrl:Refresh()
    if self.m_data then
        self.buildingTs = self.m_data.openingTs
        self.buildingTs = math.floor(self.buildingTs/1000)
        if tonumber(getFormatUnixTime(self.buildingTs).second) ~= 0 then
            self.buildingTs = self.buildingTs - tonumber(getFormatUnixTime(self.buildingTs).second)
        end
        if tonumber(getFormatUnixTime(self.buildingTs).minute) ~= 0 then
            self.buildingTs = self.buildingTs - tonumber(getFormatUnixTime(self.buildingTs).minute) * 60
        end
        if tonumber(getFormatUnixTime(self.buildingTs).hour) ~= 0 then
            self.buildingTs = self.buildingTs - tonumber(getFormatUnixTime(self.buildingTs).hour) * 3600
        end
        self.m_data.insId = OpenModelInsID.BuildingRevenueInfoCtrl
        typeId = string.sub(self.m_data.mId,1,2)
        DataManager.OpenDetailModel(BuildingRevenueInfoModel,self.m_data.insId)
        if self.m_data.buildingType == BuildingType.MaterialFactory then
            --Raw material factory
            self.topMaterialType.transform.localScale = Vector3.one
            self.topGoodsType.transform.localScale = Vector3.zero
            DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqBuildingRevenueInfo',self.m_data.id,typeId)
        elseif self.m_data.buildingType == BuildingType.ProcessingFactory then
            --Processing plant
            self.topMaterialType.transform.localScale = Vector3.zero
            self.topGoodsType.transform.localScale = Vector3.one
            DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqBuildingRevenueInfo',self.m_data.id,typeId)
        elseif self.m_data.buildingType == BuildingType.RetailShop then
            --Retail store
            self.topMaterialType.transform.localScale = Vector3.zero
            self.topGoodsType.transform.localScale = Vector3.one
            DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqBuildingRevenueInfo',self.m_data.id,typeId)
        elseif self.m_data.buildingType == BuildingType.Municipal then
            --Advertising company
            self.topMaterialType.transform.localScale = Vector3.one
            self.topGoodsType.transform.localScale = Vector3.zero
            DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqBuildingRevenueInfo',self.m_data.id,typeId)
        elseif self.m_data.buildingType == BuildingType.Laboratory then
            --graduate School
            self.topMaterialType.transform.localScale = Vector3.one
            self.topGoodsType.transform.localScale = Vector3.zero
            DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqBuildingRevenueInfo',self.m_data.id,typeId)
        end
    end
end

function BuildingRevenueInfoCtrl:Hide()
    UIPanel.Hide(self)
    self.timer:Stop()
    self:CloseDestroy(self.itemPrefabTab)
    self.linePanel.gameObject:SetActive(false)
    Event.RemoveListener("calculateLinePanel",self.calculateLinePanel,self)
end
-------------------------------------------------------------Get components---------------------------------------------------------------------------------
function BuildingRevenueInfoCtrl:_getComponent(go)
    ---TopRoot
    --top
    self.closeBtn = go.transform:Find("topRoot/top/closeBtn")
    self.topName = go.transform:Find("topRoot/top/topName"):GetComponent("Text")
    ---content
    --topMaterialType
    self.topMaterialType = go.transform:Find("content/topMaterialType")
    self.goodsTypeText = go.transform:Find("content/topMaterialType/goodsType/Text"):GetComponent("Text")
    self.todaySalesText = go.transform:Find("content/topMaterialType/todaySales/Text"):GetComponent("Text")
    self.proportionText = go.transform:Find("content/topMaterialType/proportion/Text"):GetComponent("Text")
    --topGoodsType
    self.topGoodsType = go.transform:Find("content/topGoodsType")
    self._goodsTypeText = go.transform:Find("content/topGoodsType/goodsType/Text"):GetComponent("Text")
    self.typeNameText = go.transform:Find("content/topGoodsType/typeName/Text"):GetComponent("Text")
    self._todaySalesText = go.transform:Find("content/topGoodsType/todaySales/Text"):GetComponent("Text")
    self._proportionText = go.transform:Find("content/topGoodsType/proportion/Text"):GetComponent("Text")

    --Content
    self.Content = go.transform:Find("content/ScrollView/Viewport/Content"):GetComponent("RectTransform")
    self.ScrollbarVertical = go.transform:Find("content/ScrollView/ScrollbarVertical"):GetComponent("Scrollbar")
    self.linePanel = go.transform:Find("content/ScrollView/Viewport/Content/linePanel")

    self.salesBtn = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/salesBtn")
    self.selectedSales = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/salesBtn/selectedSales")
    self.salesVolumeBtn = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/salesVolumeBtn")
    self.selectedSalesVolume = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/salesVolumeBtn/selectedSalesVolume")
    self.yScale = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/yScale"):GetComponent("RectTransform")
    self.curve = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/curveBg/curve"):GetComponent("RectTransform")
    self.slide = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/curveBg/curve"):GetComponent("Slide")
    self.graph = go.transform:Find("content/ScrollView/Viewport/Content/linePanel/curveBg/curve"):GetComponent("FunctionalGraph")

    self.tipImg = go.transform:Find("content/tipImg")
    self.tipText = go.transform:Find("content/tipImg/tipText"):GetComponent("Text")

    self.itemMaterialBtn = go.transform:Find("content/ScrollView/Viewport/Content/itemMaterialBtn").gameObject
    self.itemGoodsBtn = go.transform:Find("content/ScrollView/Viewport/Content/itemGoodsBtn").gameObject
end
---------------------------------------------------------------Initialization function------------------------------------------------------------------------------
--Initialize UI information
function BuildingRevenueInfoCtrl:initializeUiInfo()
    if not self.revenueInfo.todaySaleDetail then
        self.tipImg.transform.localScale = Vector3.one
    else
        self.tipImg.transform.localScale = Vector3.zero
        if self.m_data.buildingType == BuildingType.MaterialFactory then
            --Raw material factory
            for key,value in pairs(self.revenueInfo.todaySaleDetail) do
                local obj = self:loadingItemPrefab(self.itemMaterialBtn,self.Content)
                local itemPrefab = itemMaterialBtn:new(value,obj,self.luaBehaviour,key)
                table.insert(self.itemPrefabTab,itemPrefab)
            end
        elseif self.m_data.buildingType == BuildingType.ProcessingFactory then
            --Processing plant
            for key,value in pairs(self.revenueInfo.todaySaleDetail) do
                local obj = self:loadingItemPrefab(self.itemGoodsBtn,self.Content)
                local itemPrefab = itemGoodsBtn:new(value,obj,self.luaBehaviour,key)
                table.insert(self.itemPrefabTab,itemPrefab)
            end
        elseif self.m_data.buildingType == BuildingType.RetailShop then
            --Retail store
            for key,value in pairs(self.revenueInfo.todaySaleDetail) do
                local obj = self:loadingItemPrefab(self.itemGoodsBtn,self.Content)
                local itemPrefab = itemGoodsBtn:new(value,obj,self.luaBehaviour,key)
                table.insert(self.itemPrefabTab,itemPrefab)
            end
        elseif self.m_data.buildingType == BuildingType.Municipal then
            --Advertising company
            for key,value in pairs(self.revenueInfo.todaySaleDetail) do
                local obj = self:loadingItemPrefab(self.itemMaterialBtn,self.Content)
                local itemPrefab = itemMaterialBtn:new(value,obj,self.luaBehaviour,key)
                table.insert(self.itemPrefabTab,itemPrefab)
            end
        elseif self.m_data.buildingType == BuildingType.Laboratory then
            --graduate School
            for key,value in pairs(self.revenueInfo.todaySaleDetail) do
                local obj = self:loadingItemPrefab(self.itemMaterialBtn,self.Content)
                local itemPrefab = itemMaterialBtn:new(value,obj,self.luaBehaviour,key)
                table.insert(self.itemPrefabTab,itemPrefab)
            end
        end
    end
end
--Initialize open panel information
function BuildingRevenueInfoCtrl:initializePanelUiInfo()
    self.selectedSales.transform.localScale = Vector3.one
    self.selectedSalesVolume.transform.localScale = Vector3.zero
    --By default, sales incomeData
    self:DrawBuildingLine(incomeData,1)
    --self:_clickSalesBtn(self)
end
--multi-language
function BuildingRevenueInfoCtrl:language()
    self.tipText.text = "暂无详情"
    self.topName.text = "收入详情"
    self.todaySalesText.text = "今日销售额"
    self._todaySalesText.text = "今日销售额"
    self.proportionText.text = "占昨日销售额比例"
    self._proportionText.text = "占昨日销售额比例"
    --根According to the building, is it raw material or commodity or building name (Institute)
    if self.m_data.buildingType == BuildingType.MaterialFactory then
        self.goodsTypeText.text = "原料"
    elseif self.m_data.buildingType == BuildingType.ProcessingFactory then
        self._goodsTypeText.text = "商品"
        self.typeNameText.text = "品牌"
    elseif self.m_data.buildingType == BuildingType.RetailShop then
        self._goodsTypeText.text = "商品"
        self.typeNameText.text = "品牌"
    elseif self.m_data.buildingType == BuildingType.Municipal then
        self.goodsTypeText.text = "数据类型"
    elseif self.m_data.buildingType == BuildingType.Laboratory then
        self.goodsTypeText.text = "科技资料"
    end
end
-----------------------------------------------------------------------------Callback-------------------------------------------------------------------------
--Successful request for construction operation details
function BuildingRevenueInfoCtrl:revenueInfoData(data)
    if data ~= nil then
        self.revenueInfo = data
        --Initialize UI information
        self:initializeUiInfo()
    end
end
--Successful request for construction history management details
function BuildingRevenueInfoCtrl:historyRevenueInfoData(data)
    if data ~= nil then
        local incomeDatas = {}
        local numberDatas = {}
        if data.historyDetail then
            for key,value in pairs(data.historyDetail) do
                incomeDatas.time = value.time
                numberDatas.time = value.time
                incomeDatas.value = value.saleDetail.income
                numberDatas.value = value.saleDetail.saleNum
                incomeData[key] = ct.deepCopy(incomeDatas)
                numberData[key] = ct.deepCopy(numberDatas)
            end
        end
        numberData.value = self.num
        incomeData.value = self.account
        self:openLinePanel(index)
        if isbool == false then
            return
        end
        if indexs == 1 then
            --self.Content.anchoredPosition = Vector3(0,0,0)
            self.Content:DOLocalMove(Vector2.New(0, 0),0.1):SetEase(DG.Tweening.Ease.Linear)
            self:initializePanelUiInfo()
        else
            self.timer:Start()
        end
    end
end
-----------------------------------------------------------------------------Click function-------------------------------------------------------------------------
--close
function BuildingRevenueInfoCtrl:_clickCloseBtn()
    PlayMusEff(1002)
    UIPanel.ClosePage()
end
--View 7-day sales
function BuildingRevenueInfoCtrl:_clickSalesBtn(ins)
    PlayMusEff(1002)
    ins.selectedSales.transform.localScale = Vector3.one
    ins.selectedSalesVolume.localScale = Vector3.zero
    --Click on the sales pass incomeData
    ins:DrawBuildingLine(incomeData,1)
end
--View 7-day sales
function BuildingRevenueInfoCtrl:_clickSalesVolumeBtn(ins)
    PlayMusEff(1002)
    ins.selectedSales.transform.localScale = Vector3.zero
    ins.selectedSalesVolume.localScale = Vector3.one
    --Click sales to pass numberData
    ins:DrawBuildingLine(numberData,2)
end
-----------------------------------------------------------------------------Event function-------------------------------------------------------------------------
--Calculate location
function BuildingRevenueInfoCtrl:calculateLinePanel(ins)
    index = ins.keyId
    incomeData = {}
    numberData = {}
    --Because the 7-day historical statistical service does not include today's, so cache today's
    self.num = ins.data.num
    self.account = ins.data.saleAccount
    if indexs == index and isbool == true then
        self:openLinePanel(index)
    else
        DataManager.DetailModelRpcNoRet(self.m_data.insId, 'm_ReqBuildingHistoryRevenueInfo',self.m_data.id,tonumber(typeId),ins.data.itemId,ins.data.producerId)
    end
end
-------------------------------------------------------------------------------------------------------------------------------------------------------------
--Open line chart
function BuildingRevenueInfoCtrl:openLinePanel(index)
    if isbool == false then
        indexs = index
        self.linePanel.transform:SetSiblingIndex(index + 2)
        self.linePanel.gameObject:SetActive(true)
        isbool = true
    elseif indexs == index and isbool == true then
        indexs = nil
        self.linePanel.gameObject:SetActive(false)
        self.timer:Stop()
        isbool = false
    elseif indexs ~= index and isbool == true then
        indexs = index
        self.linePanel.transform:SetSiblingIndex(index + 2)
    end
end
function BuildingRevenueInfoCtrl:UpData()
    self.time = self.time - 0.1
    if self.time < 0.1 or self.time < 0 then
        self.time = 0.1
--[[        if indexs == #self.itemPrefabTab then
            --If you click to open the last one, directly pull the position to the end
            --self.ScrollbarVertical.value = 0
            self.Content:DOLocalMove(Vector2.New(0, 132 * (indexs - 1) + (indexs * 5)),0.1):SetEase(DG.Tweening.Ease.Linear)
        else
            --self.Content.anchoredPosition = Vector2.New(0, 132 * (indexs - 1) + (indexs * 5))
            self.Content:DOLocalMove(Vector2.New(0, 132 * (indexs - 1) + (indexs * 5)),0.1):SetEase(DG.Tweening.Ease.Linear)
        end]]
        --No effect temporarily, hide
        --self.Content:DOLocalMove(Vector2.New(0, 132 * (indexs - 1) + (indexs * 5)),0.1):SetEase(DG.Tweening.Ease.Linear)
        self:initializePanelUiInfo()
        self.timer:Stop()
    end
end
--Load instantiated Prefab
function BuildingRevenueInfoCtrl:loadingItemPrefab(itemPrefab,itemRoot)
    local obj = UnityEngine.GameObject.Instantiate(itemPrefab)
    local objRect = obj.transform:GetComponent("RectTransform")
    obj.transform:SetParent(itemRoot.transform)
    objRect.transform.localScale = Vector3.one
    obj:SetActive(true)
    return obj
end
--Clear on close
function BuildingRevenueInfoCtrl:CloseDestroy(dataTable)
    if next(dataTable) == nil then
        return
    else
        for key,valueObj in pairs(dataTable) do
            destroy(valueObj.prefab.gameObject)
            dataTable[key] = nil
        end
    end
end

function BuildingRevenueInfoCtrl:DrawBuildingLine(info,id)
    self.graph:Close()
    self.slide:Close()
    local currentTime = TimeSynchronized.GetTheCurrentTime()    --Current server time (seconds)
    local ts = getFormatUnixTime(currentTime)
    local second = tonumber(ts.second)
    local minute = tonumber(ts.minute)
    local hour = tonumber(ts.hour)
    if second ~= 0 then
        currentTime = currentTime -second
    end
    if minute ~= 0 then
        currentTime = currentTime - minute * 60
    end
    if hour ~= 0 then
        currentTime = currentTime - hour * 3600
    end
    currentTime = math.floor(currentTime)        --At 0 o'clock on the day
    local monthAgo = currentTime - 604800 + 86400     --7 days ago at 0 o'clock
    local updataTime = monthAgo
    local time = {}
    local turnoverTab = {}
    local buildingTs = self.buildingTs
    if buildingTs >= monthAgo then
        updataTime = buildingTs
        for i = 1, 7 do
            time[i] = getFormatUnixTime(updataTime).month .. "." .. getFormatUnixTime(updataTime).day
            if updataTime <= currentTime then
                turnoverTab[i] = {}
                turnoverTab[i].coordinate = (updataTime - buildingTs + 86400) / 86400 * 234
                turnoverTab[i].money = 0
                if info ~= nil then
                    for k, v in pairs(info) do
                        if type(v) == "table" then
                            if updataTime == v.time /1000 then
                                if id == 1 then
                                    turnoverTab[i].money = tonumber(GetClientPriceString(v.value))
                                elseif id == 2 then
                                    turnoverTab[i].money = v.value
                                end
                            end
                        end
                    end
                end
                if updataTime == currentTime then
                    if id == 1 then
                        turnoverTab[i].money = tonumber(GetClientPriceString(info.value))
                    elseif id == 2 then
                        turnoverTab[i].money = info.value
                    end
                end
            end
            updataTime = updataTime + 86400
        end
    else
        for i = 1, 7 do
            time[i] = getFormatUnixTime(updataTime).month .. "." .. getFormatUnixTime(updataTime).day
            turnoverTab[i] = {}
            turnoverTab[i].coordinate = (updataTime - monthAgo + 86400) / 86400 * 234
            turnoverTab[i].money = 0
            if info ~= nil then
                for k, v in pairs(info) do
                    if type(v) == "table" then
                        if updataTime == v.time/1000 then
                            if id == 1 then
                                turnoverTab[i].money = tonumber(GetClientPriceString(v.value))
                            elseif id == 2 then
                                turnoverTab[i].money = v.value
                            end
                        end
                    end
                end
            end
            updataTime = updataTime + 86400
        end
        if id == 1 then
            turnoverTab[#turnoverTab].money = tonumber(GetClientPriceString(info.value))
        elseif id == 2 then
            turnoverTab[#turnoverTab].money = info.value
        end
    end

    --Convert to Vector2 type
    local turnover = {}
    for i, v in pairs(turnoverTab) do
        turnover[i] = Vector2.New(v.coordinate,v.money)
    end
    table.insert(time,1,"0")
    table.insert(turnover,1,Vector2.New(0,0))
    local max = 0
    for i, v in pairs(turnover) do
        if v.y > max then
            max = v.y
        end
    end
    local scale = SetYScale(max,4,self.yScale)
    local turnoverVet = {}
    for i, v in pairs(turnover) do
        if scale == 0 then
            turnoverVet[i] = v
        else
            turnoverVet[i] = Vector2.New(v.x,v.y / scale * 100)
        end
    end

    self.slide:SetXScaleValue(time,234)
    if id == 1 then
        self.graph:DrawLine(turnoverVet,Color.New(243 / 255, 152 / 255, 0 / 255, 255 / 255),1)
        self.slide:SetCoordinate(turnoverVet,turnover,Color.New(243 / 255, 152 / 255, 0 / 255, 255 / 255),1)
    elseif id == 2 then
        self.graph:DrawLine(turnoverVet,Color.New(131 / 255, 165 / 255, 228 / 255, 255 / 255),1)
        self.slide:SetCoordinate(turnoverVet,turnover,Color.New(131 / 255, 165 / 255, 228 / 255, 255 / 255),1)
    end

    self.curve.localPosition = self.curve.localPosition + Vector3.New(0.01, 0,0)
    self.curve.sizeDelta = self.curve.sizeDelta + Vector2.New(0.01, 0)
end
