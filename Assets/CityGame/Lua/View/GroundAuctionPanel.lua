---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/8/31 19:19
---
local transform;
local gameObject;

GroundAuctionPanel = {};
local this = GroundAuctionPanel;

function GroundAuctionPanel.Awake(obj)
    gameObject = obj;
    transform = obj.transform;

    UpdateBeat:Add(this.Update, this);

    this.InitPanel();
    logDebug("Awake lua--->>"..gameObject.name);
end

--Update
function GroundAuctionPanel:Update()
    --如果还没打开过界面
    if not gameObject then
        return
    end

    GroundAuctionPanel.WaitForBidTimeDown()
    GroundAuctionPanel.BidFinishTimeDown()
end

--初始化面板--
function GroundAuctionPanel.InitPanel()
    this.backBtn = transform:Find("backBtn").gameObject;

    this.startBidRoot = transform:Find("bidRoot/startBidRoot").gameObject;
    this.startBidTimeDownText = transform:Find("bidRoot/startBidRoot/time/timeDownText").gameObject:GetComponent("Text");
    this.biderProtaitImg = transform:Find("bidRoot/startBidRoot/price/portait").gameObject:GetComponent("Image");
    this.currentPriceText = transform:Find("bidRoot/startBidRoot/price/currentPriceText").gameObject:GetComponent("Text");
    this.priceDesText = transform:Find("bidRoot/startBidRoot/price/priceDesText").gameObject:GetComponent("Text");  --开始拍卖界面，可能会只显示底价，描述改成“Floor price”
    this.bidInput = transform:Find("bidRoot/startBidRoot/input/bidInput").gameObject:GetComponent('InputField');
    this.bidErrorTipText = transform:Find("bidRoot/startBidRoot/input/errorTipText").gameObject;
    this.bidBtn = transform:Find("bidRoot/startBidRoot/bidBtn").gameObject:GetComponent("Button");

    this.waitBidRoot = transform:Find("bidRoot/waitBidRoot").gameObject;
    this.waitBidTimeDownText = transform:Find("bidRoot/waitBidRoot/time/timeDownText").gameObject:GetComponent("Text");
    this.startBidTimeText = transform:Find("bidRoot/waitBidRoot/time/bidTimeText").gameObject:GetComponent("Text");
    this.waitBidBasePriceText = transform:Find("bidRoot/waitBidRoot/price/basePriceText").gameObject:GetComponent("Text");

    this.personAverageText = transform:Find("personFlowRoot/Image02/averageText").gameObject:GetComponent("Text");


end


--初始化页面信息
function GroundAuctionPanel.InitData(panelData)
    if not panelData then
        return
    end

    this.panelData = panelData
    --如果是已经开始了的，则显示拍卖倒计时界面
    --因为是先获取所有拍卖相关信息之后再点开的UI，所以该有的数据都应该有了
    local timeTemp = os.time()
    if ((panelData.beginTime + panelData.durationSec) > timeTemp and (panelData.isStartBid)) then
        this.startBidRoot.transform.localScale = Vector3.one
        this.waitBidRoot.transform.localScale = Vector3.zero

        if panelData.biderId ~= nil and panelData.price ~= nil then
            this.currentPriceText.text = this._getPriceString(panelData.price, 30, 24)
            this.priceDesText.text = "Top price"
        else
            this.currentPriceText.text = this._getPriceString(panelData.basePrice, 30, 24)
            this.priceDesText.text = "Floor price"
        end

        this.StartTimeDownForFinish = true
    else
        this.startBidRoot.transform.localScale = Vector3.zero
        this.waitBidRoot.transform.localScale = Vector3.one

        this.waitBidBasePriceText.text = this._getPriceString(panelData.basePrice, 30, 24)
        local timeData = GroundAuctionPanel.FormatUnixTime(panelData.beginTime)
        this.startBidTimeText.text = timeData.hour..":"..timeData.minute..":"..timeData.second
        this.StartTimeDownForStart = true
    end

end

--改变为拍卖开始状态--
function GroundAuctionPanel.ChangeToStartBidState(startBidInfo)
    if not gameObject then  --如果还没打开过界面，则不进行任何操作
        return
    end

    if startBidInfo.id ~= this.panelData.id then
        logDebug("当前拍卖土地不是已经打开的土地")
        return
    end

    this.waitBidRoot.transform.localScale = Vector3.zero
    this.startBidRoot.transform.localScale = Vector3.one

    this.currentPriceText.text = startBidInfo.num
    --开始拍卖结束倒计时
    this.StartTimeDownForFinish = true
    end

--界面更新拍卖信息--
function GroundAuctionPanel.ChangeBidInfo(newBidInfo)
    if newBidInfo.id ~= this.panelData.id then
        return
    end

    --头像信息，暂不确定
    this.currentPriceText.text = newBidInfo.num
end

--拍卖结束--
function GroundAuctionPanel.BidEnd()

end

--获取价格显示文本 --整数和小数部分大小不同
function GroundAuctionPanel._getPriceString(str, intSize, floatSize)
    local index = string.find(str, '%.')
    local intString = string.sub(str, 1, index)
    local floatString = string.sub(str, index + 1)
    local finalStr = string.format("<size=%d>%s</size><size=%d>%s</size>", intSize, intString, floatSize, floatString)

    return finalStr
end



---倒计时---
--即将拍卖倒计时
function GroundAuctionPanel.WaitForBidTimeDown()
    if this.StartTimeDownForStart then
        local finishTime = this.panelData.beginTime
        this.currentTime = this.currentTime or os.time()
        this.currentTime = this.currentTime + UnityEngine.Time.unscaledDeltaTime

        local remainTime = finishTime - this.currentTime
        if remainTime < 0 then
            this.StartTimeDownForStart = false
            return
        end

        remainTime = GroundAuctionPanel.FormatUnixTime(remainTime)
        local timeStr = remainTime.hour..":"..remainTime.minute..":"..remainTime.second
        this.waitBidTimeDownText.text = timeStr

        if this.currentTime >= finishTime then
            logDebug("------ 拍卖panel，开始拍卖")
            this.StartTimeDownForStart = false
            return
        end

    end
end

--拍卖结束倒计时
function GroundAuctionPanel.BidFinishTimeDown()
    if this.StartTimeDownForFinish then
        local finishTime = this.panelData.beginTime + this.panelData.durationSec
        this.currentTime = this.currentTime or os.time()
        this.currentTime = this.currentTime + UnityEngine.Time.unscaledDeltaTime

        local remainTime = finishTime - this.currentTime
        if remainTime < 0 then
            this.StartTimeDownForFinish = false
            return
        end

        remainTime = GroundAuctionPanel.FormatUnixTime(remainTime)
        local timeStr = remainTime.hour..":"..remainTime.minute..":"..remainTime.second
        this.startBidTimeDownText.text = timeStr

        if this.currentTime >= finishTime then
            logDebug("------ 拍卖panel，拍卖结束")
            this.StartTimeDownForFinish = false
            return
        end

    end
end

--把时间 秒转换成xx时xx分xx秒格式
function GroundAuctionPanel.FormatUnixTime(time)
    local tb = {}
    tb.year = tonumber(os.date("%Y", time)) or 0
    tb.month = tonumber(os.date("%m", time)) or 0
    tb.day = tonumber(os.date("%d", time)) or 0
    tb.hour = tonumber(os.date("%H", time)) or 0
    tb.minute = tonumber(os.date("%M", time)) or 0
    tb.second = tonumber(os.date("%S", time)) or 0

    return tb
end