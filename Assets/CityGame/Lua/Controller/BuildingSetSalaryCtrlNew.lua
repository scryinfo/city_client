---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/10/4 9:53
---Construction opening set salary -- for 6.6
BuildingSetSalaryCtrlNew = class('BuildingSetSalaryCtrlNew',UIPanel)
UIPanel:ResgisterOpen(BuildingSetSalaryCtrlNew)

function BuildingSetSalaryCtrlNew:initialize()
    UIPanel.initialize(self, UIType.PopUp, UIMode.HideOther, UICollider.Normal)
end

function BuildingSetSalaryCtrlNew:bundleName()
    return "Assets/CityGame/Resources/View/BuildingSetSalaryPanel.prefab"
end

function BuildingSetSalaryCtrlNew:OnCreate(obj )
    UIPanel.OnCreate(self, obj)
end

function BuildingSetSalaryCtrlNew:Awake(go)
    self.gameObject = go
    self:_getComponent(go)

    self.luaBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    self.luaBehaviour:AddClick(self.closeBtn, self._onClickCloseBtn, self)
    self.luaBehaviour:AddClick(self.okBtn, self._onClickConfirm, self)
end

function BuildingSetSalaryCtrlNew:Refresh()
    DataManager.ModelRegisterNetMsg(nil, "gscode.OpCode", "queryIndustryWages", "gs.QueryIndustryWages", self._getStandardWage, self)

    self:_language()
    self:_initData()
end
--
function BuildingSetSalaryCtrlNew:Hide()
    UIPanel.Hide(self)
    DataManager.ModelNoneInsIdRemoveNetMsg("gscode.OpCode", "queryIndustryWages", self)
end
--
function BuildingSetSalaryCtrlNew:_getComponent(go)
    local transform = go.transform
    self.closeBtn = transform:Find("root/closeBtn").gameObject
    self.okBtn = transform:Find("root/okBtn").gameObject
    self.standardWageText = transform:Find("root/salary/wage/standardWageText"):GetComponent("Text")
    self.staffNumText = transform:Find("root/salary/staffNum/staffNumText"):GetComponent("Text")
    self.totalText = transform:Find("root/salary/total/totalText"):GetComponent("Text")

    self.titleText01 = transform:Find("root/titleText01"):GetComponent("Text")
    self.standardWageText02 = transform:Find("root/salary/wage/Text"):GetComponent("Text")
    self.standardWageText03 = transform:Find("root/salary/wage/Text02"):GetComponent("Text")
    self.staffNumText04 = transform:Find("root/salary/staffNum/Text"):GetComponent("Text")
    self.totalText05 = transform:Find("root/salary/total/Text"):GetComponent("Text")
end
--
function BuildingSetSalaryCtrlNew:_language()
    self.titleText01.text = GetLanguage(24020001)
    self.standardWageText02.text = GetLanguage(24020002)
    self.standardWageText03.text = GetLanguage(24020003)
    self.staffNumText04.text = GetLanguage(24020004)..":"
    self.totalText05.text = GetLanguage(24020007)
end
--
function BuildingSetSalaryCtrlNew:_initData()
    if self.m_data == nil then
        return
    end

    local staffNum = PlayerBuildingBaseData[self.m_data.info.mId].maxWorkerNum  --number of workers
    self.staffNum = staffNum
    self.staffNumText.text = staffNum
    local standardWage = DataManager.GetBuildingStandardWage(self.m_data.info.mId)  --Get industry standard salary
    if standardWage == nil then
        DataManager.m_ReqStandardWage(self.m_data.info.mId)
    else
        self.standardWageText.text = string.format("E%s", GetClientPriceString(standardWage))
        --local value = self.m_data.info.salary * staffNum * standardWage / 100
        local value = staffNum * standardWage  --temp modification
        self.totalText.text = "E"..GetClientPriceString(value)
        self.totalValue = value
    end
end
--Industry salary callback
function BuildingSetSalaryCtrlNew:_getStandardWage(data)
    if data.industryWages ~= nil then
        DataManager.SetBuildingStandardWage(data.type, data.industryWages)
        self.standardWageText.text = string.format("E%s", GetClientPriceString(data.industryWages))
        --local value = self.m_data.info.salary * self.staffNum * data.industryWages / 100
        local value = self.staffNum * data.industryWages  --temp modification
        self.totalText.text = "E"..GetClientPriceString(value)
        self.totalValue = value
    end
end
--
function BuildingSetSalaryCtrlNew:_onClickConfirm(ins)
    PlayMusEff(1002)
    if DataManager.GetMoney() < ins.totalValue then
        Event.Brocast("SmallPop", GetLanguage(41010006), 300)  --Determine whether funds are sufficient
        return
    end

    if ins.m_data.callBackFunc ~= nil then
        local temp = os.date("%H:%M", os.time())
        local data = {salary = ins.totalText.text, time = temp, fun = function ()
            ins.m_data.callBackFunc(100)
            UIPanel.ClosePage()
        end}
        ct.OpenCtrl("OpenBuildingCheckCtrl", data)  --Open the second confirmation interface
    end
end
--
function BuildingSetSalaryCtrlNew:_onClickCloseBtn()
    UIPanel.ClosePage()
end