---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/8/31 10:45
---
-----
GroundAuctionModel= {}
local this = GroundAuctionModel
local pbl = pbl

--构建函数--
function GroundAuctionModel.New()
    return this
end

function GroundAuctionModel.Awake()
    UpdateBeat:Add(this.Update, this)
    this:OnCreate()
end

function GroundAuctionModel.Update()
    --if UnityEngine.Input.GetKeyDown(UnityEngine.KeyCode.Space) then
    --    --logDebug("aaaaaaaaaaaa ")
    --    this.m_ReqRueryMetaGroundAuction()
    --    this.m_ReqQueryGroundAuction()
    --end
end

--启动事件--
function GroundAuctionModel.OnCreate()
    --网络回调注册
    CityEngineLua.Message:registerNetMsg(pbl.enum("gscode.OpCode","queryGroundAuction"), GroundAuctionModel.n_OnReceiveQueryGroundAuctionInfo)
    CityEngineLua.Message:registerNetMsg(pbl.enum("gscode.OpCode","bidGround"), GroundAuctionModel.n_OnReceiveBindGround)
    CityEngineLua.Message:registerNetMsg(pbl.enum("gscode.OpCode","queryMetaGroundAuction"), GroundAuctionModel.n_OnReceivequeryMetaGroundAuctionInfo)
    CityEngineLua.Message:registerNetMsg(pbl.enum("gscode.OpCode","bidChangeInform"), GroundAuctionModel.n_OnReceiveBidChangeInfor)
    CityEngineLua.Message:registerNetMsg(pbl.enum("gscode.OpCode","auctionEnd"), GroundAuctionModel.n_OnReceiveAuctionEnd)
    CityEngineLua.Message:registerNetMsg(pbl.enum("gscode.OpCode","metaGroundAuctionAddInform"), GroundAuctionModel.n_OnReceiveAddInform)

    --本地的回调注册
    Event.AddListener("m_RoleLoginReqGroundAuction", this.m_RoleLoginReqGroundAuction)
    Event.AddListener("m_PlayerBidGround", this.m_BidGround)
    Event.AddListener("m_RegistGroundBidInfor", this.m_RegistGroundBidInfor)
    Event.AddListener("m_UnRegistGroundBidInfor", this.m_UnRegistGroundBidInfor)
end

--关闭事件--
function GroundAuctionModel.Close()
    Event.RemoveListener("m_RoleLoginReqGroundAuction", this.m_RoleLoginReqGroundAuction)
    Event.RemoveListener("m_PlayerBidGround", this.m_BidGround)
    Event.RemoveListener("m_RegistGroundBidInfor", this.m_RegistGroundBidInfor)
    Event.RemoveListener("m_UnRegistGroundBidInfor", this.m_UnRegistGroundBidInfor)
end

--角色登录成功之后请求拍卖的信息
function GroundAuctionModel.m_RoleLoginReqGroundAuction()
    this.m_ReqRueryMetaGroundAuction()
    this.m_ReqQueryGroundAuction()
end

--- 客户端请求 ---
--请求即将拍卖的土地信息
function GroundAuctionModel.m_ReqQueryGroundAuction()
    local msgId = pbl.enum("gscode.OpCode","queryGroundAuction")
    CityEngineLua.Bundle:newAndSendMsg(msgId,nil)
end

--请求已经拍卖的土地信息
function GroundAuctionModel.m_ReqRueryMetaGroundAuction()
    local msgId = pbl.enum("gscode.OpCode","queryMetaGroundAuction")
    CityEngineLua.Bundle:newAndSendMsg(msgId,nil)
end

--出价
function GroundAuctionModel.m_BidGround(id, price)
    local msgId = pbl.enum("gscode.OpCode","bidGround")
    local lMsg = { id = id, num = price}
    local  pMsg = assert(pbl.encode("gs.IdNum", lMsg))
    CityEngineLua.Bundle:newAndSendMsg(msgId,pMsg)
end

--打开UI 开始更新拍卖信息 --请判断打开界面的是否处于拍卖中
function GroundAuctionModel.m_RegistGroundBidInfor()
    local msgId = pbl.enum("gscode.OpCode","registGroundBidInform")
    CityEngineLua.Bundle:newAndSendMsg(msgId,nil)
end

--关闭UI
function GroundAuctionModel.m_UnRegistGroundBidInfor()
    local msgId = pbl.enum("gscode.OpCode","unregistGroundBidInform")
    CityEngineLua.Bundle:newAndSendMsg(msgId,nil)
end

--- 回调 ---

--收到拍卖中的土地信息
function GroundAuctionModel.n_OnReceiveQueryGroundAuctionInfo(stream)
    local msgGroundAuc = assert(pbl.decode("gs.GroundAuction", stream), "GroundAuctionModel.n_OnReceiveQueryGroundAuctionInfo: stream == nil")
    if #msgGroundAuc.auction == 0 then
        return
    end

    GameBubbleManager.StartAuc(msgGroundAuc)
    Event.Brocast("c_NewGroundStartBid", msgGroundAuc)
end

--当收到所有拍卖的土地信息
function GroundAuctionModel.n_OnReceivequeryMetaGroundAuctionInfo(stream)
    local auctionInfo = assert(pbl.decode("gs.MetaGroundAuction", stream), "GroundAuctionModel.n_OnReceivequeryMetaGroundAuctionInfo: stream == nil")
    if #auctionInfo.auction == 0 then
        return
    end

    --创建气泡
    for i, v in ipairs(auctionInfo.auction) do
        v.bubbleType = BubblleType.GroundAuction
        v.func = function(info)
            if info.bubbleType ~= BubblleType.GroundAuction then
                return
            end
            --GroundAuctionCtrl.OpenPanel(info)  --打开拍卖界面
            UIPage:ShowPage(GroundAuctionCtrl, info)
        end
        GameBubbleManager.CreatBubble(v)
    end
end

--拍卖出价回调 --出价成功之后会不会有提示信息？
function GroundAuctionModel.n_OnReceiveBindGround(stream)
    local auctionInfo = assert(pbl.decode("gs.MetaGroundAuction", stream), "GroundAuctionModel.n_OnReceiveBindGround: stream == nil")
    if #auctionInfo.auction == 0 then
        return
    end

    --if
end

--收到服务器拍卖信息更新
function GroundAuctionModel.n_OnReceiveBidChangeInfor(stream)
    local bidInfo = assert(pbl.decode("gs.IdNum", stream), "GroundAuctionModel.n_OnReceiveBidChangeInfor: stream == nil")
    Event.Brocast("c_BidInfoUpdate", bidInfo)
end

--拍卖结束
function GroundAuctionModel.n_OnReceiveAuctionEnd(stream)

end

--接到新的meta拍卖信息
function GroundAuctionModel.n_OnReceiveAddInform(stream)
    local addInfo = assert(pbl.decode("gs.MetaGroundAuction", stream), "GroundAuctionModel.n_OnReceiveAddInform: stream == nil")
    if #addInfo.auction == 0 then
        return
    end

    --根据新的整个拍卖meta信息实例化气泡 --需要先清空之前存在的气泡
    --参照GroundAuctionModel.n_OnReceivequeryMetaGroundAuctionInfo
    for i, v in ipairs(addInfo.auction) do
        v.bubbleType = BubblleType.GroundAuction
        v.func = function(info)
            if info.bubbleType ~= BubblleType.GroundAuction then
                return
            end
            --GroundAuctionCtrl.OpenPanel(info)  --打开拍卖界面
            UIPage:ShowPage(GroundAuctionCtrl, info)
        end
        GameBubbleManager.CreatBubble(v)
    end

    --实例化完之后，向服务器请求正在拍卖的土地
    this.m_ReqRueryMetaGroundAuction()
end
