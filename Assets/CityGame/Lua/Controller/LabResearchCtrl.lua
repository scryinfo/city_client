---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2018/11/29 17:38
---
LabResearchCtrl = class('LabResearchCtrl',UIPage)
UIPage:ResgisterOpen(LabResearchCtrl)

LabResearchCtrl.static.EmptyBtnPath = "View/Items/LaboratoryItems/EmptyBtn"  --按钮的预制

function LabResearchCtrl:initialize()
    UIPage.initialize(self, UIType.Normal, UIMode.HideOther, UICollider.None)
end
function LabResearchCtrl:bundleName()
    return "LabResearchPanel"
end
function LabResearchCtrl:OnCreate(obj)
    UIPage.OnCreate(self, obj)
end
function LabResearchCtrl:Awake(go)
    self.gameObject = go
    self.luaBehaviour = self.gameObject:GetComponent('LuaBehaviour')
    self.luaBehaviour:AddClick(LabResearchPanel.backBtn.gameObject, function()
        UIPage.ClosePage()
    end)
    self.luaBehaviour:AddClick(LabResearchPanel.researchBtn.gameObject, function()
        self:_researchBtnFunc()
    end)
    self.luaBehaviour:AddClick(LabResearchPanel.progressSuccessBtn.gameObject, function()
        if self.m_data.buildingId and self.m_data.lineId then
            Event.Brocast("m_ReqLabRoll", self.m_data.buildingId, self.m_data.lineId)
        end
    end)
    UpdateBeat:Add(self._update, self)
end
function LabResearchCtrl:Refresh()
    self:_addListener()
    self:_initPanelData()
end
function LabResearchCtrl:Hide()
    UIPage.Hide(self)
    self._removeListener()
end
function LabResearchCtrl:Close()
    self:_removeListener()
end

function LabResearchCtrl:_addListener()
    Event.AddListener("c_OnReceiveLaboratoryStoreInfo", self._getStoreData, self)  --DBMgr发送过来的store数据
end
function LabResearchCtrl:_removeListener()
    Event.AddListener("c_OnReceiveLaboratoryStoreInfo", self._getStoreData, self)
end

function LabResearchCtrl:_update()
    if self.m_data.bulbState and self.bulbState == LabInventionBulbItemState.Working and self.m_data.leftSec then
        if self.remainTime then
            self.remainTime = self.m_data.leftSec
        else
            self.remainTime = self.remainTime - UnityEngine.Time.unscaledDeltaTime
        end
        LabResearchPanel.progressWorkingImg.fillAmount = self.remainTime / self.m_data.phaseSec  --设置图片进度

        if self.remainTime <= 0 then
            self.bulbState = LabInventionBulbItemState.Finish
            LabResearchPanel:setBulbState(self.bulbState)
            return
        end

        local timeTable = getTimeBySec(self.remainTime)
        local timeStr = timeTable.hour..":"..timeTable.minute..":"..timeTable.second
        LabResearchPanel.timeDownText.text = timeStr
    end
end
--初始化数据
function LabResearchCtrl:_initPanelData()
    --addline/取消addLine的时候只会传一个itemId和buildingId
    self.m_data.type = 0

    --获取商品等级
    local goodLv = DataManager.GetMyGoodLv()
    if not goodLv[self.m_data.itemId] then
        LabResearchPanel.levelText.text = "Lv."..0
    else
        LabResearchPanel.levelText.text = "Lv."..goodLv[self.m_data.itemId]
    end

    --一般的点进来的时候会有正常的数据

    self.bulbState = self.m_data.bulbState
    if not self.bulbState then
        self.bulbState = LabInventionBulbItemState.Empty
    end
    LabResearchPanel:setBulbState(self.bulbState)

    local formularItem = FormularConfig[self.m_data.itemId]
    if formularItem.phase ~= 1 then
        ct.log("cycle_w15_laboratory03", "阶段数不为1")
        return
    end

    Event.Brocast("m_ReqLabStoreInfo", self.m_data.buildingId)  --本地，向DBMgr请求仓库信息
end
--拿到仓库信息
function LabResearchCtrl:_getStoreData(data)
    --获取基础数据
    local itemInfo
    if self.m_data.isMaterial then
        itemInfo = Material[self.data.itemId]
    else
        itemInfo = Good[self.data.itemId]
    end
    LabResearchPanel.itemNameText.text = itemInfo.name
    --LabResearchPanel.iconImg.mainTexture = itemInfo.img
    LabResearchPanel:showLine(formularItem.materials)
end

--点击研究按钮
function LabResearchCtrl:_researchBtnFunc()
    --self.data.bulbState = LabInventionBulbItemState.Locked

    --LabResearchPanel:setBulbState(self.bulbState)  --只是显示出来，并没有开始倒计时
    --LabResearchPanel.researchBtn.localScale = Vector3.zero

    DataManager.DetailModelRpcNoRet(self.m_data.buildingId, 'm_ReqAddLine')
    UIPage.ClosePage()
end