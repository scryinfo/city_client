---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Tina.
--- DateTime: 2019/7/24 15:33
---

ResearchCtrl = class("ResearchCtrl", UIPanel)
ResearchCtrl:ResgisterOpen(ResearchCtrl)

function ResearchCtrl:initialize()
    UIPanel.initialize(self, UIType.PopUp, UIMode.DoNothing, UICollider.None)
end

function ResearchCtrl:bundleName()
    return "Assets/CityGame/Resources/View/ResearchPanel.prefab"
end

function ResearchCtrl:OnCreate(obj)
    UIPanel.OnCreate(self, obj)
end

function ResearchCtrl:Awake(go)
    local luaBehaviour = self.gameObject:GetComponent("LuaBehaviour")

    luaBehaviour:AddClick(ResearchPanel.backBtn, self.OnBack, self)
    luaBehaviour:AddClick(ResearchPanel.sureBtn, self.OnSure, self)

    ResearchPanel.inputField.onEndEdit:AddListener(function (inputValue)
        if inputValue == nil or inputValue == "" then
            ResearchPanel.timeText.text = "00:00:00"
            ResearchPanel.inputField.text = "1"
            return
        end
        local num = tonumber(inputValue)
        if num <= 0 then
            ResearchPanel.timeText.text = "00:00:00"
            ResearchPanel.inputField.text = "1"
            return
        end
        local timeTable = getTimeBySec((1 / self.m_data.speed) * num)
        ResearchPanel.timeText.text = string.format("%s:%s:%s", timeTable.hour, timeTable.minute, timeTable.second)
    end)
end

function ResearchCtrl:Active()
    UIPanel.Active(self)
    ResearchPanel.TitleText.text = GetLanguage(27040005)
    ResearchPanel.quantityText.text = GetLanguage(27040007)
end

function ResearchCtrl:Refresh()
    self:_updateData()
end

function ResearchCtrl:Hide()
    UIPanel.Hide(self)
end

-- Display the data to be studied according to the planned configuration table
function ResearchCtrl:_updateData()
    ResearchPanel.inputField.text = "1"
    LoadSprite(self.m_data.config.iconPath, ResearchPanel.iconImage, false)
    ResearchPanel.nameText.text = GetLanguage(self.m_data.config.name)
    ResearchPanel.contentText.text = GetLanguage(self.m_data.config.content)
    ResearchPanel.speedTitleText.text = GetLanguage(27050005)
    ResearchPanel.speedText.text = GetLanguage(27050006,string.format("%0.2f", 1/self.m_data.speed))
    ResearchPanel.timeText.text = ""
    ResearchPanel.timeTitleText.text = GetLanguage(27050007)
end

-------------------------------------Button click event-------------------------------------
function ResearchCtrl:OnBack(go)
    PlayMusEff(1002)
    UIPanel.ClosePage()
end

function ResearchCtrl:OnSure(go)
    PlayMusEff(1002)
    --Input validation
    local inputValue = ResearchPanel.inputField.text
    if inputValue == nil or inputValue == "" then
        return
    end
    local num = tonumber(inputValue)
    if num <= 0 then
        return
    end

    -- Call ResearchInstituteModel to send research messages to the server
    DataManager.DetailModelRpcNoRet(go.m_data.buildingId, 'm_ReqAddScienceLine', {id = go.m_data.buildingId, itemId = go.m_data.type, targetNum = num})
    UIPanel.ClosePage()
end