---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by xuyafang.
--- DateTime: 2019/2/27 18:13
---Own building
MapRightSelfBuildingPage = class('MapRightSelfBuildingPage', MapRightPageBase)
MapRightSelfBuildingPage.moneyColor = "#F4AD07FF"

--Initialization method
function MapRightSelfBuildingPage:initialize(viewRect)
    self.viewRect = viewRect:GetComponent("RectTransform")
    local tran = self.viewRect.transform

    self.closeBtn = tran:Find("closeBtn"):GetComponent("Button")
    self.goHereBtn = tran:Find("goHereBtn"):GetComponent("Button")
    self.buildingNameText = tran:Find("buildingNameText"):GetComponent("Text")
    self.showRoot = tran:Find("opened/showRoot")
    self.openedTran = tran:Find("opened")
    self.notOpenTran = tran:Find("notOpenTran")
    self.notOpenText01 = tran:Find("notOpenTran/Text"):GetComponent("Text")

    self.closeBtn.onClick:AddListener(function ()
        PlayMusEff(1002)
        self:close()
    end)
    self.goHereBtn.onClick:AddListener(function ()
        PlayMusEff(1002)
        self:_goHereBtn()
    end)
    --
    self.goHereText01 = self.viewRect.transform:Find("goHereBtn/Text"):GetComponent("Text")
    Event.AddListener("c_Revenue", self._updateRevenue, self)  --
end
--Revenue callback
function MapRightSelfBuildingPage:_updateRevenue(income)
    if self.revenueItem == nil then
        return
    end
    local inconme = string.format("<color=%s>E%s</color>/D", MapRightSelfBuildingPage.moneyColor, GetClientPriceString(income))
    self.revenueItem:refreshData(inconme)
end
--
function MapRightSelfBuildingPage:refreshData(data)
    self.viewRect.anchoredPosition = Vector2.zero
    self:_cleanItems()

    local buildingDetail = DataManager.GetSelfBuildingDetailByBlockId(data.buildingId)
    self.data = buildingDetail
    local info = buildingDetail.info
    self.buildingNameText.text = string.format("%s %s%s", info.name, GetLanguage(PlayerBuildingBaseData[info.mId].sizeName), GetLanguage(PlayerBuildingBaseData[info.mId].typeName))
    if info.state == "OPERATE" then  --Judge the opening status
        self.notOpenTran.localScale = Vector3.zero
        self.openedTran.localScale = Vector3.one
        local buildingType = GetBuildingTypeById(info.mId)
        --Request today's revenue
        DataManager.ModelSendNetMes("gscode.OpCode", "getPrivateBuildingCommonInfo","gs.Bytes",{ids = {buildingDetail.info.id}})
        self:_createInfoByType(buildingType)
        self:_sortInfoItems()
    else
        self.notOpenTran.localScale = Vector3.one
        self.openedTran.localScale = Vector3.zero
    end
    self:openShow()
end
--
function MapRightSelfBuildingPage:_sortInfoItems()
    if self.items == nil or #self.items == 0 then
        return
    end
    local pos = Vector3.zero
    for i, item in ipairs(self.items) do
        item:setPos(pos)
        pos.y = pos.y - 66  --66 is the height of item + interval
    end
end
--Display different information according to the type of building, you need to do one by one against the planning case
function MapRightSelfBuildingPage:_createInfoByType(buildingType)
    --Because every building has revenue, I propose it
    --Because revenue needs to be requested from the server, it needs to be created first, display the default value, and refresh after the server callback
    local inconme = string.format("<color=%s>E%s</color>/%s", MapRightSelfBuildingPage.moneyColor, GetClientPriceString(0), GetLanguage(20150004))
    local revenueData = {infoTypeStr = "Revenue", value = inconme}  --Today's revenue
    local revenueItem = self:_createShowItem(revenueData)
    self.items[#self.items + 1] = revenueItem
    self.revenueItem = revenueItem

    --local salaryData = {infoTypeStr = "Salary", value = self.data.info.salary.."%"}  --wage
    --self.items[#self.items + 1] = self:_createShowItem(salaryData)

    if buildingType == BuildingType.House then
        self:_createHouse()
    elseif buildingType == BuildingType.MaterialFactory or buildingType == BuildingType.ProcessingFactory then
        self:_createMaterial()
    elseif buildingType == BuildingType.RetailShop then
        self:_createRetailShop()
    elseif buildingType == BuildingType.Warehouse then
        self:_createWarehouse()
    elseif buildingType == BuildingType.Laboratory then
        self:_createLab()
    elseif buildingType == BuildingType.Municipal then
        self:_createPromotion()
    end
end
--house
function MapRightSelfBuildingPage:_createHouse()
    local occStr = string.format("%d/%d", self.data.renter, PlayerBuildingBaseData[self.data.info.mId].npc)
    local occData = {infoTypeStr = "HouseOccupancy", value = occStr}  --Placement rate
    self.items[#self.items + 1] = self:_createShowItem(occData)

    local rentStr = string.format("<color=%s>E%s</color>/%s", MapRightSelfBuildingPage.moneyColor, GetClientPriceString(self.data.rent), GetLanguage(20150004))
    local rentData = {infoTypeStr = "HouseRent", value = rentStr}  --rent
    self.items[#self.items + 1] = self:_createShowItem(rentData)

    --local data3 = {infoTypeStr = "Sign", value = self:getSignState(self.data.contractInfo)}  --Sign a contract
    --self.items[#self.items + 1] = self:_createShowItem(data3)
end
--Raw material factory
function MapRightSelfBuildingPage:_createMaterial()
    local used = self:_getWarehouseCapacity(self.data.store)
    local str1 = string.format("%d/%d", used, PlayerBuildingBaseData[self.data.info.mId].storeCapacity)
    local data1 = {infoTypeStr = "Warehouse", value = str1}  --Warehouse capacity
    self.items[#self.items + 1] = self:_createShowItem(data1)

    local data3 = {infoTypeStr = "OrderCenter", value = self:getShelfCount(self.data.shelf)}  --Order Center
    self.items[#self.items + 1] = self:_createShowItem(data3)

    if self.data.line == nil then  --production line
        --local str2 = GetLanguage(12345678)
        local str2 = GetLanguage(20060005)
        local data2 = {infoTypeStr = "Production", value = str2}
        self.items[#self.items + 1] = self:_createShowItem(data2)
    else
        local path
        if Material[self.data.line[1].itemId] ~= nil then
            path = Material[self.data.line[1].itemId].img
        else
            path = Good[self.data.line[1].itemId].img
        end
        local detailImgPath = path
        local data2 = {infoTypeStr = "Production", value = GetLanguage(12345678), detailImgPath = detailImgPath}
        self.items[#self.items + 1] = self:_createShowItem(data2, true)
    end
end
--Retail store
function MapRightSelfBuildingPage:_createRetailShop()
    local used = self:_getWarehouseCapacity(self.data.store)
    local str1 = string.format("%d/%d", used, PlayerBuildingBaseData[self.data.info.mId].storeCapacity)
    local data1 = {infoTypeStr = "Warehouse", value = str1}  --Warehouse capacity
    self.items[#self.items + 1] = self:_createShowItem(data1)

    local data2 = {infoTypeStr = "OrderCenter", value = self:getShelfCount(self.data.shelf)}  --Order Center
    self.items[#self.items + 1] = self:_createShowItem(data2)

    --local data3 = {infoTypeStr = "Sign", value = self:getSignState(self.data.contractInfo)}  --Sign a contract
    --self.items[#self.items + 1] = self:_createShowItem(data3)
end
--Research Institute
function MapRightSelfBuildingPage:_createLab()
    --local data3 = {infoTypeStr = "Queued", value = self:getLabQueued(self.data.inProcess).."h"}  --Institute Queue
    --self.items[#self.items + 1] = self:_createShowItem(data3)
    local temp = self.data


end
--warehouse
function MapRightSelfBuildingPage:_createWarehouse()
    --local used = self:_getWarehouseCapacity(self.data.store)
    --local str1 = string.format("%d/%d", used, PlayerBuildingBaseData[self.data.info.mId].storeCapacity)
    --local data1 = {infoTypeStr = "Warehouse", value = str1}  --Warehouse capacity
    --self.items[#self.items + 1] = self:_createShowItem(data1)
    --
    --local data2 = {infoTypeStr = "OrderCenter", value = self:getShelfCount(self.data.shelf)}  --Order Center
    --self.items[#self.items + 1] = self:_createShowItem(data2)

    --local data3 = {infoTypeStr = "WarehouseRent", value = self:getSignState(self.data.contractInfo)}  --Warehouse leasing
    --self.items[#self.items + 1] = self:_createShowItem(data3)
end
--Promotion company
function MapRightSelfBuildingPage:_createPromotion()
    --[[local temp = 0
    if self.data.newPromoStartTs ~= nil and self.data.newPromoStartTs ~= -1 then
        local index = self.data.newPromoStartTs - TimeSynchronized.GetTheCurrentServerTime()  --the remaining time
        if index > 0 then
            local hour = index / 1000 / 3600
            temp = hour
        end
    end
    local data1 = {infoTypeStr = "Queued", value = temp..GetLanguage(20100003)}  --queue
    self.items[#self.items + 1] = self:_createShowItem(data1)
    --]]
    local temp = self.data
    --local data3 = {infoTypeStr = "ADSign", value = self.data.curflowPromoAbTotall.."%"}  --Traffic signing
    --self.items[#self.items + 1] = self:_createShowItem(data3)
end
--Institute Queue
function MapRightSelfBuildingPage:getLabQueued(line)
    local reminderTime = 0
    if line ~= nil then
        for i, lineData in ipairs(line) do
            reminderTime = reminderTime + (lineData.times- (lineData.availableRoll + lineData.usedRoll))
        end
    end
    return reminderTime
end
--Judge the signing status  -- need to add multiple languages
function MapRightSelfBuildingPage:getSignState(contractInfo)
    local str
    if contractInfo.isOpen == false then
        str = "尚未开启签约"
        return str
    end
    if contractInfo.isOpen == true and contractInfo.contract == nil then
        str = "尚未签约"
        return str
    end
    if contractInfo.isOpen == true and contractInfo.contract ~= nil then
        str = "已签约"
        return str
    end
end
--Calculate the total number of shelves
function MapRightSelfBuildingPage:getShelfCount(data)
    local count = 0
    if not data.good then
        count = 0
    else
        for key,value in pairs(data.good) do
            count = count + value.n
        end
    end
    return count
end
--Calculate warehouse capacity
function MapRightSelfBuildingPage:_getWarehouseCapacity(store)
    local warehouseNowCount = 0
    local lockedNowCount = 0
    if store.inHand == nil then
        warehouseNowCount = 0
    else
        for key,value in pairs(store.inHand) do
            warehouseNowCount = warehouseNowCount + value.n
        end
    end
    if store.locked == nil then
        lockedNowCount = 0
    else
        for key,value in pairs(store.locked) do
            lockedNowCount = lockedNowCount + value.n
        end
    end
    return warehouseNowCount + lockedNowCount
end
--create
--data includes two fields, infoTypeStr represents the key in MapBuildingInfoConfig, and value represents the str that needs to be displayed
--hasDetail distinguish prefabricated with and without pictures
--Although the prefabrication is different, a script MapRightShowInfoItem is used
function MapRightSelfBuildingPage:_createShowItem(data, hasDetail)
    local obj
    if hasDetail == true then
        obj = MapPanel.prefabPools[MapPanel.MapShowInfoHasImgPoolName]:GetAvailableGameObject()  --Item with pictures
    else
        obj = MapPanel.prefabPools[MapPanel.MapShowInfoPoolName]:GetAvailableGameObject()  --Premade without pictures
    end
    obj.transform:SetParent(self.showRoot)
    obj.transform.localScale = Vector3.one
    local item = MapRightShowInfoItem:new(obj)
    item:initData(data)
    return item
end
--
function MapRightSelfBuildingPage:_cleanItems()
    if self.items == nil then
        self.items = {}
        return
    end
    for i, item in pairs(self.items) do
        if item:getIsDetail() == true then
            MapPanel.prefabPools[MapPanel.MapShowInfoHasImgPoolName]:RecyclingGameObjectToPool(item.viewRect.gameObject)
        else
            MapPanel.prefabPools[MapPanel.MapShowInfoPoolName]:RecyclingGameObjectToPool(item.viewRect.gameObject)
        end
        item = nil
    end
    self.items = {}
end


--Reset state
function MapRightSelfBuildingPage:openShow()
    self:_language()
    self.viewRect.anchoredPosition = Vector2.zero
end
--multi-language
function MapRightSelfBuildingPage:_language()
    self.goHereText01.text = GetLanguage(20010008)
    self.notOpenText01.text = GetLanguage(20120001)
end
--shut down
function MapRightSelfBuildingPage:close()
    --Event.RemoveListener("c_Revenue", self._updateRevenue, self)
    self.viewRect.anchoredPosition = Vector2.New(506, 0)
    self:_cleanItems()
    self.revenueItem = nil
    self.data = nil
    self = nil
end
--Go to a building on the map
function MapRightSelfBuildingPage:_goHereBtn()
    local pos = self.data.info.pos
    MapBubbleManager.GoHereFunc(pos)
    local blockId = TerrainManager.GridIndexTurnBlockID(pos)
    local tempValue = DataManager.GetBaseBuildDataByID(blockId)
    if tempValue ~= nil then
        tempValue:OpenPanel()
        CameraMove.MoveIntoUILayer(blockId)
    end
end